        // ==UserScript==
        // @name         ash9
        // @namespace    http://tampermonkey.net/
        // @version      9.0.0
        // @description  webclip
        // @author
        // @match        *://*/*
        // @grant        GM_getValue
        // @grant        GM_setValue
        // @grant        GM_addStyle
        // ==/UserScript==

        (function() {
            'use strict';

            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°ç®¡ç†ã®æ”¹å–„
            const Logger = {
                log(message, level = 'info') {
                    const timestamp = new Date().toLocaleTimeString();
                    const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}`;

                    switch (level) {
                        case 'error':
                            console.error(logEntry);
                            break;
                        case 'warn':
                            console.warn(logEntry);
                            break;
                        default:
                            console.log(logEntry);
                    }

                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
                    if (level === 'error') {
                        this.showUserNotification(message, 'error');
                    }
                },

                showUserNotification(message, type = 'info') {
                    // æ—¢å­˜ã®é€šçŸ¥ãŒã‚ã‚Œã°å‰Šé™¤
                    const existingNotification = document.querySelector('.ash8-notification');
                    if (existingNotification) {
                        existingNotification.remove();
                    }

                    const notification = document.createElement('div');
                    notification.className = `ash8-notification ash8-${type}`;
                    notification.textContent = message;
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 10px 15px;
                        border-radius: 5px;
                        color: white;
                        font-family: sans-serif;
                        font-size: 12px;
                        z-index: 20000;
                        max-width: 300px;
                        word-wrap: break-word;
                        animation: slideIn 0.3s ease-out;
                    `;

                    // ã‚¿ã‚¤ãƒ—åˆ¥ã®ã‚¹ã‚¿ã‚¤ãƒ«
                    if (type === 'error') {
                        notification.style.backgroundColor = '#e74c3c';
                    } else if (type === 'warn') {
                        notification.style.backgroundColor = '#f39c12';
                    } else {
                        notification.style.backgroundColor = '#27ae60';
                    }

                    document.body.appendChild(notification);

                    // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.style.animation = 'slideOut 0.3s ease-in';
                            setTimeout(() => notification.remove(), 300);
                        }
                    }, 3000);
                }
            };

            const logMessage = (message, level = 'info') => Logger.log(message, level);
            const getTimestamp = () => new Date().toISOString();
            const getDateString = () => new Date().toISOString().split('T')[0];

            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°
            const safeExecute = (fn, context = null, fallback = null) => {
                try {
                    return fn.call(context);
                } catch (error) {
                    logMessage(`å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    if (fallback && typeof fallback === 'function') {
                        return fallback.call(context, error);
                    }
                    return null;
                }
            };

            const StateManager = {
                // æ°¸ç¶šåŒ–ã•ã‚Œã‚‹çŠ¶æ…‹
                window: null,
                customTabs: new Set(GM_getValue('customTabs', ['ãƒ¡ãƒ¢'])),
                tabColors: new Map(Object.entries(GM_getValue('tabColors', {}))),
                tabThumbnails: new Map(Object.entries(GM_getValue('tabThumbnails', {}))),
                tabDomainNames: new Map(Object.entries(GM_getValue('tabDomainNames', {}))),
                elementSelectors: new Map(Object.entries(GM_getValue('elementSelectors', {}))),

                // ä¸€æ™‚çš„ãªçŠ¶æ…‹
                selectionMode: false,
                videoThumbnailMode: false,
                tagExtractionMode: false,
                compressionRate: 0.7,
                currentCompressedImage: null,
                isDraggingToolbar: false,
                offsetXToolbar: 0,
                offsetYToolbar: 0,
                zIndexCounter: 10000,
                activeMenu: null,
                activePopup: null,
                isHoverEnabled: false,

                // çŠ¶æ…‹å¤‰æ›´ãƒ¡ã‚½ãƒƒãƒ‰
                setWindow(windowObj) {
                    this.window = windowObj;
                    GM_setValue('savedWindow', windowObj ? windowObj.id : null);
                },

                updateCustomTabs(tabs) {
                    this.customTabs = new Set(tabs);
                    GM_setValue('customTabs', [...this.customTabs]);
                },

                setTabColor(tab, color) {
                    this.tabColors.set(tab, color);
                    GM_setValue('tabColors', Object.fromEntries(this.tabColors));
                },

                setTabThumbnail(tab, thumbnail) {
                    this.tabThumbnails.set(tab, thumbnail);
                    GM_setValue('tabThumbnails', Object.fromEntries(this.tabThumbnails));
                },

                setTabDomainName(tab, showDomainName) {
                    this.tabDomainNames.set(tab, showDomainName);
                    GM_setValue('tabDomainNames', Object.fromEntries(this.tabDomainNames));
                },

                setElementSelectors(domain, selectors) {
                    if (selectors) {
                        this.elementSelectors.set(domain, selectors);
                    } else {
                        this.elementSelectors.delete(domain);
                    }
                    GM_setValue('elementSelectors', Object.fromEntries(this.elementSelectors));
                },

                // çŠ¶æ…‹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                validateState() {
                                    if (this.compressionRate < 0 || this.compressionRate > 1) {
                    this.compressionRate = 0.7;
                        logMessage('åœ§ç¸®ç‡ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                    }

                    if (this.zIndexCounter < 10000) {
                        this.zIndexCounter = 10000;
                    }
                },

                // çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ
                resetTemporaryState() {
                    this.selectionMode = false;
                    this.videoThumbnailMode = false;
                    this.tagExtractionMode = false;
                    this.isDraggingToolbar = false;
                    this.activeMenu = null;
                    this.activePopup = null;
                    this.isHoverEnabled = false;
                }
            };

            // ãƒ¡ãƒ¢åŒ–æ©Ÿèƒ½ã®å®Ÿè£…
            const Memoization = {
                cache: new Map(),

                memoize(fn, keyGenerator = null) {
                    return (...args) => {
                        const key = keyGenerator ? keyGenerator(...args) : JSON.stringify(args);

                        if (this.cache.has(key)) {
                            return this.cache.get(key);
                        }

                        const result = fn(...args);
                        this.cache.set(key, result);

                        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºã®åˆ¶é™ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰
                        if (this.cache.size > 100) {
                            const firstKey = this.cache.keys().next().value;
                            this.cache.delete(firstKey);
                        }

                        return result;
                    };
                },

                clearCache() {
                    this.cache.clear();
                }
            };

            const state = new Proxy(StateManager, {
                set(target, prop, value) {
                    const oldValue = target[prop];
                    Reflect.set(target, prop, value);

                    // çŠ¶æ…‹å¤‰æ›´æ™‚ã®å‡¦ç†
                    if (prop === 'currentCompressedImage' && value) {
                        safeExecute(() => {
                            const img = document.getElementById('compressedImage');
                            if (img) img.src = value;
                            if (document.getElementById('autoSaveCheckbox')?.checked) saveImage();
                        });
                    }

                    if (prop === 'window' && value) {
                        safeExecute(() => updateTabs(value));
                    }

                    // çŠ¶æ…‹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (prop === 'compressionRate' || prop === 'zIndexCounter') {
                        target.validateState();
                    }

                    // çŠ¶æ…‹å¤‰æ›´ã®ãƒ­ã‚°
                    if (oldValue !== value) {
                        logMessage(`çŠ¶æ…‹å¤‰æ›´: ${prop} = ${value}`, 'info');
                    }

                    return true;
                },

                get(target, prop) {
                    // çŠ¶æ…‹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (prop === 'compressionRate' || prop === 'zIndexCounter') {
                        target.validateState();
                    }
                    return Reflect.get(target, prop);
                }
            });

            const EventManager = {
                handlers: new WeakMap(),
                delegatedHandlers: new Map(),

                add(element, type, handler, options = {}) {
                    if (!element) return;
                    element.addEventListener(type, handler, options);
                    const handlers = this.handlers.get(element) || [];
                    handlers.push({ type, handler, options });
                    this.handlers.set(element, handlers);
                },

                removeAll(element) {
                    const handlers = this.handlers.get(element) || [];
                    handlers.forEach(({ type, handler, options }) => {
                        element.removeEventListener(type, handler, options);
                    });
                    this.handlers.delete(element);
                },

                // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã®å®Ÿè£…
                delegate(parent, selector, type, handler, options = {}) {
                    const delegatedHandler = (event) => {
                        const target = event.target.closest(selector);
                        if (target && parent.contains(target)) {
                            handler.call(target, event, target);
                        }
                    };

                    parent.addEventListener(type, delegatedHandler, options);

                    // å§”è­²ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨˜éŒ²
                    const key = `${parent.id || 'anonymous'}-${type}-${selector}`;
                    this.delegatedHandlers.set(key, { parent, type, handler: delegatedHandler, options });

                    return key;
                },

                // å§”è­²ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å‰Šé™¤
                removeDelegated(key) {
                    const handler = this.delegatedHandlers.get(key);
                    if (handler) {
                        handler.parent.removeEventListener(handler.type, handler.handler, handler.options);
                        this.delegatedHandlers.delete(key);
                    }
                },

                // è¦ç´ å‰Šé™¤æ™‚ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                cleanupElement(element) {
                    this.removeAll(element);

                    // å§”è­²ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    for (const [key, handler] of this.delegatedHandlers) {
                        if (handler.parent === element) {
                            this.removeDelegated(key);
                        }
                    }
                }
            };
            const events = EventManager;

            const Toolbar = {
                elements: null,
                init() {
                    try {
                        const toolbar = document.createElement('div');
                        toolbar.id = 'toolbar';
                        const fragment = document.createDocumentFragment();

                        const handle = document.createElement('div'); handle.id = 'toolbarHandle';
                        const selectImgBtn = document.createElement('button'); selectImgBtn.id = 'selectImageButton'; selectImgBtn.textContent = 'ğŸ“¸';
                        const selectVidBtn = document.createElement('button'); selectVidBtn.id = 'selectVideoThumbnailButton'; selectVidBtn.textContent = 'ğŸ“¹';
                        const extractTagsBtn = document.createElement('button'); extractTagsBtn.id = 'extractTagsButton'; extractTagsBtn.textContent = 'ğŸ“Œ';
                        const pasteArea = document.createElement('textarea'); pasteArea.id = 'pasteImageArea'; pasteArea.placeholder = 'copy';
                        const compressionDiv = document.createElement('div'); compressionDiv.id = 'compressionButtons';
                        const comp50 = document.createElement('button'); comp50.id = 'compression50'; comp50.textContent = '50';
                        const comp30 = document.createElement('button'); comp30.id = 'compression30'; comp30.textContent = '30';
                        const comp10 = document.createElement('button'); comp10.id = 'compression10'; comp10.textContent = '10';
                        compressionDiv.append(comp50, comp30, comp10);
                        const saveBtn = document.createElement('button'); saveBtn.id = 'saveButton'; saveBtn.textContent = 'ğŸ’¾';
                        const autoSave = document.createElement('input'); autoSave.type = 'checkbox'; autoSave.id = 'autoSaveCheckbox'; autoSave.checked = true; autoSave.title = 'è‡ªå‹•ä¿å­˜';
                        const toggleWinBtn = document.createElement('button'); toggleWinBtn.id = 'toggleWindowButton'; toggleWinBtn.textContent = 'ğŸ–¼ï¸';
                        const compRate = document.createElement('div'); compRate.id = 'compressionRate';
                        const debugOut = document.createElement('div'); debugOut.id = 'debugOutput';
                        const bottomHandle = document.createElement('div'); bottomHandle.id = 'toolbarBottomHandle';

                        fragment.append(handle, selectImgBtn, selectVidBtn, extractTagsBtn, pasteArea, compressionDiv, saveBtn, autoSave, toggleWinBtn, compRate, debugOut, bottomHandle);
                        toolbar.appendChild(fragment);
                        document.body.appendChild(toolbar);

                        this.elements = {
                            toolbar,
                            selectImageButton: toolbar.querySelector('#selectImageButton'),
                            selectVideoThumbnailButton: toolbar.querySelector('#selectVideoThumbnailButton'),
                            extractTagsButton: toolbar.querySelector('#extractTagsButton'),
                            pasteImageArea: toolbar.querySelector('#pasteImageArea'),
                            compressionRateDisplay: toolbar.querySelector('#compressionRate'),
                            debugOutput: toolbar.querySelector('#debugOutput'),
                            saveButton: toolbar.querySelector('#saveButton'),
                            autoSaveCheckbox: toolbar.querySelector('#autoSaveCheckbox'),
                            toggleWindowButton: toolbar.querySelector('#toggleWindowButton'),
                            logButton: toolbar.querySelector('#logButton'),
                            toolbarHandle: toolbar.querySelector('#toolbarHandle'),
                            compression50: toolbar.querySelector('#compression50'),
                            compression30: toolbar.querySelector('#compression30'),
                            compression10: toolbar.querySelector('#compression10'),
                            toolbarBottomHandle: toolbar.querySelector('#toolbarBottomHandle')
                        };

                        logMessage("ãƒ„ãƒ¼ãƒ«ãƒãƒ¼è¿½åŠ æˆåŠŸ");
                        this.setupEventListeners();
                        return this.elements;
                    } catch (e) {
                        logMessage(`ãƒ„ãƒ¼ãƒ«ãƒãƒ¼åˆæœŸåŒ–å¤±æ•—: ${e.message}`);
                        return null;
                    }
                },
                setupEventListeners() {
                    events.add(window, 'load', () => {
                        this.elements.autoSaveCheckbox.checked = true;
                        this.adjustToolbarHeight();
                    });
                    events.add(this.elements.selectImageButton, 'click', () => this.startImageSelectionMode());
                    events.add(this.elements.selectVideoThumbnailButton, 'click', () => this.startVideoThumbnailMode());
                    events.add(this.elements.extractTagsButton, 'click', () => this.startTagExtractionMode());
                    events.add(this.elements.pasteImageArea, 'contextmenu', (e) => this.pasteImageFromClipboard(e));
                    events.add(this.elements.saveButton, 'click', () => saveImage());
                    events.add(this.elements.toggleWindowButton, 'click', () => this.toggleWindow());
                    events.add(this.elements.compression50, 'click', () => this.setCompressionRate(0.5));
                    events.add(this.elements.compression30, 'click', () => this.setCompressionRate(0.3));
                    events.add(this.elements.compression10, 'click', () => this.setCompressionRate(0.1));
                    this.setupDrag();

                    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‹•çš„èª¿æ•´ã‚’å‰Šé™¤

                    logMessage("ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†");
                },
                startImageSelectionMode() {
                    if (state.videoThumbnailMode) { state.videoThumbnailMode = false; this.elements.selectVideoThumbnailButton.textContent = "ğŸ“¹"; this.elements.selectVideoThumbnailButton.classList.remove("active"); events.removeAll(document); }
                    state.selectionMode = true; this.elements.selectImageButton.textContent = "ON"; this.elements.selectImageButton.classList.add("active"); events.add(document, 'click', (e) => this.handleImageClick(e), { capture: true });
                    logMessage("ç”»åƒé¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹");
                },
                handleImageClick(event) {
                    if (!state.selectionMode || event.target.tagName.toLowerCase() !== 'img') return;
                    event.preventDefault(); event.stopPropagation(); state.selectionMode = false; this.elements.selectImageButton.textContent = "ğŸ“¸"; this.elements.selectImageButton.classList.remove("active"); events.removeAll(document);
                    const src = new URL(event.target.src, location.href).href; logMessage(`ç”»åƒé¸æŠ: ${src}`); this.processImage(src);
                },
                startVideoThumbnailMode() {
                    if (state.selectionMode) { state.selectionMode = false; this.elements.selectImageButton.textContent = "ğŸ“¸"; this.elements.selectImageButton.classList.remove("active"); events.removeAll(document); }
                    state.videoThumbnailMode = true; this.elements.selectVideoThumbnailButton.textContent = "å‹•ç”»ã‚’ã‚¯ãƒªãƒƒã‚¯"; this.elements.selectVideoThumbnailButton.classList.add("active"); events.add(document, 'click', (e) => this.handleVideoThumbnailClick(e), { capture: true });

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±: ãƒšãƒ¼ã‚¸å†…ã®å‹•ç”»è¦ç´ ã‚’æ¤œå‡ºã—ã¦ãƒ­ã‚°å‡ºåŠ›
                    this.debugVideoElements();
                },

                debugVideoElements() {
                    try {
                        const allVideos = document.querySelectorAll('video');
                        const allIframes = document.querySelectorAll('iframe');
                        const videoContainers = document.querySelectorAll('[class*="video"], [class*="player"], [class*="media"], [class*="jw"], [id*="video"], [id*="player"], [id*="media"], [id*="jw"], [id*="vplayer"]');

                        logMessage(`å‹•ç”»è¦ç´ æ¤œå‡ºçµæœ: videoè¦ç´ =${allVideos.length}å€‹, iframeè¦ç´ =${allIframes.length}å€‹, å‹•ç”»ã‚³ãƒ³ãƒ†ãƒŠ=${videoContainers.length}å€‹`);

                        // videoè¦ç´ ã®è©³ç´°æƒ…å ±
                        allVideos.forEach((video, index) => {
                            const rect = video.getBoundingClientRect();
                            const isVisible = rect.width > 0 && rect.height > 0;
                            const hasSrc = video.src || video.querySelector('source');
                            const className = video.className || '';
                            const id = video.id || '';
                            const hasJwClass = className.includes('jw');
                            const hasPlayerClass = className.includes('player') || className.includes('video') || className.includes('media');
                            const hasVplayerId = id.includes('vplayer');
                            logMessage(`video[${index}]: visible=${isVisible}, hasSrc=${!!hasSrc}, hasJwClass=${hasJwClass}, hasPlayerClass=${hasPlayerClass}, hasVplayerId=${hasVplayerId}, size=${rect.width}x${rect.height}, className="${className}", id="${id}", src=${video.src || 'sourceè¦ç´ ã‚ã‚Š'}`);
                        });

                        // iframeè¦ç´ ã®è©³ç´°æƒ…å ±
                        allIframes.forEach((iframe, index) => {
                            const rect = iframe.getBoundingClientRect();
                            const isVisible = rect.width > 0 && rect.height > 0;
                            const isVideoRelated = iframe.src && (iframe.src.includes('video') || iframe.src.includes('player') || iframe.src.includes('embed') || iframe.src.includes('jw'));
                            logMessage(`iframe[${index}]: visible=${isVisible}, videoRelated=${isVideoRelated}, size=${rect.width}x${rect.height}, src=${iframe.src}`);
                        });

                        // å‹•ç”»ã‚³ãƒ³ãƒ†ãƒŠã®è©³ç´°æƒ…å ±
                        videoContainers.forEach((container, index) => {
                            const rect = container.getBoundingClientRect();
                            const isVisible = rect.width > 0 && rect.height > 0;
                            const hasVideo = container.querySelector('video');
                            const className = container.className || '';
                            const id = container.id || '';
                            const hasJwClass = className.includes('jw') || id.includes('jw');
                            const hasVplayerId = id.includes('vplayer');
                            logMessage(`container[${index}]: visible=${isVisible}, hasVideo=${!!hasVideo}, hasJwClass=${hasJwClass}, hasVplayerId=${hasVplayerId}, size=${rect.width}x${rect.height}, className="${className}", id="${id}"`);
                        });

                        // ç‰¹å®šã®å‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼è¦ç´ ã‚’æ¤œç´¢
                        const jwElements = document.querySelectorAll('[class*="jw"]');
                        const playerElements = document.querySelectorAll('[class*="player"]');
                        const videoElements = document.querySelectorAll('[class*="video"]');
                        const vplayerElements = document.querySelectorAll('[id*="vplayer"], [class*="vplayer"]');

                        logMessage(`ç‰¹å®šè¦ç´ æ¤œå‡º: jwé–¢é€£=${jwElements.length}å€‹, playeré–¢é€£=${playerElements.length}å€‹, videoé–¢é€£=${videoElements.length}å€‹, vplayeré–¢é€£=${vplayerElements.length}å€‹`);

                        // JW Playeré–¢é€£è¦ç´ ã®è©³ç´°
                        jwElements.forEach((element, index) => {
                            const rect = element.getBoundingClientRect();
                            const isVisible = rect.width > 0 && rect.height > 0;
                            const hasVideo = element.querySelector('video');
                            logMessage(`jw[${index}]: visible=${isVisible}, hasVideo=${!!hasVideo}, tagName=${element.tagName}, className="${element.className}", id="${element.id}"`);
                        });

                        // VPlayeré–¢é€£è¦ç´ ã®è©³ç´°
                        vplayerElements.forEach((element, index) => {
                            const rect = element.getBoundingClientRect();
                            const isVisible = rect.width > 0 && rect.height > 0;
                            const hasVideo = element.querySelector('video');
                            const isVideoElement = element.tagName.toLowerCase() === 'video';
                            logMessage(`vplayer[${index}]: visible=${isVisible}, hasVideo=${!!hasVideo}, isVideoElement=${isVideoElement}, tagName=${element.tagName}, className="${element.className}", id="${element.id}"`);
                        });

                        // ã™ã¹ã¦ã®è¦ç´ ã‚’IDã§æ¤œç´¢ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                        const allElementsWithId = document.querySelectorAll('[id]');
                        const vplayerRelatedElements = Array.from(allElementsWithId).filter(el =>
                            el.id.toLowerCase().includes('vplayer') ||
                            el.id.toLowerCase().includes('player') ||
                            el.id.toLowerCase().includes('video')
                        );

                        logMessage(`IDæ¤œç´¢çµæœ: vplayeré–¢é€£è¦ç´ =${vplayerRelatedElements.length}å€‹`);
                        vplayerRelatedElements.forEach((element, index) => {
                            const rect = element.getBoundingClientRect();
                            const isVisible = rect.width > 0 && rect.height > 0;
                            const hasVideo = element.querySelector('video');
                            const isVideoElement = element.tagName.toLowerCase() === 'video';
                            logMessage(`id-search[${index}]: visible=${isVisible}, hasVideo=${!!hasVideo}, isVideoElement=${isVideoElement}, tagName=${element.tagName}, id="${element.id}", className="${element.className}"`);
                        });

                    } catch (error) {
                        logMessage(`å‹•ç”»è¦ç´ ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    }
                },
                handleVideoThumbnailClick(event) {
                    if (!state.videoThumbnailMode) return;

                    // å‹•ç”»è¦ç´ ã‚’æ¤œç´¢ï¼ˆã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ã¨ãã®è¦ªè¦ç´ ã‹ã‚‰ï¼‰
                    let videoElement = null;
                    let target = event.target;

                    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ãŒå‹•ç”»è¦ç´ ã‹ãƒã‚§ãƒƒã‚¯
                    if (target.tagName.toLowerCase() === 'video') {
                        videoElement = target;
                    } else if (target.tagName.toLowerCase() === 'iframe') {
                        videoElement = target;
                    } else {
                        // ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªå‹•ç”»è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
                        const videoSelectors = [
                            // åŸºæœ¬çš„ãªvideoè¦ç´ 
                            'video',
                            'video[src]',
                            'video source',

                            // ä¸€èˆ¬çš„ãªå‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã‚¯ãƒ©ã‚¹
                            '.jw-video',
                            '.jwplayer video',
                            '.jwplayer',
                            '.video-js video',
                            '.video-js',
                            '.plyr video',
                            '.plyr',
                            '.mejs video',
                            '.mejs',
                            '.flowplayer video',
                            '.flowplayer',
                            '.jw-video-container video',
                            '.jw-video-container',
                            '.jw-video-wrapper video',
                            '.jw-video-wrapper',

                                                    // æ±ç”¨çš„ãªå‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã‚¯ãƒ©ã‚¹
                        '[class*="jw-"] video',
                        '[class*="jw-"]',
                        '[class*="player-"] video',
                        '[class*="player-"]',
                        '[class*="video-"] video',
                        '[class*="video-"]',
                        '[class*="media-"] video',
                        '[class*="media-"]',
                        '[class*="stream-"] video',
                        '[class*="stream-"]',
                        '[class*="live-"] video',
                        '[class*="live-"]',
                        '[class*="vplayer"] video',
                        '[class*="vplayer"]',
                        '[id*="vplayer"] video',
                        '[id*="vplayer"]',

                            // iframeé–¢é€£
                            'iframe[src*="video"]',
                            'iframe[src*="player"]',
                            'iframe[src*="embed"]',
                            'iframe[src*="youtube"]',
                            'iframe[src*="vimeo"]',
                            'iframe[src*="dailymotion"]',
                            'iframe[src*="twitch"]',
                            'iframe[src*="bilibili"]',
                            'iframe[src*="nicovideo"]',
                            'iframe[src*="stream"]',
                            'iframe[src*="live"]',
                            'iframe[src*="jw"]',
                            'iframe[src*="jwplayer"]',

                            // å‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼é–¢é€£
                            '.video-player video',
                            '.player video',
                            '.media-player video',
                            '.video-container video',
                            '.player-container video',
                            '.video-wrapper video',
                            '.player-wrapper video',
                            '.stream-player video',
                            '.live-player video',

                                                    // ã‚¯ãƒ©ã‚¹åãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚ˆã‚ŠåŒ…æ‹¬çš„ï¼‰
                        '[class*="video"] video',
                        '[class*="player"] video',
                        '[class*="media"] video',
                        '[class*="stream"] video',
                        '[class*="live"] video',
                        '[class*="jw"] video',
                        '[class*="jw"]',
                        '[class*="vplayer"] video',
                        '[class*="vplayer"]',

                                                    // ãƒ‡ãƒ¼ã‚¿å±æ€§
                        '[data-video]',
                        '[data-player]',
                        '[data-stream]',
                        '[data-media]',
                        '[data-jw]',
                        '[data-jwplayer]',
                        '[data-vplayer]',

                            // ãã®ä»–ã®å‹•ç”»è¦ç´ 
                            'object[type*="video"]',
                            'embed[type*="video"]',
                            'object[data*="video"]',
                            'embed[src*="video"]',

                                                    // ã‚ˆã‚Šåºƒç¯„å›²ãªæ¤œç´¢
                        '[id*="video"] video',
                        '[id*="player"] video',
                        '[id*="media"] video',
                        '[id*="stream"] video',
                        '[id*="live"] video',
                        '[id*="jw"] video',
                        '[id*="jw"]',
                        '[id*="vplayer"] video',
                        '[id*="vplayer"]',

                                                    // å‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠ
                        '[class*="video-player"]',
                        '[class*="player-container"]',
                        '[class*="media-player"]',
                        '[class*="stream-player"]',
                        '[class*="live-player"]',
                        '[class*="jw-player"]',
                        '[class*="jw-container"]',
                        '[class*="vplayer"]',
                        '[id*="vplayer"]',

                                                    // ã‚ˆã‚Šå…·ä½“çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
                        'div[class*="video"] video',
                        'div[class*="player"] video',
                        'div[class*="media"] video',
                        'div[class*="jw"] video',
                        'div[class*="jw"]',
                        'div[class*="vplayer"] video',
                        'div[class*="vplayer"]',
                        'div[id*="vplayer"] video',
                        'div[id*="vplayer"]',
                        'section[class*="video"] video',
                        'section[class*="player"] video',
                        'section[class*="jw"] video',
                        'section[class*="jw"]',
                        'section[class*="vplayer"] video',
                        'section[class*="vplayer"]',
                        'article[class*="video"] video',
                        'article[class*="player"] video',
                        'article[class*="jw"] video',
                        'article[class*="jw"]',
                        'article[class*="vplayer"] video',
                        'article[class*="vplayer"]',

                                                    // ã•ã‚‰ã«æ±ç”¨çš„ãªæ¤œç´¢
                        'video[class*="jw"]',
                        'video[class*="player"]',
                        'video[class*="video"]',
                        'video[class*="media"]',
                        'video[class*="stream"]',
                        'video[class*="live"]',
                        'video[class*="vplayer"]',
                        'video[id*="vplayer"]',

                            // å±æ€§ãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢
                            'video[src*="blob:"]',
                            'video[src*="data:"]',
                            'video[src*="http"]',
                            'video[src*="https"]',
                            'video[webkit-playsinline]',
                            'video[playsinline]',
                            'video[disableremoteplayback]'
                        ];

                        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ã®è¦ªè¦ç´ ã‹ã‚‰å‹•ç”»è¦ç´ ã‚’æ¤œç´¢
                        let parent = target;
                        let searchDepth = 0;
                        const maxSearchDepth = 15; // æ¤œç´¢æ·±åº¦ã‚’å¢—åŠ 

                        while (parent && parent !== document.body && searchDepth < maxSearchDepth) {
                            // ã¾ãšã€è¦ªè¦ç´ è‡ªä½“ãŒå‹•ç”»è¦ç´ ã‹ãƒã‚§ãƒƒã‚¯
                            if (parent.tagName.toLowerCase() === 'video' || parent.tagName.toLowerCase() === 'iframe') {
                                videoElement = parent;
                                break;
                            }

                            // è¦ªè¦ç´ å†…ã®å‹•ç”»è¦ç´ ã‚’æ¤œç´¢
                            const foundVideo = parent.querySelector(videoSelectors.join(','));
                            if (foundVideo) {
                                videoElement = foundVideo;
                                break;
                            }

                                                    // è¦ªè¦ç´ è‡ªä½“ãŒå‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‹ãƒã‚§ãƒƒã‚¯
                        const parentClasses = parent.className || '';
                        const parentId = parent.id || '';
                        if (parentClasses.includes('video') || parentClasses.includes('player') ||
                            parentClasses.includes('media') || parentClasses.includes('stream') ||
                            parentClasses.includes('jw') || parentClasses.includes('jw-') ||
                            parentClasses.includes('vplayer') ||
                            parentId.includes('video') || parentId.includes('player') ||
                            parentId.includes('media') || parentId.includes('stream') ||
                            parentId.includes('jw') || parentId.includes('vplayer')) {

                            // ã“ã®ã‚³ãƒ³ãƒ†ãƒŠå†…ã®videoè¦ç´ ã‚’æ¤œç´¢
                            const videoInContainer = parent.querySelector('video');
                            if (videoInContainer) {
                                videoElement = videoInContainer;
                                break;
                            }
                        }

                            parent = parent.parentElement;
                            searchDepth++;
                        }

                        // ãƒšãƒ¼ã‚¸å…¨ä½“ã‹ã‚‰å‹•ç”»è¦ç´ ã‚’æ¤œç´¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                        if (!videoElement) {
                            // ã¾ãšvideoè¦ç´ ã‚’æ¤œç´¢
                            const allVideos = document.querySelectorAll('video');
                            if (allVideos.length > 0) {
                                // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã«æœ€ã‚‚è¿‘ã„å‹•ç”»è¦ç´ ã‚’é¸æŠ
                                let closestVideo = null;
                                let minDistance = Infinity;

                                allVideos.forEach(video => {
                                    const rect = video.getBoundingClientRect();
                                    if (rect.width > 0 && rect.height > 0) { // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹è¦ç´ ã®ã¿
                                        const centerX = rect.left + rect.width / 2;
                                        const centerY = rect.top + rect.height / 2;
                                        const distance = Math.sqrt(
                                            Math.pow(event.clientX - centerX, 2) +
                                            Math.pow(event.clientY - centerY, 2)
                                        );

                                        if (distance < minDistance) {
                                            minDistance = distance;
                                            closestVideo = video;
                                        }
                                    }
                                });

                                videoElement = closestVideo;
                            } else {
                                // videoè¦ç´ ãŒãªã„å ´åˆã¯iframeã‚’æ¤œç´¢
                                const allIframes = document.querySelectorAll('iframe[src*="video"], iframe[src*="player"], iframe[src*="embed"], iframe[src*="stream"], iframe[src*="live"]');
                                if (allIframes.length > 0) {
                                    let closestIframe = null;
                                    let minDistance = Infinity;

                                    allIframes.forEach(iframe => {
                                        const rect = iframe.getBoundingClientRect();
                                        if (rect.width > 0 && rect.height > 0) { // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹è¦ç´ ã®ã¿
                                            const centerX = rect.left + rect.width / 2;
                                            const centerY = rect.top + rect.height / 2;
                                            const distance = Math.sqrt(
                                                Math.pow(event.clientX - centerX, 2) +
                                                Math.pow(event.clientY - centerY, 2)
                                            );

                                            if (distance < minDistance) {
                                                minDistance = distance;
                                                closestIframe = iframe;
                                            }
                                        }
                                    });

                                    videoElement = closestIframe;
                                }
                            }
                        }

                                            // ã•ã‚‰ã«åŒ…æ‹¬çš„ãªæ¤œç´¢ï¼ˆå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹å‹•ç”»è¦ç´ ã®ãŸã‚ï¼‰
                    if (!videoElement) {
                        // ç›´æ¥çš„ãªIDæ¤œç´¢ï¼ˆ#vplayerãªã©ï¼‰
                        const directIdSearch = document.getElementById('vplayer');
                        if (directIdSearch) {
                            if (directIdSearch.tagName.toLowerCase() === 'video') {
                                videoElement = directIdSearch;
                            } else {
                                const videoInDirectId = directIdSearch.querySelector('video');
                                if (videoInDirectId) {
                                    videoElement = videoInDirectId;
                                }
                            }
                        }

                        // ã‚ˆã‚Šåºƒç¯„å›²ãªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã§æ¤œç´¢
                        const comprehensiveSelectors = [
                            'video',
                            'video[class*="jw"]',
                            'video[class*="player"]',
                            'video[class*="video"]',
                            'video[class*="media"]',
                            'video[class*="stream"]',
                            'video[class*="live"]',
                            'video[class*="vplayer"]',
                            'video[id*="vplayer"]',
                            'video[src*="blob:"]',
                            'video[src*="data:"]',
                            'video[src*="http"]',
                            'video[src*="https"]',
                            'video[webkit-playsinline]',
                            'video[playsinline]',
                            'video[disableremoteplayback]',
                            'iframe[src*="video"]',
                            'iframe[src*="player"]',
                            'iframe[src*="embed"]',
                            'iframe[src*="stream"]',
                            'iframe[src*="live"]',
                            'iframe[src*="youtube"]',
                            'iframe[src*="vimeo"]',
                            'iframe[src*="twitch"]',
                            'iframe[src*="bilibili"]',
                            'iframe[src*="nicovideo"]',
                            'iframe[src*="dailymotion"]',
                            'iframe[src*="jw"]',
                            'iframe[src*="jwplayer"]',
                            'iframe[src*="vplayer"]',
                            '[class*="jw-"]',
                            '[class*="jw-"] video',
                            '[class*="vplayer"]',
                            '[class*="vplayer"] video',
                            '[class*="video-player"]',
                            '[class*="player-container"]',
                            '[class*="media-player"]',
                            '[class*="stream-player"]',
                            '[class*="live-player"]',
                            '[class*="jw-player"]',
                            '[class*="jw-container"]',
                            '[id*="video-player"]',
                            '[id*="player-container"]',
                            '[id*="media-player"]',
                            '[id*="jw"]',
                            '[id*="jw"] video',
                            '[id*="vplayer"]',
                            '[id*="vplayer"] video',
                            '[data-video]',
                            '[data-player]',
                            '[data-stream]',
                            '[data-media]',
                            '[data-jw]',
                            '[data-jwplayer]',
                            '[data-vplayer]'
                        ];

                            const allPossibleElements = document.querySelectorAll(comprehensiveSelectors.join(','));
                            if (allPossibleElements.length > 0) {
                                let closestElement = null;
                                let minDistance = Infinity;

                                allPossibleElements.forEach(element => {
                                    const rect = element.getBoundingClientRect();
                                    if (rect.width > 0 && rect.height > 0) {
                                        const centerX = rect.left + rect.width / 2;
                                        const centerY = rect.top + rect.height / 2;
                                        const distance = Math.sqrt(
                                            Math.pow(event.clientX - centerX, 2) +
                                            Math.pow(event.clientY - centerY, 2)
                                        );

                                        if (distance < minDistance) {
                                            minDistance = distance;
                                            closestElement = element;
                                        }
                                    }
                                });

                                if (closestElement) {
                                    // è¦ç´ ãŒvideoè¦ç´ ã§ãªã„å ´åˆã¯ã€ãã®ä¸­ã«videoè¦ç´ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                                    if (closestElement.tagName.toLowerCase() === 'video') {
                                        videoElement = closestElement;
                                    } else {
                                        const videoInElement = closestElement.querySelector('video');
                                        if (videoInElement) {
                                            videoElement = videoInElement;
                                        } else if (closestElement.tagName.toLowerCase() === 'iframe') {
                                            videoElement = closestElement;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if (!videoElement) {
                        logMessage('å‹•ç”»è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                        return;
                    }

                    event.preventDefault();
                    event.stopPropagation();
                    state.videoThumbnailMode = false;
                    this.elements.selectVideoThumbnailButton.textContent = "ğŸ“¹";
                    this.elements.selectVideoThumbnailButton.classList.remove("active");
                    events.removeAll(document);

                    // å‹•ç”»ã®ç¨®é¡ã«å¿œã˜ã¦ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—
                    if (videoElement.tagName.toLowerCase() === 'video') {
                        this.captureVideoThumbnail(videoElement);
                    } else if (videoElement.tagName.toLowerCase() === 'iframe') {
                        this.captureIframeThumbnail(videoElement);
                    } else {
                        logMessage('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å‹•ç”»è¦ç´ ã§ã™');
                    }
                },

                captureVideoThumbnail(videoElement) {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = videoElement.videoWidth || 640;
                        canvas.height = videoElement.videoHeight || 360;
                        const ctx = canvas.getContext('2d');

                        // å‹•ç”»ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (videoElement.readyState >= 2) {
                            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                            const thumbnailDataURL = canvas.toDataURL('image/jpeg', state.compressionRate);
                            logMessage(`ã‚µãƒ ãƒã‚¤ãƒ«ã‚­ãƒ£ãƒ—ãƒãƒ£å®Œäº†: ${canvas.width}x${canvas.height}`);
                            this.processImage(thumbnailDataURL, true);
                        } else {
                            // å‹•ç”»ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯å¾…æ©Ÿ
                            const checkReadyState = () => {
                                if (videoElement.readyState >= 2) {
                                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                                    const thumbnailDataURL = canvas.toDataURL('image/jpeg', state.compressionRate);
                                    logMessage(`ã‚µãƒ ãƒã‚¤ãƒ«ã‚­ãƒ£ãƒ—ãƒãƒ£å®Œäº†: ${canvas.width}x${canvas.height}`);
                                    this.processImage(thumbnailDataURL, true);
                                } else {
                                    setTimeout(checkReadyState, 100);
                                }
                            };
                            checkReadyState();
                        }
                    } catch (error) {
                        logMessage(`å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    }
                },

                captureIframeThumbnail(iframeElement) {
                    try {
                        // iframeã®srcã‹ã‚‰å‹•ç”»IDã‚’æŠ½å‡º
                        const src = iframeElement.src;
                        let videoId = null;
                        let thumbnailUrl = null;

                        // YouTube
                        if (src.includes('youtube.com') || src.includes('youtu.be')) {
                            const match = src.match(/(?:youtube\.com\/embed\/|youtu\.be\/|youtube\.com\/watch\?v=)([^&\?\/]+)/);
                            if (match) {
                                videoId = match[1];
                                thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                            }
                        }

                        // Vimeo
                        else if (src.includes('vimeo.com')) {
                            const match = src.match(/vimeo\.com\/(\d+)/);
                            if (match) {
                                videoId = match[1];
                                // Vimeoã®ã‚µãƒ ãƒã‚¤ãƒ«ã¯APIãŒå¿…è¦ãªã®ã§ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨
                                logMessage('Vimeoå‹•ç”»ã®ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—ã«ã¯APIãŒå¿…è¦ã§ã™');
                                thumbnailUrl = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 360"><rect width="640" height="360" fill="#1ab7ea"/><text x="320" y="180" text-anchor="middle" fill="white" font-size="24">Vimeoå‹•ç”»</text></svg>';
                            }
                        }

                        // Dailymotion
                        else if (src.includes('dailymotion.com')) {
                            const match = src.match(/dailymotion\.com\/embed\/video\/([^&\?\/]+)/);
                            if (match) {
                                videoId = match[1];
                                // Dailymotionã®ã‚µãƒ ãƒã‚¤ãƒ«ã¯APIãŒå¿…è¦ãªã®ã§ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨
                                logMessage('Dailymotionå‹•ç”»ã®ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—ã«ã¯APIãŒå¿…è¦ã§ã™');
                                thumbnailUrl = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 360"><rect width="640" height="360" fill="#0066dc"/><text x="320" y="180" text-anchor="middle" fill="white" font-size="24">Dailymotionå‹•ç”»</text></svg>';
                            }
                        }

                        // Twitch
                        else if (src.includes('twitch.tv')) {
                            const match = src.match(/twitch\.tv\/videos\/(\d+)/);
                            if (match) {
                                videoId = match[1];
                                // Twitchã®ã‚µãƒ ãƒã‚¤ãƒ«ã¯APIãŒå¿…è¦ãªã®ã§ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨
                                logMessage('Twitchå‹•ç”»ã®ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—ã«ã¯APIãŒå¿…è¦ã§ã™');
                                thumbnailUrl = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 360"><rect width="640" height="360" fill="#6441a5"/><text x="320" y="180" text-anchor="middle" fill="white" font-size="24">Twitchå‹•ç”»</text></svg>';
                            }
                        }

                        // Bilibili
                        else if (src.includes('bilibili.com')) {
                            const match = src.match(/bilibili\.com\/video\/([^&\?\/]+)/);
                            if (match) {
                                videoId = match[1];
                                // Bilibiliã®ã‚µãƒ ãƒã‚¤ãƒ«ã¯APIãŒå¿…è¦ãªã®ã§ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨
                                logMessage('Bilibiliå‹•ç”»ã®ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—ã«ã¯APIãŒå¿…è¦ã§ã™');
                                thumbnailUrl = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 360"><rect width="640" height="360" fill="#00a1d6"/><text x="320" y="180" text-anchor="middle" fill="white" font-size="24">Bilibiliå‹•ç”»</text></svg>';
                            }
                        }

                        // NicoNico
                        else if (src.includes('nicovideo.jp')) {
                            const match = src.match(/nicovideo\.jp\/watch\/([^\/\?]+)/);
                            if (match) {
                                videoId = match[1];
                                // NicoNicoã®ã‚µãƒ ãƒã‚¤ãƒ«ã¯APIãŒå¿…è¦ãªã®ã§ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨
                                logMessage('NicoNicoå‹•ç”»ã®ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—ã«ã¯APIãŒå¿…è¦ã§ã™');
                                thumbnailUrl = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 360"><rect width="640" height="360" fill="#ff6b6b"/><text x="320" y="180" text-anchor="middle" fill="white" font-size="24">NicoNicoå‹•ç”»</text></svg>';
                            }
                        }

                        // ãã®ä»–ã®å‹•ç”»ã‚µã‚¤ãƒˆ
                        else {
                            logMessage('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å‹•ç”»ã‚µã‚¤ãƒˆã§ã™');
                            thumbnailUrl = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 360"><rect width="640" height="360" fill="#104437"/><text x="320" y="180" text-anchor="middle" fill="white" font-size="24">å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«</text></svg>';
                        }

                        if (thumbnailUrl) {
                            this.processImage(thumbnailUrl, true);
                        } else {
                            logMessage('å‹•ç”»IDã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ');
                            this.processImage('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 360"><rect width="640" height="360" fill="#104437"/><text x="320" y="180" text-anchor="middle" fill="white" font-size="24">å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«</text></svg>', true);
                        }

                    } catch (error) {
                        logMessage(`iframeã‚µãƒ ãƒã‚¤ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        this.processImage('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 360"><rect width="640" height="360" fill="#104437"/><text x="320" y="180" text-anchor="middle" fill="white" font-size="24">ã‚¨ãƒ©ãƒ¼</text></svg>', true);
                    }
                },
                startTagExtractionMode() {
                    state.tagExtractionMode = true; this.elements.extractTagsButton.textContent = "ã‚¿ã‚°æŠ½å‡ºä¸­"; this.elements.extractTagsButton.classList.add("active");
                    const { tags, extractedDate } = extractTagsAndDate();
                    if (tags.length || extractedDate) {
                        const domain = window.location.hostname; const savedData = { image: state.currentCompressedImage || '', url: window.location.href, title: document.title, favicon: getFaviconForNewTab(domain, window.location.href), timestamp: getTimestamp(), tab: domain, tags, extractedDate };
                        const allItems = GM_getValue('savedItems', []); allItems.push(savedData); GM_setValue('savedItems', allItems);
                        if (state.window) { state.window.activeTab = domain; updateTabs(state.window); }
                        logMessage('ã‚¿ã‚°ã¨æ—¥ä»˜ä¿å­˜æˆåŠŸ');
                    }
                    state.tagExtractionMode = false; this.elements.extractTagsButton.textContent = "ğŸ“Œ"; this.elements.extractTagsButton.classList.remove("active");
                },
                setCompressionRate(rate) { state.compressionRate = rate; document.querySelectorAll('#compressionButtons button').forEach(b => b.classList.remove('selected')); document.getElementById(`compression${rate * 100}`).classList.add('selected'); this.startImageSelectionMode(); },
                pasteImageFromClipboard(event) {
                    event.preventDefault(); logMessage('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç”»åƒè²¼ã‚Šä»˜ã‘é–‹å§‹');
                    navigator.clipboard.read().then(data => {
                        if (!data.some(item => item.types.some(type => type.startsWith('image/')))) { logMessage('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ç”»åƒãªã—'); return; }
                        for (const item of data) {
                            for (const type of item.types) {
                                if (type.startsWith('image/')) {
                                    item.getType(type).then(blob => {
                                        const reader = new FileReader(); reader.onload = (e) => this.processImage(e.target.result); reader.readAsDataURL(blob);
                                    }).catch(err => logMessage(`ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ç”»åƒå–å¾—å¤±æ•—: ${err.message}`));
                                    break;
                                }
                            }
                        }
                    }).catch(err => logMessage(`ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}`));
                },
                processImage(src, isVideoThumbnail = false) {
                    const img = new Image(); img.crossOrigin = "Anonymous"; img.src = src;
                    img.onload = () => {
                        try {
                                                // æœ€å¤§ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ150x150pxï¼‰
                        const maxWidth = 150;
                        const maxHeight = 150;

                            let targetWidth, targetHeight;
                            let quality;

                            if (isVideoThumbnail) {
                                // å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«ã®å ´åˆï¼šåœ§ç¸®ãƒœã‚¿ãƒ³ã®è¨­å®šã‚’åæ˜ 
                                targetWidth = Math.min(img.width, maxWidth);
                                targetHeight = Math.min(img.height, maxHeight);
                                quality = state.compressionRate; // åœ§ç¸®ãƒœã‚¿ãƒ³ã®è¨­å®šã‚’ä½¿ç”¨
                            } else {
                                // é€šå¸¸ã®ç”»åƒã®å ´åˆï¼šå‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«ã¨åŒæ§˜ã®å“è³ªè¨­å®š
                                targetWidth = Math.min(img.width, maxWidth);
                                targetHeight = Math.min(img.height, maxHeight);
                                quality = state.compressionRate; // åœ§ç¸®ãƒœã‚¿ãƒ³ã®è¨­å®šã‚’ä½¿ç”¨
                            }

                            // æœ€å¤§ã‚µã‚¤ã‚ºã‚’è¶…ãˆã‚‹å ´åˆã¯ç¸®å°
                            if (targetWidth > maxWidth || targetHeight > maxHeight) {
                                const ratio = Math.min(maxWidth / targetWidth, maxHeight / targetHeight);
                                targetWidth = Math.floor(targetWidth * ratio);
                                targetHeight = Math.floor(targetHeight * ratio);
                            }

                            const canvas = document.createElement('canvas');
                            canvas.width = targetWidth;
                            canvas.height = targetHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            const compressedDataURL = canvas.toDataURL('image/jpeg', quality);
                            state.currentCompressedImage = compressedDataURL;
                            const originalDataURL = canvas.toDataURL('image/jpeg', 1.0);
                            const rate = ((1 - compressedDataURL.length / originalDataURL.length) * 100).toFixed(2);

                            this.elements.compressionRateDisplay.textContent = `åœ§ç¸®ç‡: ${rate}% (${targetWidth}x${targetHeight})`;
                            logMessage(`ç”»åƒåœ§ç¸®æˆåŠŸ: ${rate}% (${targetWidth}x${targetHeight})`);
                        } catch (e) { logMessage(`ç”»åƒåœ§ç¸®å¤±æ•—: ${e.message}`); this.elements.compressionRateDisplay.textContent = "åœ§ç¸®å¤±æ•—"; }
                    };
                    img.onerror = () => { logMessage(`ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: ${src} (CORSã®å¯èƒ½æ€§)`); this.elements.compressionRateDisplay.textContent = "ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—"; };
                },
                exportItems() {
                    try {
                        const allItems = GM_getValue('savedItems', []);
                        const customTabs = [...state.customTabs];
                        const tabColors = Object.fromEntries(state.tabColors);
                        const tabThumbnails = Object.fromEntries(state.tabThumbnails);

                        // ã‚¿ã‚°è¨­å®šã‚’åé›†
                        const tagSettings = {};
                        const allTabs = [...state.customTabs, ...Array.from(new Set(allItems.map(item => item.tab)))];

                        allTabs.forEach(tab => {
                            tagSettings[tab] = {
                                tagGroups: GM_getValue(`tagGroups-${tab}`, {}),
                                excludeTags: GM_getValue(`excludeTags-${tab}`, [])
                            };
                        });

                        // ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤ºè¨­å®šã‚’åé›†
                        const displaySettings = {};
                        allTabs.forEach(tab => {
                            displaySettings[tab] = {
                                sortOrder: GM_getValue(`sortOrder-${tab}`, 'newest'),
                                layout: GM_getValue(`layout-${tab}`, 'tile'),
                                itemSize: GM_getValue(`itemSize-${tab}`, 'standard'),
                                displayMode: GM_getValue(`displayMode-${tab}`, 'full'),
                                multiSelectMode: GM_getValue(`multiSelectMode-${tab}`, false)
                            };
                        });

                        // Tampermonkeyè¨­å®šã‚’åé›†
                        const tampermonkeySettings = this.collectTampermonkeySettings();

                        const exportData = {
                            items: allItems,
                            customTabs,
                            tabColors,
                            tabThumbnails,
                            tagSettings,
                            displaySettings,
                            tampermonkeySettings
                        };
                        const jsonStr = JSON.stringify(exportData, null, 2);
                        const blob = new Blob([jsonStr], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `saved_items_${getDateString()}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        logMessage('ã‚¢ã‚¤ãƒ†ãƒ ã€ã‚¿ã‚°è¨­å®šã€è¡¨ç¤ºè¨­å®šã€Tampermonkeyè¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæˆåŠŸ');
                        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    } catch (e) {
                        logMessage(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—: ${e.message}`);
                        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                },
                collectTampermonkeySettings() {
                    try {
                        const settings = {
                            userExcludes: GM_getValue('userExcludes', []),
                            userIncludes: GM_getValue('userIncludes', []),
                            otherSettings: {}
                        };

                        // ãã®ä»–ã®Tampermonkeyè¨­å®šã‚’åé›†
                        const allKeys = Object.keys(localStorage).filter(key => key.startsWith('tm_'));
                        allKeys.forEach(key => {
                            const value = GM_getValue(key, null);
                            if (value !== null) {
                                settings.otherSettings[key] = value;
                            }
                        });

                        logMessage(`Tampermonkeyè¨­å®šã‚’åé›†: é™¤å¤–${settings.userExcludes.length}ä»¶ã€å«ã‚ã‚‹${settings.userIncludes.length}ä»¶ã€ãã®ä»–${Object.keys(settings.otherSettings).length}ä»¶`);
                        return settings;
                    } catch (error) {
                        logMessage(`Tampermonkeyè¨­å®šåé›†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                        return { userExcludes: [], userIncludes: [], otherSettings: {} };
                    }
                },
                importItems() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'application/json';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            try {
                                const data = JSON.parse(ev.target.result);
                                if (!data.items || !Array.isArray(data.items)) throw new Error('ç„¡åŠ¹ãªJSONå½¢å¼');
                                const confirmMerge = confirm('æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¦ãƒãƒ¼ã‚¸ã—ã¾ã™ã‹ï¼Ÿï¼ˆã„ã„ãˆã‚’é¸æŠã™ã‚‹ã¨ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰');
                                let allItems = confirmMerge ? GM_getValue('savedItems', []) : [];
                                allItems = [...allItems, ...data.items];
                                GM_setValue('savedItems', allItems);
                                if (data.customTabs && Array.isArray(data.customTabs)) {
                                    state.updateCustomTabs([...new Set([...state.customTabs, ...data.customTabs])]);
                                }
                                if (data.tabColors && typeof data.tabColors === 'object') {
                                    Object.entries(data.tabColors).forEach(([tab, color]) => state.setTabColor(tab, color));
                                }
                                if (data.tabThumbnails && typeof data.tabThumbnails === 'object') {
                                    Object.entries(data.tabThumbnails).forEach(([tab, thumbnail]) => state.setTabThumbnail(tab, thumbnail));
                                }

                                // ã‚¿ã‚°è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                                if (data.tagSettings && typeof data.tagSettings === 'object') {
                                    Object.entries(data.tagSettings).forEach(([tab, settings]) => {
                                        if (settings.tagGroups && typeof settings.tagGroups === 'object') {
                                            GM_setValue(`tagGroups-${tab}`, settings.tagGroups);
                                        }
                                        if (settings.excludeTags && Array.isArray(settings.excludeTags)) {
                                            GM_setValue(`excludeTags-${tab}`, settings.excludeTags);
                                        }
                                    });
                                }

                                // ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤ºè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                                if (data.displaySettings && typeof data.displaySettings === 'object') {
                                    Object.entries(data.displaySettings).forEach(([tab, settings]) => {
                                        if (settings.sortOrder) GM_setValue(`sortOrder-${tab}`, settings.sortOrder);
                                        if (settings.layout) GM_setValue(`layout-${tab}`, settings.layout);
                                        if (settings.itemSize) GM_setValue(`itemSize-${tab}`, settings.itemSize);
                                        if (settings.displayMode) GM_setValue(`displayMode-${tab}`, settings.displayMode);
                                        if (settings.multiSelectMode !== undefined) GM_setValue(`multiSelectMode-${tab}`, settings.multiSelectMode);
                                    });
                                }

                                // Tampermonkeyè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                                if (data.tampermonkeySettings && typeof data.tampermonkeySettings === 'object') {
                                    this.importTampermonkeySettings(data.tampermonkeySettings);
                                }

                                if (state.window) {
                                    updateTabs(state.window);
                                    displaySavedItems(state.window);
                                }
                                logMessage('ã‚¢ã‚¤ãƒ†ãƒ ã€ã‚¿ã‚°è¨­å®šã€è¡¨ç¤ºè¨­å®šã€Tampermonkeyè¨­å®šã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ');
                                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                            } catch (err) {
                                logMessage(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ${err.message}`);
                                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                            }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                },
                importTampermonkeySettings(settings) {
                    try {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹é™¤å¤–è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        if (settings.userExcludes && Array.isArray(settings.userExcludes)) {
                            // ç¾åœ¨ã®é™¤å¤–è¨­å®šã‚’å–å¾—
                            const currentExcludes = GM_getValue('userExcludes', []);
                            const mergedExcludes = [...new Set([...currentExcludes, ...settings.userExcludes])];
                            GM_setValue('userExcludes', mergedExcludes);
                            logMessage(`ãƒ¦ãƒ¼ã‚¶ãƒ¼é™¤å¤–è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: ${settings.userExcludes.length}ä»¶`);
                        }

                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹å«ã‚ã‚‹è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        if (settings.userIncludes && Array.isArray(settings.userIncludes)) {
                            const currentIncludes = GM_getValue('userIncludes', []);
                            const mergedIncludes = [...new Set([...currentIncludes, ...settings.userIncludes])];
                            GM_setValue('userIncludes', mergedIncludes);
                            logMessage(`ãƒ¦ãƒ¼ã‚¶ãƒ¼å«ã‚ã‚‹è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: ${settings.userIncludes.length}ä»¶`);
                        }

                        // ãã®ä»–ã®Tampermonkeyè¨­å®š
                        if (settings.otherSettings && typeof settings.otherSettings === 'object') {
                            Object.entries(settings.otherSettings).forEach(([key, value]) => {
                                GM_setValue(`tm_${key}`, value);
                            });
                            logMessage(`ãã®ä»–ã®Tampermonkeyè¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: ${Object.keys(settings.otherSettings).length}ä»¶`);
                        }

                        logMessage('Tampermonkeyè¨­å®šã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
                    } catch (error) {
                        logMessage(`Tampermonkeyè¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    }
                },
                setupDrag() {
                    const handleMove = (e) => {
                        if (state.isDraggingToolbar) {
                            let leftPx = e.clientX - state.offsetXToolbar; let topPx = e.clientY - state.offsetYToolbar; leftPx = Math.max(0, Math.min(leftPx, window.innerWidth - this.elements.toolbar.offsetWidth)); topPx = Math.max(0, Math.min(topPx, window.innerHeight - this.elements.toolbar.offsetHeight));
                            requestAnimationFrame(() => { this.elements.toolbar.style.left = `${leftPx}px`; this.elements.toolbar.style.top = `${topPx}px`; });
                        }
                    };
                    const handleUp = () => { if (state.isDraggingToolbar) { GM_setValue('toolbarPosition', { left: this.elements.toolbar.style.left, top: this.elements.toolbar.style.top }); state.isDraggingToolbar = false; document.removeEventListener('mousemove', handleMove); document.removeEventListener('mouseup', handleUp); } };
                    events.add(this.elements.toolbarHandle, 'mousedown', (e) => { state.isDraggingToolbar = true; state.offsetXToolbar = e.clientX - this.elements.toolbar.offsetLeft; state.offsetYToolbar = e.clientY - this.elements.toolbar.offsetTop; e.preventDefault(); document.addEventListener('mousemove', handleMove); document.addEventListener('mouseup', handleUp); });
                    events.add(this.elements.toolbarBottomHandle, 'mousedown', (e) => { state.isDraggingToolbar = true; state.offsetXToolbar = e.clientX - this.elements.toolbar.offsetLeft; state.offsetYToolbar = e.clientY - this.elements.toolbar.offsetTop; e.preventDefault(); document.addEventListener('mousemove', handleMove); document.addEventListener('mouseup', handleUp); });
                },

                adjustToolbarHeight() {
                    // å‹•çš„èª¿æ•´æ©Ÿèƒ½ã‚’å‰Šé™¤ã—ã€é™çš„ãªé«˜ã•ã‚’è¨­å®š
                    const toolbar = this.elements.toolbar;
                    toolbar.style.height = '350px'; // 12å€‹åˆ†ã®ãƒœã‚¿ãƒ³ã«é©ã—ãŸé«˜ã•
                    toolbar.style.overflow = 'hidden';

                    logMessage('ãƒ„ãƒ¼ãƒ«ãƒãƒ¼é«˜ã•ã‚’é™çš„ã«è¨­å®š: 350px');
                },
                toggleWindow() {
                    if (!state.window) {
                        const id = 'single-window';
                        const savedState = GM_getValue(`windowState-${id}`, { position: { left: '21px', top: '23px' }, size: { width: '950px', height: '550px' } });
                        const windowObj = Window.create(id, savedState);
                        if (windowObj) { state.setWindow(windowObj); windowObj.el.style.display = 'none'; }
                    }
                    const windowEl = state.window.el;
                    windowEl.style.display = windowEl.style.display === 'none' ? 'block' : 'none';
                    if (windowEl.style.display === 'block') bringToFront(state.window);
                    Window.saveState(state.window);
                    this.elements.toggleWindowButton.textContent = windowEl.style.display === 'block' ? 'ğŸ”½' : 'ğŸ–¼ï¸';
                }
            };

            const Window = {
                colorPresets: new Map([['èµ¤', '#8B0000'], ['é’', '#1E90FF'], ['é»„è‰²', '#DAA520'], ['ç·‘', '#228B22'], ['ãƒ”ãƒ³ã‚¯', '#C71585'], ['ã‚ªãƒ¬ãƒ³ã‚¸', '#FF4500'], ['ç´«', '#4B0082'], ['èŒ¶è‰²', '#8B4513'], ['ç°è‰²', '#696969']]),
                thumbnailPresets: ['ğŸŒŸ', 'ğŸ“Œ', 'ğŸ“·', 'ğŸ“–', 'ğŸµ'],
                create(id, savedState) {
                    try {
                        const el = document.createElement('div');
                        el.className = 'window';
                        el.id = `window-${id}`;
                        const fragment = document.createDocumentFragment();

                        const windowObj = {
                            el, id, name: savedState?.name || '1', activeTab: savedState?.activeTab || [...state.customTabs][0],
                            isMaximized: savedState?.isMaximized || false,
                            sortOrder: savedState?.sortOrder || 'newest',
                            layout: savedState?.layout || 'tile',
                            itemSize: savedState?.itemSize || 'standard',
                            displayMode: savedState?.displayMode || 'full',
                            position: savedState?.position || { left: '21px', top: '23px' },
                            size: savedState?.size || { width: '950px', height: '550px' },
                            isEditing: savedState?.isEditing || false
                        };

                        // åˆæœŸåŒ–æ™‚ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
                        windowObj.sortOrder = GM_getValue(`sortOrder-${windowObj.activeTab}`, windowObj.sortOrder);
                        windowObj.layout = GM_getValue(`layout-${windowObj.activeTab}`, windowObj.layout);
                        windowObj.itemSize = GM_getValue(`itemSize-${windowObj.activeTab}`, windowObj.itemSize);
                        windowObj.displayMode = GM_getValue(`displayMode-${windowObj.activeTab}`, windowObj.displayMode);
                        windowObj.multiSelectMode = GM_getValue(`multiSelectMode-${windowObj.activeTab}`, false);

                        // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚€
                        const savedSelectedTags = GM_getValue(`selectedTags-${windowObj.activeTab}`, []);
                        windowObj.selectedTags = new Set(savedSelectedTags);

                        // é™¤å¤–ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚€
                        windowObj.excludeTags = GM_getValue(`excludeTags-${windowObj.activeTab}`, []);

                        // ã‚¿ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’èª­ã¿è¾¼ã‚€
                        windowObj.tagGroups = GM_getValue(`tagGroups-${windowObj.activeTab}`, {});

                        const toolbarHandle = document.createElement('div'); toolbarHandle.className = 'toolbarHandle';
                        const menuBar = document.createElement('div'); menuBar.className = 'menuBar';
                        const leftButtons = document.createElement('div'); leftButtons.className = 'left-buttons';
                        const tabMenuBtn = document.createElement('button'); tabMenuBtn.className = 'tabMenuButton'; tabMenuBtn.textContent = 'ã‚¿ãƒ–';
                        const windowMenuBtn = document.createElement('button'); windowMenuBtn.className = 'windowMenuButton'; windowMenuBtn.textContent = 'ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦';
                        const itemMenuBtn = document.createElement('button'); itemMenuBtn.className = 'itemMenuButton'; itemMenuBtn.textContent = 'ã‚¢ã‚¤ãƒ†ãƒ ';
                        const dataMenuBtn = document.createElement('button'); dataMenuBtn.className = 'dataMenuButton'; dataMenuBtn.textContent = 'ãƒ‡ãƒ¼ã‚¿';
                        leftButtons.append(tabMenuBtn, windowMenuBtn, itemMenuBtn, dataMenuBtn);
                        const title = document.createElement('h3'); title.textContent = windowObj.name;
                        const rightButtons = document.createElement('div'); rightButtons.className = 'right-buttons';
                        const debugInfo = document.createElement('span'); debugInfo.className = 'debug-info';
                        const minimizeBtn = document.createElement('button'); minimizeBtn.className = 'minimizeButton'; minimizeBtn.textContent = 'â”€';
                        const maximizeBtn = document.createElement('button'); maximizeBtn.className = 'maximizeButton'; maximizeBtn.textContent = 'â–¡';
                        rightButtons.append(debugInfo, minimizeBtn, maximizeBtn);
                        menuBar.append(leftButtons, title, rightButtons);

                        const controlBar = document.createElement('div'); controlBar.className = 'controlBar';
                        const editBtn = document.createElement('button'); editBtn.className = 'editButton'; editBtn.textContent = 'ç·¨é›†';
                        const layoutBtn = document.createElement('button'); layoutBtn.className = 'layoutButton'; layoutBtn.textContent = 'ã‚¿ã‚¤ãƒ«';
                        const sortSelect = document.createElement('select'); sortSelect.className = 'sortSelect';
                        ['newest:æ–°ã—ã„é †', 'oldest:å¤ã„é †', 'extractedDateOldest:æŠ½å‡ºæ—¥ä»˜ å¤ã„é †', 'extractedDateNewest:æŠ½å‡ºæ—¥ä»˜ æ–°ã—ã„é †'].forEach(opt => {
                            const option = document.createElement('option');
                            const [value, text] = opt.split(':');
                            option.value = value;
                            option.textContent = text;
                            sortSelect.appendChild(option);
                        });
                        const itemSizeSelect = document.createElement('select'); itemSizeSelect.className = 'itemSizeSelect';
                        ['standard:æ¨™æº–', 'large:å¤§', 'medium:ä¸­', 'small:å°', 'half:1/2', 'third:1/3', 'quarter:1/4', 'mini:ãƒŸãƒ‹'].forEach(opt => {
                            const option = document.createElement('option');
                            const [value, text] = opt.split(':');
                            option.value = value;
                            option.textContent = text;
                            itemSizeSelect.appendChild(option);
                        });
                        const displayModeSelect = document.createElement('select'); displayModeSelect.className = 'displayModeSelect';
                        ['full:ã™ã¹ã¦è¡¨ç¤º', 'image-only:ç”»åƒã®ã¿', 'image-title:ç”»åƒã¨ã‚¿ã‚¤ãƒˆãƒ«'].forEach(opt => {
                            const option = document.createElement('option');
                            const [value, text] = opt.split(':');
                            option.value = value;
                            option.textContent = text;
                            displayModeSelect.appendChild(option);
                        });
                        const dataSizeBtn = document.createElement('button'); dataSizeBtn.className = 'dataSizeButton'; dataSizeBtn.textContent = 'ãƒ‡ãƒ¼ã‚¿';
                        const elementEditBtn = document.createElement('button'); elementEditBtn.className = 'elementEditButton'; elementEditBtn.textContent = 'è¦ç´ ç·¨é›†'; elementEditBtn.title = 'è¦ç´ ç·¨é›†';
                        const tagEditBtn = document.createElement('button'); tagEditBtn.className = 'tagEditButton'; tagEditBtn.textContent = 'ã‚¿ã‚°ç·¨é›†'; tagEditBtn.title = 'ã‚¿ã‚°ç·¨é›†';
                        const multiSelectBtn = document.createElement('button'); multiSelectBtn.className = 'multiSelectButton'; multiSelectBtn.textContent = 'â˜‘ï¸'; multiSelectBtn.title = 'è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰';
                        const tagFilterArea = document.createElement('div'); tagFilterArea.className = 'tagFilterArea'; tagFilterArea.style.cssText = 'display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; padding: 5px; background: #0a1f2e; border-radius: 5px; min-height: 30px;';
                        controlBar.append(editBtn, layoutBtn, sortSelect, itemSizeSelect, displayModeSelect, dataSizeBtn, elementEditBtn, tagEditBtn, multiSelectBtn, tagFilterArea);

                        const tabSidebar = document.createElement('div'); tabSidebar.className = 'tabSidebar';
                        const savedItems = document.createElement('div'); savedItems.className = 'savedItems';
                        const resizeTop = document.createElement('div'); resizeTop.className = 'resize-handle resize-top';
                        const resizeBottom = document.createElement('div'); resizeBottom.className = 'resize-handle resize-bottom';
                        const resizeLeft = document.createElement('div'); resizeLeft.className = 'resize-handle resize-left';
                        const resizeRight = document.createElement('div'); resizeRight.className = 'resize-handle resize-right';

                        fragment.append(toolbarHandle, menuBar, controlBar, tabSidebar, savedItems, resizeTop, resizeBottom, resizeLeft, resizeRight);
                        el.appendChild(fragment);
                        document.body.appendChild(el);

                        logMessage(`ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ ${id} è¿½åŠ æˆåŠŸ`);
                        this.setupEventListeners(windowObj);
                        updateTabs(windowObj);
                        displaySavedItems(windowObj);
                        el.style.left = windowObj.position.left;
                        el.style.top = windowObj.position.top;
                        el.style.width = windowObj.size.width;
                        el.style.height = windowObj.size.height;
                        el.style.display = 'none';
                        return windowObj;
                    } catch (e) {
                        logMessage(`ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ ${id} ä½œæˆå¤±æ•—: ${e.message}`);
                        return null;
                    }
                },
                setupEventListeners(windowObj) {
                    const toolbarHandle = windowObj.el.querySelector('.toolbarHandle'), minimizeButton = windowObj.el.querySelector('.minimizeButton'), maximizeButton = windowObj.el.querySelector('.maximizeButton'), tabMenuButton = windowObj.el.querySelector('.tabMenuButton'), windowMenuButton = windowObj.el.querySelector('.windowMenuButton'), itemMenuButton = windowObj.el.querySelector('.itemMenuButton'), dataMenuButton = windowObj.el.querySelector('.dataMenuButton'), menuBar = windowObj.el.querySelector('.menuBar'), editButton = windowObj.el.querySelector('.editButton'), layoutButton = windowObj.el.querySelector('.layoutButton'), sortSelect = windowObj.el.querySelector('.sortSelect'), itemSizeSelect = windowObj.el.querySelector('.itemSizeSelect'), displayModeSelect = windowObj.el.querySelector('.displayModeSelect'), savedItems = windowObj.el.querySelector('.savedItems'), controlBar = windowObj.el.querySelector('.controlBar'), debugInfo = windowObj.el.querySelector('.debug-info');
                    sortSelect.value = windowObj.sortOrder; events.add(sortSelect, 'change', () => { windowObj.sortOrder = sortSelect.value; GM_setValue(`sortOrder-${windowObj.activeTab}`, windowObj.sortOrder); displaySavedItems(windowObj); this.saveState(windowObj); });
                    itemSizeSelect.value = windowObj.itemSize; events.add(itemSizeSelect, 'change', () => { windowObj.itemSize = itemSizeSelect.value; GM_setValue(`itemSize-${windowObj.activeTab}`, windowObj.itemSize); displaySavedItems(windowObj); this.saveState(windowObj); });
                    displayModeSelect.value = windowObj.displayMode; events.add(displayModeSelect, 'change', () => { windowObj.displayMode = displayModeSelect.value; GM_setValue(`displayMode-${windowObj.activeTab}`, windowObj.displayMode); displaySavedItems(windowObj); this.saveState(windowObj); });
                    events.add(windowObj.el, 'mousedown', () => { bringToFront(windowObj); if (state.activeMenu && !menuBar.contains(event.target) && !state.activeMenu.contains(event.target)) { closeActiveMenu(); state.isHoverEnabled = false; } });
                    const updateDebugInfo = () => debugInfo.textContent = `(${windowObj.el.style.left}, ${windowObj.el.style.top}) ${windowObj.el.style.width}x${windowObj.el.style.height}`; updateDebugInfo();
                    let isDragging = false, offsetX, offsetY;
                    const handleDragMove = (e) => { if (isDragging) { let leftPx = e.clientX - offsetX; let topPx = e.clientY - offsetY; let widthPx = parseInt(windowObj.el.style.width); let heightPx = parseInt(windowObj.el.style.height); leftPx = Math.max(0, Math.min(leftPx, window.innerWidth - widthPx)); topPx = Math.max(0, Math.min(topPx, window.innerHeight - heightPx - 40)); requestAnimationFrame(() => { windowObj.el.style.left = `${leftPx}px`; windowObj.el.style.top = `${topPx}px`; }); } };
                    const handleDragEnd = () => { if (isDragging) { this.saveState(windowObj); isDragging = false; document.removeEventListener('mousemove', handleDragMove); document.removeEventListener('mouseup', handleDragEnd); } };
                    events.add(toolbarHandle, 'mousedown', (e) => { isDragging = true; offsetX = e.clientX - windowObj.el.offsetLeft; offsetY = e.clientY - windowObj.el.offsetTop; e.preventDefault(); document.addEventListener('mousemove', handleDragMove); document.addEventListener('mouseup', handleDragEnd); });
                    let isResizing = false, resizeDir, startX, startY, startWidth, startHeight, startLeft, startTop;
                    const handleResizeMove = (e) => {
                        if (!isResizing) return; let deltaX = e.clientX - startX; let deltaY = e.clientY - startY; let newWidth = startWidth; let newHeight = startHeight; let newLeft = startLeft; let newTop = startTop;
                        if (resizeDir === 'top') { newHeight = startHeight - deltaY; newTop = startTop + deltaY; } else if (resizeDir === 'bottom') { newHeight = startHeight + deltaY; } else if (resizeDir === 'left') { newWidth = startWidth - deltaX; newLeft = startLeft + deltaX; } else if (resizeDir === 'right') { newWidth = startWidth + deltaX; }
                        newWidth = Math.max(200, Math.min(newWidth, window.innerWidth - newLeft)); newHeight = Math.max(150, Math.min(newHeight, window.innerHeight - newTop - 40)); newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - newWidth)); newTop = Math.max(0, Math.min(newTop, window.innerHeight - newHeight - 40));
                        requestAnimationFrame(() => { windowObj.el.style.width = `${newWidth}px`; windowObj.el.style.height = `${newHeight}px`; windowObj.el.style.left = `${newLeft}px`; windowObj.el.style.top = `${newTop}px`; });
                    };
                    const handleResizeEnd = () => { if (isResizing) { this.saveState(windowObj); isResizing = false; document.removeEventListener('mousemove', handleResizeMove); document.removeEventListener('mouseup', handleResizeEnd); } };
                    ['top', 'bottom', 'left', 'right'].forEach(dir => { const handle = windowObj.el.querySelector(`.resize-${dir}`); events.add(handle, 'mousedown', (e) => { isResizing = true; resizeDir = dir; startX = e.clientX; startY = e.clientY; startWidth = parseInt(windowObj.el.style.width); startHeight = parseInt(windowObj.el.style.height); startLeft = parseFloat(windowObj.el.style.left); startTop = parseFloat(windowObj.el.style.top); e.preventDefault(); document.addEventListener('mousemove', handleResizeMove); document.addEventListener('mouseup', handleResizeEnd); }); });
                    events.add(savedItems, 'wheel', (e) => { e.preventDefault(); savedItems.scrollTop += e.deltaY; });
                    events.add(minimizeButton, 'click', () => { windowObj.el.style.display = 'none'; this.saveState(windowObj); Toolbar.elements.toggleWindowButton.textContent = 'ğŸ–¼ï¸'; });
                    events.add(maximizeButton, 'click', () => {
                        if (!windowObj.isMaximized) { windowObj.size = { width: windowObj.el.style.width, height: windowObj.el.style.height }; windowObj.el.style.width = `${window.innerWidth}px`; windowObj.el.style.height = `${window.innerHeight - 40}px`; windowObj.el.style.top = '0'; windowObj.el.style.left = '0'; maximizeButton.textContent = 'ğŸ——'; } else { windowObj.el.style.width = windowObj.size.width; windowObj.el.style.height = windowObj.size.height; windowObj.el.style.top = windowObj.position.top; windowObj.el.style.left = windowObj.position.left; maximizeButton.textContent = 'â–¡'; }
                        windowObj.isMaximized = !windowObj.isMaximized; this.saveState(windowObj);
                    });
                    const dataSizeButton = windowObj.el.querySelector('.dataSizeButton');
                    const menuButtons = [{ button: tabMenuButton, type: 'tab' }, { button: windowMenuButton, type: 'window' }, { button: itemMenuButton, type: 'item' }, { button: dataMenuButton, type: 'data' }];
                    menuButtons.forEach(menu => {
                        events.add(menu.button, 'click', (e) => {
                            e.preventDefault(); e.stopPropagation();
                            if (state.isHoverEnabled) { closeActiveMenu(); state.isHoverEnabled = false; logMessage('ãƒ›ãƒãƒ¼çŠ¶æ…‹ã‚’è§£é™¤ã—ã¾ã—ãŸï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼å†ã‚¯ãƒªãƒƒã‚¯ï¼‰'); } else { closeActiveMenu(); state.isHoverEnabled = true; state.activeMenu = this.createSubMenu(windowObj, menu.type, menu.button); addCloseOnClickOutside(state.activeMenu, menuBar); logMessage(`ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã¾ã—ãŸ: ${menu.type}`); }
                        });
                        events.add(menu.button, 'mouseenter', () => { if (state.isHoverEnabled && !state.activePopup) { closeActiveMenu(); state.activeMenu = this.createSubMenu(windowObj, menu.type, menu.button); addCloseOnClickOutside(state.activeMenu, menuBar); logMessage(`ãƒ›ãƒãƒ¼ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã¾ã—ãŸ: ${menu.type}`); } });
                    });
                        events.add(editButton, 'click', () => {
                                        if (windowObj.isEditing) {
                            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†
                            controlBar.querySelectorAll('.moveTabButton, .selectAll, .deselectAll, .deleteSelected, .resizeSelected').forEach(btn => btn.remove());
                            editButton.textContent = 'ç·¨é›†';
                            windowObj.isEditing = false;
                            windowObj.el.classList.remove('editing');
                            savedItems.querySelectorAll('.savedItem').forEach(item => {
                                events.removeAll(item); // æ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
                                item.style.cursor = 'pointer';
                                item.classList.remove('selected');
                                const checkbox = item.querySelector('.selectItem');
                                if (checkbox) {
                                    checkbox.checked = false;
                                    checkbox.remove(); // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
                                }
                            });
                            logMessage(`ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†: ${windowObj.id}`);
                } else {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
                    const moveTabBtn = document.createElement('button');
                    moveTabBtn.className = 'moveTabButton';
                    moveTabBtn.textContent = 'â¡';
                    events.add(moveTabBtn, 'click', () => {
                        const checkboxes = savedItems.querySelectorAll('.selectItem:checked');
                        if (!checkboxes.length) return;
                        if (state.activePopup) {
                            state.activePopup.remove();
                            state.activePopup = null;
                        }
                        state.activePopup = createMoveTabWindow(windowObj, checkboxes);
                    });
                    const selectAllBtn = document.createElement('button');
                    selectAllBtn.className = 'selectAll';
                    selectAllBtn.textContent = 'å…¨é¸æŠ';
                    events.add(selectAllBtn, 'click', () => {
                        savedItems.querySelectorAll('.selectItem').forEach(cb => {
                            cb.checked = true;
                            cb.parentElement.classList.add('selected');
                        });
                    });
                    const deselectAllBtn = document.createElement('button');
                    deselectAllBtn.className = 'deselectAll';
                    deselectAllBtn.textContent = 'å…¨è§£é™¤';
                    events.add(deselectAllBtn, 'click', () => {
                        savedItems.querySelectorAll('.selectItem').forEach(cb => {
                            cb.checked = false;
                            cb.parentElement.classList.remove('selected');
                        });
                    });
                    const deleteSelectedBtn = document.createElement('button');
                    deleteSelectedBtn.className = 'deleteSelected';
                    deleteSelectedBtn.textContent = 'ğŸ—‘ï¸';
                    events.add(deleteSelectedBtn, 'click', () => {
                        const checkboxes = savedItems.querySelectorAll('.selectItem:checked');
                        if (!checkboxes.length) return;
                        let allItems = GM_getValue('savedItems', []);
                        checkboxes.forEach(cb => {
                            const timestamp = cb.parentElement.dataset.timestamp;
                            allItems = allItems.filter(item => item.timestamp !== timestamp);
                        });
                        GM_setValue('savedItems', allItems);
                        displaySavedItems(windowObj);
                    });

                    const resizeSelectedBtn = document.createElement('button');
                    resizeSelectedBtn.className = 'resizeSelected';
                    resizeSelectedBtn.textContent = 'ğŸ“';
                    resizeSelectedBtn.title = 'é¸æŠã—ãŸç”»åƒã‚’ãƒªã‚µã‚¤ã‚º';
                    events.add(resizeSelectedBtn, 'click', () => {
                        const checkboxes = savedItems.querySelectorAll('.selectItem:checked');
                        if (!checkboxes.length) {
                            alert('ãƒªã‚µã‚¤ã‚ºã™ã‚‹ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                            return;
                        }
                        if (confirm(`é¸æŠã—ãŸ${checkboxes.length}ä»¶ã®ç”»åƒã‚’150x150pxä»¥ä¸‹ã«ãƒªã‚µã‚¤ã‚ºã—ã¾ã™ã‹ï¼Ÿ\nâ€»å…ƒã®ç”»åƒã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚`)) {
                            resizeSelectedImages(windowObj, checkboxes);
                        }
                    });
                    controlBar.insertBefore(moveTabBtn, controlBar.querySelector('.layoutButton'));
                    controlBar.insertBefore(selectAllBtn, controlBar.querySelector('.layoutButton'));
                    controlBar.insertBefore(deselectAllBtn, controlBar.querySelector('.layoutButton'));
                    controlBar.insertBefore(deleteSelectedBtn, controlBar.querySelector('.layoutButton'));
                    controlBar.insertBefore(resizeSelectedBtn, controlBar.querySelector('.layoutButton'));
                    editButton.textContent = 'çµ‚äº†';
                    windowObj.isEditing = true;
                    windowObj.el.classList.add('editing');
                    // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
                    savedItems.querySelectorAll('.savedItem').forEach(item => {
                        if (!item.querySelector('.selectItem')) {
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'selectItem';
                            checkbox.style.display = 'block';
                            item.insertBefore(checkbox, item.firstChild);
                        }
                    });
                    addItemClickListeners(windowObj, savedItems.querySelectorAll('.savedItem'));
                    logMessage(`ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹: ${windowObj.id}`);
                }
            });
                        events.add(layoutButton, 'click', () => {
                        windowObj.layout = windowObj.layout === 'tile' ? 'column' : 'tile';
                        GM_setValue(`layout-${windowObj.activeTab}`, windowObj.layout);
                        layoutButton.textContent = windowObj.layout === 'tile' ? 'ã‚¿ã‚¤ãƒ«' : '1åˆ—';
                        displaySavedItems(windowObj);
                        this.saveState(windowObj);
                    });
                    layoutButton.textContent = windowObj.layout === 'tile' ? 'ã‚¿ã‚¤ãƒ«' : '1åˆ—';
                    events.add(dataSizeButton, 'click', () => showDataSizeInfo(windowObj));
                    const elementEditButton = windowObj.el.querySelector('.elementEditButton');
                    events.add(elementEditButton, 'click', () => createElementEditWindow(windowObj));
                    const tagEditButton = windowObj.el.querySelector('.tagEditButton');
                    events.add(tagEditButton, 'click', () => createTagEditWindow(windowObj));

                    const multiSelectButton = windowObj.el.querySelector('.multiSelectButton');
                    events.add(multiSelectButton, 'click', () => {
                        if (windowObj.multiSelectMode) {
                            // è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰çµ‚äº†
                            windowObj.multiSelectMode = false;
                            multiSelectButton.style.background = '#104437';
                            multiSelectButton.textContent = 'â˜‘ï¸';
                            GM_setValue(`multiSelectMode-${windowObj.activeTab}`, false);
                            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
                            const savedItems = windowObj.el.querySelector('.savedItems');
                            savedItems.querySelectorAll('.savedItem').forEach(item => {
                                const checkbox = item.querySelector('.selectItem');
                                if (checkbox) {
                                    checkbox.checked = false;
                                    checkbox.remove();
                                }
                                item.classList.remove('selected');
                            });
                            logMessage('è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰çµ‚äº†');
                        } else {
                            // è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹
                            windowObj.multiSelectMode = true;
                            multiSelectButton.style.background = '#e67e22';
                            multiSelectButton.textContent = 'â˜‘ï¸';
                            GM_setValue(`multiSelectMode-${windowObj.activeTab}`, true);
                            // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
                            const savedItems = windowObj.el.querySelector('.savedItems');
                            savedItems.querySelectorAll('.savedItem').forEach(item => {
                                if (!item.querySelector('.selectItem')) {
                                    const checkbox = document.createElement('input');
                                    checkbox.type = 'checkbox';
                                    checkbox.className = 'selectItem';
                                    checkbox.style.display = 'block';
                                    item.insertBefore(checkbox, item.firstChild);
                                }
                            });
                            addItemClickListeners(windowObj, savedItems.querySelectorAll('.savedItem'));
                            logMessage('è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹');
                        }
                    });

                    // åˆæœŸã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¨­å®š
                    updateClearButton(windowObj);

                    logMessage(`ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ ${windowObj.id} ãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†`);
                },
                createSubMenu(windowObj, type, button) {
                    const subMenu = document.createElement('div'); subMenu.className = 'subMenu';
                    const menuBar = button.closest('.menuBar');
                    const menuBarRect = menuBar.getBoundingClientRect();
                    const buttonRect = button.getBoundingClientRect();
                    const windowRect = windowObj.el.getBoundingClientRect();
                    subMenu.style.position = 'absolute'; subMenu.style.left = `${buttonRect.left - windowRect.left}px`; subMenu.style.top = `${menuBarRect.height}px`;
                    const items = type === 'tab' ? [{ text: 'ã‚¿ãƒ–ç®¡ç†', action: () => createTabManageWindow(windowObj) }] :
                                type === 'window' ? [] :
                                type === 'item' ? [{ text: 'ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤', action: () => { if (confirm('ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { GM_setValue('savedItems', []); displaySavedItems(windowObj); } } }] :
                                type === 'data' ? [
                                    { text: 'ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', action: () => Toolbar.exportItems() },
                                    { text: 'ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', action: () => Toolbar.importItems() },
                                    { text: 'ğŸ“Š ãƒ­ã‚°è¡¨ç¤º', action: () => createLogWindow() }
                                ] : [];
                    items.forEach(item => {
                        const menuItem = document.createElement('div'); menuItem.textContent = item.text; menuItem.className = 'subMenuItem';
                        events.add(menuItem, 'click', (e) => { e.stopPropagation(); closeActiveMenu(); if (state.activePopup) { state.activePopup.remove(); state.activePopup = null; } state.activePopup = item.action(); bringToFrontPopup(state.activePopup); });
                        events.add(menuItem, 'mouseenter', () => menuItem.style.backgroundColor = '#ddd');
                        events.add(menuItem, 'mouseleave', () => menuItem.style.backgroundColor = '#f0f0f0');
                        subMenu.appendChild(menuItem);
                    });
                    windowObj.el.appendChild(subMenu);
                    return subMenu;
                },
                saveState(windowObj) {
                    const savedState = {
                        name: windowObj.name, activeTab: windowObj.activeTab, isMaximized: windowObj.isMaximized,
                        sortOrder: windowObj.sortOrder, layout: windowObj.layout, itemSize: windowObj.itemSize,
                        displayMode: windowObj.displayMode, isEditing: windowObj.isEditing,
                        position: { left: windowObj.el.style.left, top: windowObj.el.style.top },
                        size: { width: windowObj.el.style.width, height: windowObj.el.style.height },
                        display: windowObj.el.style.display
                    };
                    GM_setValue(`windowState-${windowObj.id}`, savedState);
                }
            };

            const saveImage = () => {
                if (!state.currentCompressedImage || !state.window) { logMessage('ä¿å­˜å¤±æ•—: ç”»åƒãªã—ã¾ãŸã¯ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãªã—'); return; }
                const domain = window.location.hostname; const { tags, extractedDate } = extractTagsAndDate(); const favicon = getFaviconForNewTab(domain, window.location.href); const savedData = { image: state.currentCompressedImage, url: window.location.href, title: document.title, favicon, timestamp: getTimestamp(), tab: domain, tags, extractedDate };
                const allItems = GM_getValue('savedItems', []); allItems.push(savedData); GM_setValue('savedItems', allItems); state.window.activeTab = domain; updateTabs(state.window); displaySavedItems(state.window); logMessage('ç”»åƒã¨ã‚¿ã‚°ã€æ—¥ä»˜ä¿å­˜æˆåŠŸ');
            };

            const extractTagsAndDate = () => {
                const tags = new Set(); let extractedDate = null;
                const domain = window.location.hostname;

                // ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å…ƒã®å›ºå®šã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼‰
                const defaultSelectors = {
                    tagSelector: 'div.q-chip',
                    tagContentSelector: '.q-chip__content',
                    dateSelector: 'div.absolute-bottom-right'
                };

                const customSelectors = state.elementSelectors.get(domain) || defaultSelectors;

                // ã‚¿ã‚°è¦ç´ ã®æŠ½å‡º
                document.querySelectorAll(customSelectors.tagSelector).forEach(el => {
                    let content = el;
                    if (customSelectors.tagContentSelector) {
                        content = el.querySelector(customSelectors.tagContentSelector);
                    }
                    if (content && content.textContent.trim()) {
                        const tagText = content.textContent.trim();
                        if (tagText.length > 0 && tagText.length < 20) tags.add(tagText);
                    }
                });

                // æ—¥ä»˜è¦ç´ ã®æŠ½å‡º
                const dateElement = document.querySelector(customSelectors.dateSelector);
                if (dateElement && dateElement.textContent.trim()) {
                    extractedDate = dateElement.textContent.trim();
                }

                // é™¤å¤–ã‚¿ã‚°ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const excludeTags = GM_getValue(`excludeTags-${domain}`, []);
                const filteredTags = [...tags].filter(tag => {
                    return !excludeTags.some(excludeRule => {
                        if (excludeRule.type === 'regex') {
                            try {
                                return new RegExp(excludeRule.pattern).test(tag);
                            } catch (e) {
                                return false;
                            }
                        } else {
                            return excludeRule.pattern === tag;
                        }
                    });
                });

                const excludedCount = tags.size - filteredTags.length;
                logMessage(`ã‚¿ã‚°æŠ½å‡ºå®Œäº†: ${filteredTags.length}å€‹ (${filteredTags.join(', ')}), é™¤å¤–: ${excludedCount}å€‹, æ—¥ä»˜: ${extractedDate || 'ãªã—'}`);
                return { tags: filteredTags, extractedDate };
            };

            const getFaviconForNewTab = (tab, url) => {
                const allItems = GM_getValue('savedItems', []); const existingTab = allItems.find(item => item.tab === tab);
                if (existingTab) { logMessage(`æ—¢å­˜ã‚¿ãƒ– ${tab} ã®ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã‚’å†åˆ©ç”¨`); return existingTab.favicon; }
                const favicon = document.querySelector('link[rel="icon"]')?.href || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><circle cx="8" cy="8" r="7" fill="#104437"/></svg>';
                logMessage(`ãƒ•ã‚¡ãƒ“ã‚³ãƒ³å–å¾—: ${favicon}`); return favicon;
            };

            const cleanDomainName = (domain) => {
                // Remove common prefixes like www, m, mobile, etc.
                const prefixes = ['www.', 'm.', 'mobile.', 'app.', 'api.'];
                let cleaned = domain.toLowerCase();
                for (const prefix of prefixes) {
                    if (cleaned.startsWith(prefix)) {
                        cleaned = cleaned.substring(prefix.length);
                        break;
                    }
                }
                return cleaned;
            };

            const updateTabs = (windowObj) => {
                const tabSidebar = windowObj.el.querySelector('.tabSidebar'); tabSidebar.innerHTML = '';
                const allItems = GM_getValue('savedItems', []); const autoTabs = new Set(allItems.map(item => item.tab).filter(t => !state.customTabs.has(t))); const allTabs = [...state.customTabs, ...autoTabs];
                const domainDisplayMode = GM_getValue('domainDisplayMode', false);

                allTabs.forEach(tab => {
                    const tabButton = document.createElement('button'); tabButton.className = 'tab-vertical'; tabButton.dataset.tab = tab;
                    const favicon = allItems.find(item => item.tab === tab)?.favicon;

                    // ãƒ‰ãƒ¡ã‚¤ãƒ³åè¡¨ç¤ºè¨­å®šã«å¿œã˜ã¦ã‚¿ãƒ–ã®è¡¨ç¤ºã‚’å¤‰æ›´
                    const showDomainName = state.tabDomainNames.get(tab);
                    if (showDomainName && !state.customTabs.has(tab) && !state.tabThumbnails.has(tab)) {
                        // ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’è¡¨ç¤ºï¼ˆwwwãªã©ã‚’é™¤å»ã€æ–‡å­—ã‚’å¤§ããã€ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã‚’è¿½åŠ ï¼‰
                        const cleanedDomain = cleanDomainName(tab);

                        // ãƒ‰ãƒ¡ã‚¤ãƒ³åã®ãƒ†ã‚­ã‚¹ãƒˆ
                        const domainSpan = document.createElement('span');
                        domainSpan.textContent = cleanedDomain;
                        domainSpan.style.cssText = `
                            font-size: 11px;
                            font-weight: bold;
                            color: white;
                            text-align: center;
                            line-height: 1.2;
                            word-break: break-all;
                            margin-bottom: 2px;
                        `;

                        // ãƒ•ã‚¡ãƒ“ã‚³ãƒ³
                        if (favicon) {
                            const faviconImg = document.createElement('img');
                            faviconImg.src = favicon;
                            faviconImg.style.cssText = `
                                width: 16px;
                                height: 16px;
                                border-radius: 2px;
                                margin-top: 2px;
                            `;
                            faviconImg.onerror = function() { this.style.display = 'none'; };
                            tabButton.appendChild(domainSpan);
                            tabButton.appendChild(faviconImg);
                        } else {
                            tabButton.appendChild(domainSpan);
                        }
                    } else {
                        // å¾“æ¥ã®è¡¨ç¤ºï¼ˆãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã¾ãŸã¯ã‚µãƒ ãƒã‚¤ãƒ«ï¼‰
                        if (favicon && !state.customTabs.has(tab) && !state.tabThumbnails.has(tab)) {
                            const faviconImg = document.createElement('img');
                            faviconImg.src = favicon;
                            faviconImg.onerror = function() { this.style.display = 'none'; };
                            tabButton.appendChild(faviconImg);
                        } else {
                            const span = document.createElement('span');
                            span.textContent = state.tabThumbnails.get(tab) || tab[0];
                            tabButton.appendChild(span);
                        }
                    }

                    tabButton.style.backgroundColor = state.tabColors.get(tab) || '#104437'; tabButton.title = tab;
                    events.add(tabButton, 'click', () => {
                        // å³åº§ã«UIã‚’æ›´æ–°ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–æ€§ã‚’å‘ä¸Š
                        tabSidebar.querySelectorAll('.tab-vertical').forEach(t => t.classList.remove('active'));
                        tabButton.classList.add('active');
                        bringToFront(windowObj);

                        // éåŒæœŸã§ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†ã‚’å®Ÿè¡Œ
                        requestAnimationFrame(() => {
                            windowObj.activeTab = tab;
                            GM_setValue(`activeTab-${windowObj.id}`, tab);

                            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
                            if (tab !== 'ãƒ¡ãƒ¢' && !state.customTabs.has(tab)) {
                                // ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
                                windowObj.sortOrder = GM_getValue(`sortOrder-${tab}`, 'newest');
                                windowObj.layout = GM_getValue(`layout-${tab}`, 'tile');
                                windowObj.itemSize = GM_getValue(`itemSize-${tab}`, 'standard');
                                windowObj.displayMode = GM_getValue(`displayMode-${tab}`, 'full');
                            } else {
                                // ã‚«ã‚¹ã‚¿ãƒ ã‚¿ãƒ–ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨
                                windowObj.sortOrder = GM_getValue(`sortOrder-${tab}`, 'newest');
                                windowObj.layout = GM_getValue(`layout-${tab}`, 'tile');
                                windowObj.itemSize = GM_getValue(`itemSize-${tab}`, 'standard');
                                windowObj.displayMode = GM_getValue(`displayMode-${tab}`, 'full');
                            }

                            // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚€
                            const savedSelectedTags = GM_getValue(`selectedTags-${tab}`, []);
                            windowObj.selectedTags = new Set(savedSelectedTags);

                            // é™¤å¤–ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚€ï¼ˆè¡¨ç¤ºç”¨ï¼‰
                            windowObj.excludeTags = GM_getValue(`excludeTags-${tab}`, []);

                            // ã‚¿ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’èª­ã¿è¾¼ã‚€ï¼ˆè¡¨ç¤ºç”¨ï¼‰
                            windowObj.tagGroups = GM_getValue(`tagGroups-${tab}`, {});

                            // è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã‚€
                            windowObj.multiSelectMode = GM_getValue(`multiSelectMode-${tab}`, false);

                            // UIã‚’æ›´æ–°
                            const sortSelect = windowObj.el.querySelector('.sortSelect');
                            const layoutButton = windowObj.el.querySelector('.layoutButton');
                            const itemSizeSelect = windowObj.el.querySelector('.itemSizeSelect');
                            const displayModeSelect = windowObj.el.querySelector('.displayModeSelect');
                            const multiSelectButton = windowObj.el.querySelector('.multiSelectButton');

                            if (sortSelect) sortSelect.value = windowObj.sortOrder;
                            if (layoutButton) layoutButton.textContent = windowObj.layout === 'tile' ? 'ã‚¿ã‚¤ãƒ«' : '1åˆ—';
                            if (itemSizeSelect) itemSizeSelect.value = windowObj.itemSize;
                            if (displayModeSelect) displayModeSelect.value = windowObj.displayMode;
                            if (multiSelectButton) {
                                if (windowObj.multiSelectMode) {
                                    multiSelectButton.style.background = '#e67e22';
                                    // è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã€æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
                                    const savedItems = windowObj.el.querySelector('.savedItems');
                                    if (savedItems) {
                                        savedItems.querySelectorAll('.savedItem').forEach(item => {
                                            if (!item.querySelector('.selectItem')) {
                                                const checkbox = document.createElement('input');
                                                checkbox.type = 'checkbox';
                                                checkbox.className = 'selectItem';
                                                checkbox.style.display = 'block';
                                                item.insertBefore(checkbox, item.firstChild);
                                            }
                                        });
                                        addItemClickListeners(windowObj, savedItems.querySelectorAll('.savedItem'));
                                    }
                                } else {
                                    multiSelectButton.style.background = '#104437';
                                }
                            }

                            // ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤ºã‚’éåŒæœŸã§å®Ÿè¡Œ
                            setTimeout(() => {
                                displaySavedItems(windowObj);
                                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
                                if (windowObj.isEditing) {
                                    const savedItems = windowObj.el.querySelector('.savedItems');
                                    if (savedItems) {
                                        savedItems.querySelectorAll('.savedItem').forEach(item => {
                                            if (!item.querySelector('.selectItem')) {
                                                const checkbox = document.createElement('input');
                                                checkbox.type = 'checkbox';
                                                checkbox.className = 'selectItem';
                                                checkbox.style.display = 'block';
                                                item.insertBefore(checkbox, item.firstChild);
                                            }
                                        });
                                        addItemClickListeners(windowObj, savedItems.querySelectorAll('.savedItem'));
                                    }
                                }
                                Window.saveState(windowObj);
                            }, 0);
                        });
                    });
                    tabSidebar.appendChild(tabButton);
                    if (tab === windowObj.activeTab) tabButton.classList.add('active');
                });
            };

            // ã‚¢ã‚¤ãƒ†ãƒ è¦ç´ ã‚’ä½œæˆã™ã‚‹é–¢æ•°
            const createItemElement = (item, itemsDiv, windowObj) => {
                const a = document.createElement('a');
                a.href = item.url;
                a.target = '_blank';
                a.className = `savedItem ${windowObj.layout === 'column' ? 'column' : ''} size-${windowObj.itemSize} ${windowObj.displayMode === 'image-only' ? 'image-only' : ''} ${windowObj.displayMode === 'image-title' ? 'image-title' : ''}`;
                a.dataset.timestamp = item.timestamp;

                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
                if (windowObj.isEditing || windowObj.multiSelectMode) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'selectItem';
                    checkbox.style.display = 'block';
                    a.appendChild(checkbox);
                }

                const img = document.createElement('img');
                img.src = item.image;
                img.alt = 'åœ§ç¸®ç”»åƒ';
                a.appendChild(img);

                const titleP = document.createElement('p');
                const titleStrong = document.createElement('strong');
                titleStrong.textContent = ' ';
                titleP.appendChild(titleStrong);
                titleP.appendChild(document.createTextNode(item.title));
                a.appendChild(titleP);

                // ãƒ‡ãƒ¼ã‚¿é‡ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤ºï¼ˆfullãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
                if (windowObj.displayMode === 'full') {
                    const itemData = JSON.stringify(item);
                    const totalSize = new Blob([itemData]).size;
                    const imageSize = item.image ? new Blob([item.image]).size : 0;
                    const totalSizeKB = (totalSize / 1024).toFixed(1);
                    const imageSizeKB = (imageSize / 1024).toFixed(1);

                    const dataSizeP = document.createElement('p');
                    const dataSizeStrong = document.createElement('strong');
                    dataSizeStrong.textContent = 'ãƒ‡ãƒ¼ã‚¿é‡: ';
                    dataSizeP.appendChild(dataSizeStrong);
                    dataSizeP.appendChild(document.createTextNode(`${totalSizeKB}KB (ç”»åƒ: ${imageSizeKB}KB)`));
                    a.appendChild(dataSizeP);
                }

                if (windowObj.displayMode === 'full') {
                    const urlP = document.createElement('p');
                    const urlStrong = document.createElement('strong');
                    urlStrong.textContent = 'URL: ';
                    urlP.appendChild(urlStrong);
                    const urlSpan = document.createElement('span');
                    urlSpan.textContent = 'link';
                    urlP.appendChild(urlSpan);
                    a.appendChild(urlP);

                    const tagsP = document.createElement('p');
                    const tagsStrong = document.createElement('strong');
                    tagsStrong.textContent = 'ã‚¿ã‚°: ';
                    tagsP.appendChild(tagsStrong);
                    tagsP.appendChild(document.createTextNode(item.tags ? item.tags.join(', ') : 'ãªã—'));
                    a.appendChild(tagsP);

                    const dateP = document.createElement('p');
                    const dateStrong = document.createElement('strong');
                    dateStrong.textContent = 'æŠ½å‡ºæ—¥ä»˜: ';
                    dateP.appendChild(dateStrong);
                    dateP.appendChild(document.createTextNode(item.extractedDate || 'ãªã—'));
                    a.appendChild(dateP);

                    const saveDateP = document.createElement('p');
                    const saveDateStrong = document.createElement('strong');
                    saveDateStrong.textContent = 'ä¿å­˜æ—¥æ™‚: ';
                    saveDateP.appendChild(saveDateStrong);
                    saveDateP.appendChild(document.createTextNode(new Date(item.timestamp).toLocaleString()));
                    a.appendChild(saveDateP);
                }

                itemsDiv.appendChild(a);
            };

            const displaySavedItems = (windowObj) => {
                const savedItems = GM_getValue('savedItems', []).filter(item => item.tab === windowObj.activeTab); let sortedItems = [...savedItems];
                if (windowObj.sortOrder === 'newest') sortedItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                else if (windowObj.sortOrder === 'oldest') sortedItems.sort((a, b) => new Date(a.timestamp) - new Date(a.timestamp));
                else if (windowObj.sortOrder === 'extractedDateOldest') { const itemsWithDate = sortedItems.filter(item => item.extractedDate); const itemsWithoutDate = sortedItems.filter(item => !item.extractedDate); itemsWithDate.sort((a, b) => new Date(a.extractedDate) - new Date(b.extractedDate)); sortedItems = [...itemsWithDate, ...itemsWithoutDate]; }
                else if (windowObj.sortOrder === 'extractedDateNewest') { const itemsWithDate = sortedItems.filter(item => item.extractedDate); const itemsWithoutDate = sortedItems.filter(item => !item.extractedDate); itemsWithDate.sort((a, b) => new Date(b.extractedDate) - new Date(a.extractedDate)); sortedItems = [...itemsWithDate, ...itemsWithoutDate]; }

                // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const selectedTags = windowObj.selectedTags || new Set();
                if (selectedTags.size > 0) {
                    sortedItems = sortedItems.filter(item => {
                        if (!item.tags || !Array.isArray(item.tags)) return false;
                        return Array.from(selectedTags).every(tag => item.tags.includes(tag));
                    });
                }

                const itemsDiv = windowObj.el.querySelector('.savedItems');
                itemsDiv.className = `savedItems ${windowObj.layout === 'column' ? 'column' : ''}`;
                itemsDiv.innerHTML = '';

                // å¤§é‡ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚‹å ´åˆã¯ãƒãƒƒãƒå‡¦ç†ã§è¡¨ç¤º
                const batchSize = 50;
                const totalItems = sortedItems.length;

                if (totalItems > batchSize) {
                    // æœ€åˆã®ãƒãƒƒãƒã‚’å³åº§ã«è¡¨ç¤º
                    const firstBatch = sortedItems.slice(0, batchSize);
                    firstBatch.forEach(item => createItemElement(item, itemsDiv, windowObj));

                    // æ®‹ã‚Šã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’éåŒæœŸã§è¡¨ç¤º
                    if (totalItems > batchSize) {
                        let currentIndex = batchSize;

                        const processNextBatch = () => {
                            const endIndex = Math.min(currentIndex + batchSize, totalItems);
                            const batch = sortedItems.slice(currentIndex, endIndex);

                            batch.forEach(item => createItemElement(item, itemsDiv, windowObj));

                            currentIndex = endIndex;

                            if (currentIndex < totalItems) {
                                // æ¬¡ã®ãƒãƒƒãƒã‚’éåŒæœŸã§å‡¦ç†
                                requestAnimationFrame(processNextBatch);
                            } else {
                                // ã™ã¹ã¦å®Œäº†ã—ãŸã‚‰ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
                                setTimeout(() => {
                                    updateTagFilterButtons(windowObj);
                                }, 0);
                            }
                        };

                        // æœ€åˆã®ãƒãƒƒãƒå‡¦ç†ã‚’é–‹å§‹
                        setTimeout(processNextBatch, 0);
                    }
                } else {
                    // ã‚¢ã‚¤ãƒ†ãƒ æ•°ãŒå°‘ãªã„å ´åˆã¯é€šå¸¸é€šã‚Šå‡¦ç†
                    sortedItems.forEach(item => createItemElement(item, itemsDiv, windowObj));

                    // ã‚¿ã‚°ãƒœã‚¿ãƒ³ã‚’æ›´æ–°ï¼ˆé…å»¶å®Ÿè¡Œã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰
                    setTimeout(() => {
                        updateTagFilterButtons(windowObj);
                    }, 0);
                }
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã«å¿œã˜ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                if (windowObj.isEditing || windowObj.multiSelectMode) {
                    addItemClickListeners(windowObj, itemsDiv.querySelectorAll('.savedItem'));
                } else {
                    itemsDiv.querySelectorAll('.savedItem').forEach(item => item.style.cursor = 'pointer');
                }

            };

            // ã‚¢ã‚¤ãƒ†ãƒ ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            const addItemClickListeners = (windowObj, items) => {
                items.forEach(item => {
                    events.removeAll(item); // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
                    item.style.cursor = 'pointer';
                    events.add(item, 'click', (e) => {
                        if (windowObj.isEditing || windowObj.multiSelectMode) {
                            e.preventDefault();
                            const checkbox = item.querySelector('.selectItem');
                            if (checkbox) {
                                checkbox.checked = !checkbox.checked;
                                item.classList.toggle('selected', checkbox.checked);
                                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                                item.animate([
                                    { transform: 'scale(1)', backgroundColor: '#104437' },
                                    { transform: 'scale(1.05)', backgroundColor: '#16a085' },
                                    { transform: 'scale(1)', backgroundColor: '#104437' }
                                ], {
                                    duration: 200,
                                    easing: 'ease-in-out'
                                });
                                logMessage(`ã‚¢ã‚¤ãƒ†ãƒ ã‚¯ãƒªãƒƒã‚¯: timestamp=${item.dataset.timestamp}, é¸æŠçŠ¶æ…‹=${checkbox.checked}`);
                            }
                        } else {
                            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒªãƒ³ã‚¯ã¨ã—ã¦å‹•ä½œ
                            const url = item.href;
                            if (url) {
                                window.open(url, '_blank');
                            }
                        }
                    });
                });
            };
            const createLogWindow = () => {
                let existingWindow = document.querySelector('#logWindow'); if (existingWindow) existingWindow.remove();
                const logWindow = document.createElement('div'); logWindow.id = 'logWindow';
                const menuBar = document.createElement('div'); menuBar.className = 'menuBar';
                const title = document.createElement('h3'); title.textContent = 'log';
                const closeBtn = document.createElement('button'); closeBtn.className = 'closeLog'; closeBtn.textContent = 'Ã—';
                menuBar.append(title, closeBtn);
                const logContent = document.createElement('div'); logContent.id = 'logContent';
                logWindow.append(menuBar, logContent);
                document.body.appendChild(logWindow);

                const toolbar = document.getElementById('toolbar'); if (toolbar) { logWindow.style.left = `${toolbar.offsetLeft / window.innerWidth * 100}vw`; logWindow.style.top = `${(toolbar.offsetTop + toolbar.offsetHeight + 10) / window.innerHeight * 100}vh`; }
                const debugOutput = document.getElementById('debugOutput'); if (debugOutput) { debugOutput.querySelectorAll('p').forEach(p => { const logP = document.createElement('p'); logP.textContent = p.textContent; logContent.appendChild(logP); }); logContent.scrollTop = logContent.scrollHeight; }
                let isDragging = false, offsetX, offsetY;
                const handleMouseMove = (e) => { if (isDragging) { let leftPx = e.clientX - offsetX; let topPx = e.clientY - offsetY; let widthPx = logWindow.offsetWidth; let heightPx = logWindow.offsetHeight; leftPx = Math.max(0, Math.min(leftPx, window.innerWidth - widthPx)); topPx = Math.max(0, Math.min(topPx, window.innerHeight - heightPx)); requestAnimationFrame(() => { logWindow.style.left = `${leftPx}px`; logWindow.style.top = `${topPx}px`; }); } };
                const handleMouseUp = () => { if (isDragging) { isDragging = false; document.removeEventListener('mousemove', handleMouseMove); document.removeEventListener('mouseup', handleMouseUp); } };
                events.add(menuBar, 'mousedown', (e) => { if (e.target.tagName !== 'BUTTON') { isDragging = true; offsetX = e.clientX - logWindow.offsetLeft; offsetY = e.clientY - logWindow.offsetTop; e.preventDefault(); document.addEventListener('mousemove', handleMouseMove); document.addEventListener('mouseup', handleMouseUp); } });
                events.add(closeBtn, 'click', () => logWindow.remove());
                bringToFrontPopup(logWindow);
            };

            const createMoveTabWindow = (parentWindow, checkboxes) => {
                if (state.activePopup) { state.activePopup.remove(); state.activePopup = null; }
                const moveTabDiv = document.createElement('div'); moveTabDiv.className = 'moveTabPopup';
                const menuBar = document.createElement('div'); menuBar.className = 'menuBar';
                const title = document.createElement('h3'); title.textContent = `ã‚¿ãƒ–ç§»å‹• - ${parentWindow.name}`;
                const closeBtn = document.createElement('button'); closeBtn.className = 'closeMoveTab'; closeBtn.textContent = 'Ã—';
                menuBar.append(title, closeBtn);
                const content = document.createElement('div'); content.className = 'moveTabContent'; content.style.padding = '10px';
                moveTabDiv.append(menuBar, content);
                document.body.appendChild(moveTabDiv);
                state.activePopup = moveTabDiv;
                bringToFrontPopup(moveTabDiv);

                const allItems = GM_getValue('savedItems', []); const autoTabs = new Set(allItems.map(item => item.tab).filter(t => !state.customTabs.has(t))); const allTabs = [...state.customTabs, ...autoTabs];
                allTabs.forEach(tab => {
                    const btn = document.createElement('button'); btn.textContent = tab;
                    events.add(btn, 'click', () => {
                        let allItems = GM_getValue('savedItems', []);
                        checkboxes.forEach(cb => { const timestamp = cb.parentElement.dataset.timestamp; const item = allItems.find(i => i.timestamp === timestamp); if (item) item.tab = tab; });
                        GM_setValue('savedItems', allItems); displaySavedItems(parentWindow); moveTabDiv.remove(); state.activePopup = null;
                    });
                    content.appendChild(btn);
                });
                events.add(closeBtn, 'click', () => { moveTabDiv.remove(); state.activePopup = null; });
                return moveTabDiv;
            };

            const createTabManageWindow = (parentWindow) => {
                // æ—¢å­˜ã®ã‚¿ãƒ–ç®¡ç†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒã‚ã‚Œã°é–‰ã˜ã‚‹
                if (state.activePopup && state.activePopup.className === 'tabManagePopup') {
                    state.activePopup.remove();
                    state.activePopup = null;
                    return;
                }
                if (state.activePopup) { state.activePopup.remove(); state.activePopup = null; }

                const tabManageDiv = document.createElement('div');
                tabManageDiv.className = 'tabManagePopup';
                tabManageDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 500px;
                    height: 600px;
                    background: #0a1f2e;
                    border: 2px solid #104437;
                    border-radius: 10px;
                    z-index: 20000;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    font-family: sans-serif;
                    color: white;
                `;

                const menuBar = document.createElement('div');
                menuBar.className = 'menuBar';
                menuBar.style.cssText = `
                    background: #104437;
                    padding: 10px 15px;
                    border-radius: 8px 8px 0 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    cursor: move;
                    user-select: none;
                `;

                const title = document.createElement('h3');
                title.textContent = `ã‚¿ãƒ–ç®¡ç† - ${parentWindow.activeTab}`;
                title.style.cssText = `
                    margin: 0;
                    font-size: 16px;
                    font-weight: bold;
                    color: white;
                `;

                const closeBtn = document.createElement('button');
                closeBtn.className = 'closeTabManage';
                closeBtn.textContent = 'Ã—';
                closeBtn.style.cssText = `
                    background: #e74c3c;
                            color: white;
                            border: none;
                    border-radius: 50%;
                    width: 25px;
                    height: 25px;
                            cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                menuBar.append(title, closeBtn);

                const content = document.createElement('div');
                content.className = 'tabManageContent';
                content.style.cssText = `
                    padding: 15px;
                    flex: 1;
                    overflow-y: auto;
                    background: #0a1f2e;
                `;

                // ã‚¿ãƒ–è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                const addSection = document.createElement('div');
                addSection.style.cssText = `
                    margin-bottom: 20px;
                    padding: 15px;
                    background: #1a2f3e;
                    border-radius: 8px;
                    border: 1px solid #104437;
                `;

                const addTitle = document.createElement('h4');
                addTitle.textContent = 'ğŸ“ æ–°è¦ã‚¿ãƒ–è¿½åŠ ';
                addTitle.style.cssText = `
                    margin: 0 0 15px 0;
                    font-size: 14px;
                    font-weight: bold;
                    color: #16a085;
                `;

                const addForm = document.createElement('div');
                addForm.style.cssText = `
                    display: flex;
                    gap: 10px;
                    align-items: center;
                `;

                        const label = document.createElement('label');
                        label.textContent = 'ã‚¿ãƒ–å: ';
                label.style.cssText = `
                    color: #ccc;
                    font-size: 12px;
                    white-space: nowrap;
                `;

                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = 'tabNameInput';
                input.placeholder = 'æ–°è¦ã‚¿ãƒ–åã‚’å…¥åŠ›';
                input.style.cssText = `
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid #104437;
                    border-radius: 5px;
                    background: #0a1f2e;
                    color: white;
                    font-size: 12px;
                `;

                        const addBtn = document.createElement('button');
                        addBtn.id = 'addTabConfirm';
                        addBtn.textContent = 'è¿½åŠ ';
                addBtn.style.cssText = `
                    background: #16a085;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: bold;
                    transition: background-color 0.2s;
                `;

                addForm.append(label, input, addBtn);
                addSection.append(addTitle, addForm);

                // ã‚¿ãƒ–è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³
                const settingsSection = document.createElement('div');
                settingsSection.style.cssText = `
                    margin-bottom: 20px;
                    padding: 15px;
                    background: #1a2f3e;
                    border-radius: 8px;
                    border: 1px solid #104437;
                `;

                        const settingsTitle = document.createElement('h4');
                settingsTitle.textContent = 'âš™ï¸ ã‚¿ãƒ–è¨­å®š';
                settingsTitle.style.cssText = `
                    margin: 0 0 15px 0;
                    font-size: 14px;
                    font-weight: bold;
                    color: #16a085;
                `;

                        const settingsDiv = document.createElement('div');
                        settingsDiv.id = 'tabSettings';
                settingsDiv.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                `;

                settingsSection.append(settingsTitle, settingsDiv);

                content.append(addSection, settingsSection);

                        const allItems = GM_getValue('savedItems', []);
                        const autoTabs = new Set(allItems.map(item => item.tab).filter(t => !state.customTabs.has(t)));
                        const allTabs = [...state.customTabs, ...autoTabs];

                        allTabs.forEach(tab => {
                    const tabDiv = document.createElement('div');
                    tabDiv.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 12px;
                        background: #0a1f2e;
                        border: 1px solid #104437;
                        border-radius: 8px;
                        margin-bottom: 8px;
                    `;

                    const tabInfo = document.createElement('div');
                    tabInfo.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        flex: 1;
                    `;

                            const favicon = allItems.find(item => item.tab === tab)?.favicon;
                    const iconDiv = document.createElement('div');
                    iconDiv.style.cssText = `
                        width: 24px;
                        height: 24px;
                        border-radius: 4px;
                        background: ${state.tabColors.get(tab) || '#104437'};
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        color: white;
                        flex-shrink: 0;
                    `;

                    if (favicon && !state.customTabs.has(tab) && !state.tabThumbnails.has(tab)) {
                        const img = document.createElement('img');
                        img.src = favicon;
                        img.style.cssText = 'width: 16px; height: 16px; border-radius: 2px;';
                        img.onerror = () => {
                            iconDiv.textContent = tab[0];
                        };
                        iconDiv.appendChild(img);
                    } else {
                        iconDiv.textContent = state.tabThumbnails.get(tab) || tab[0];
                    }

                    const tabName = document.createElement('span');
                    tabName.textContent = tab;
                    tabName.style.cssText = `
                        color: white;
                        font-size: 13px;
                        font-weight: 500;
                    `;

                    tabInfo.append(iconDiv, tabName);

                    const buttonGroup = document.createElement('div');
                    buttonGroup.style.cssText = `
                        display: flex;
                        gap: 5px;
                    `;

                    const colorBtn = document.createElement('button');
                    colorBtn.textContent = 'ğŸ¨';
                    colorBtn.title = 'è‰²ã‚’å¤‰æ›´';
                    colorBtn.style.cssText = `
                        background: #3498db;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        width: 30px;
                        height: 30px;
                        cursor: pointer;
                        font-size: 12px;
                        transition: background-color 0.2s;
                    `;
                    events.add(colorBtn, 'click', () => setupTabColorMenu(tab, iconDiv, settingsDiv));

                    const thumbnailBtn = document.createElement('button');
                    thumbnailBtn.textContent = 'ğŸ–¼ï¸';
                    thumbnailBtn.title = 'ã‚µãƒ ãƒã‚¤ãƒ«ã‚’å¤‰æ›´';
                    thumbnailBtn.style.cssText = `
                        background: #9b59b6;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        width: 30px;
                        height: 30px;
                        cursor: pointer;
                        font-size: 12px;
                        transition: background-color 0.2s;
                    `;
                    events.add(thumbnailBtn, 'click', () => setupTabThumbnailMenu(tab, iconDiv, favicon, settingsDiv));

                    const domainNameBtn = document.createElement('button');
                    domainNameBtn.textContent = 'ğŸŒ';
                    domainNameBtn.title = 'ãƒ‰ãƒ¡ã‚¤ãƒ³åè¡¨ç¤ºè¨­å®š';
                    domainNameBtn.style.cssText = `
                        background: ${state.tabDomainNames.get(tab) ? '#27ae60' : '#95a5a6'};
                        color: white;
                        border: none;
                        border-radius: 4px;
                        width: 30px;
                        height: 30px;
                        cursor: pointer;
                        font-size: 12px;
                        transition: background-color 0.2s;
                    `;
                    events.add(domainNameBtn, 'click', () => setupTabDomainNameMenu(tab, domainNameBtn, settingsDiv));

                            const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'ğŸ—‘ï¸';
                    deleteBtn.title = 'ã‚¿ãƒ–ã‚’å‰Šé™¤';
                    deleteBtn.style.cssText = `
                        background: #e74c3c;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        width: 30px;
                        height: 30px;
                        cursor: pointer;
                        font-size: 12px;
                        transition: background-color 0.2s;
                    `;
                            events.add(deleteBtn, 'click', () => {
                                if (confirm(`${tab}ã‚¿ãƒ–ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆé–¢é€£ã‚¢ã‚¤ãƒ†ãƒ ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)) {
                                    if (state.customTabs.has(tab)) {
                                        state.customTabs.delete(tab);
                                        state.updateCustomTabs([...state.customTabs]);
                                    }
                                    const updatedItems = allItems.filter(item => item.tab !== tab);
                                    GM_setValue('savedItems', updatedItems);
                                    state.tabColors.delete(tab);
                                    state.tabThumbnails.delete(tab);
                                    state.tabDomainNames.delete(tab);
                                    if (parentWindow.activeTab === tab) parentWindow.activeTab = state.customTabs.values().next().value || '';
                                    updateTabs(parentWindow);
                            tabDiv.remove();
                        }
                    });

                    buttonGroup.append(colorBtn, thumbnailBtn, domainNameBtn, deleteBtn);
                    tabDiv.append(tabInfo, buttonGroup);
                    settingsDiv.appendChild(tabDiv);
                        });

                        const handleAddTab = () => {
                            const tabName = input.value;
                            if (tabName && !state.customTabs.has(tabName)) {
                                state.customTabs.add(tabName);
                                state.updateCustomTabs([...state.customTabs]);
                                updateTabs(parentWindow);
                        cleanupTabManage(tabManageDiv);
                            }
                        };

                        events.add(addBtn, 'click', handleAddTab);
                events.add(closeBtn, 'click', () => cleanupTabManage(tabManageDiv));

                // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¿½åŠ 
                let isDragging = false;
                let offsetX, offsetY;

                const handleMouseMove = (e) => {
                    if (isDragging) {
                        let leftPx = e.clientX - offsetX;
                        let topPx = e.clientY - offsetY;
                        let widthPx = tabManageDiv.offsetWidth;
                        let heightPx = tabManageDiv.offsetHeight;

                        leftPx = Math.max(0, Math.min(leftPx, window.innerWidth - widthPx));
                        topPx = Math.max(0, Math.min(topPx, window.innerHeight - heightPx));

                        requestAnimationFrame(() => {
                            tabManageDiv.style.left = `${leftPx}px`;
                            tabManageDiv.style.top = `${topPx}px`;
                            tabManageDiv.style.transform = 'none';
                        });
                    }
                };

                const handleMouseUp = () => {
                    if (isDragging) {
                        isDragging = false;
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    }
                };

                events.add(menuBar, 'mousedown', (e) => {
                    if (e.target === closeBtn) return; // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã§ã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ãªã„
                    isDragging = true;
                    // ç¾åœ¨ã®ä½ç½®ã‚’å–å¾—ï¼ˆtransformã‚’è€ƒæ…®ï¼‰
                    const rect = tabManageDiv.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;
                    e.preventDefault();
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });

                // ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼åŠ¹æœã‚’è¿½åŠ 
                events.add(addBtn, 'mouseenter', () => {
                    addBtn.style.background = '#1abc9c';
                });
                events.add(addBtn, 'mouseleave', () => {
                    addBtn.style.background = '#16a085';
                });

                tabManageDiv.append(menuBar, content);
                document.body.appendChild(tabManageDiv);
                state.activePopup = tabManageDiv;
                bringToFrontPopup(tabManageDiv);

                return tabManageDiv;
            };

            const setupTabColorMenu = (tab, div, settingsDiv) => {
                const colorMenu = document.createElement('div'); colorMenu.className = 'tabMenu';
                colorMenu.style.position = 'absolute'; colorMenu.style.left = `${div.offsetLeft + div.offsetWidth}px`; colorMenu.style.top = `${div.offsetTop}px`;
                Window.colorPresets.forEach((color, name) => {
                    const btn = document.createElement('button'); btn.textContent = name; btn.style.backgroundColor = color;
                    events.add(btn, 'click', () => { state.setTabColor(tab, color); div.style.backgroundColor = color; updateTabs(state.window); colorMenu.remove(); });
                    colorMenu.appendChild(btn);
                });
                const resetColorBtn = document.createElement('button'); resetColorBtn.textContent = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²ã«æˆ»ã™';
                events.add(resetColorBtn, 'click', () => { state.tabColors.delete(tab); GM_setValue('tabColors', Object.fromEntries(state.tabColors)); div.style.backgroundColor = '#104437'; updateTabs(state.window); colorMenu.remove(); });
                colorMenu.appendChild(resetColorBtn);
                settingsDiv.appendChild(colorMenu);
            };

            const setupTabDomainNameMenu = (tab, btn, settingsDiv) => {
                const domainMenu = document.createElement('div');
                domainMenu.className = 'tabMenu';
                domainMenu.style.cssText = `
                    position: absolute;
                    left: ${btn.offsetLeft + btn.offsetWidth}px;
                    top: ${btn.offsetTop}px;
                    background: #1a2f3e;
                    border: 1px solid #104437;
                    border-radius: 8px;
                    padding: 10px;
                    z-index: 20001;
                    min-width: 200px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                `;

                const title = document.createElement('div');
                title.textContent = 'ãƒ‰ãƒ¡ã‚¤ãƒ³åè¡¨ç¤ºè¨­å®š';
                title.style.cssText = `
                    font-weight: bold;
                    color: #16a085;
                    margin-bottom: 10px;
                    font-size: 12px;
                `;
                domainMenu.appendChild(title);

                const currentSetting = state.tabDomainNames.get(tab);

                const enableBtn = document.createElement('button');
                enableBtn.textContent = 'âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’è¡¨ç¤º';
                enableBtn.style.cssText = `
                    display: block;
                    width: 100%;
                    padding: 8px 12px;
                    margin-bottom: 5px;
                    background: ${currentSetting ? '#27ae60' : '#34495e'};
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 11px;
                    text-align: left;
                `;
                events.add(enableBtn, 'click', () => {
                    state.setTabDomainName(tab, true);
                    btn.style.background = '#27ae60';
                    updateTabs(state.window);
                    domainMenu.remove();
                });

                const disableBtn = document.createElement('button');
                disableBtn.textContent = 'âŒ ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã®ã¿è¡¨ç¤º';
                disableBtn.style.cssText = `
                    display: block;
                    width: 100%;
                    padding: 8px 12px;
                    background: ${!currentSetting ? '#e74c3c' : '#34495e'};
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 11px;
                    text-align: left;
                `;
                events.add(disableBtn, 'click', () => {
                    state.setTabDomainName(tab, false);
                    btn.style.background = '#95a5a6';
                    updateTabs(state.window);
                    domainMenu.remove();
                });

                const resetBtn = document.createElement('button');
                resetBtn.textContent = 'ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™';
                resetBtn.style.cssText = `
                    display: block;
                    width: 100%;
                    padding: 8px 12px;
                    margin-top: 5px;
                    background: #f39c12;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 11px;
                    text-align: left;
                `;
                events.add(resetBtn, 'click', () => {
                    state.tabDomainNames.delete(tab);
                    GM_setValue('tabDomainNames', Object.fromEntries(state.tabDomainNames));
                    btn.style.background = '#95a5a6';
                    updateTabs(state.window);
                    domainMenu.remove();
                });

                domainMenu.append(title, enableBtn, disableBtn, resetBtn);
                settingsDiv.appendChild(domainMenu);

                // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
                setTimeout(() => {
                    const closeMenu = (e) => {
                        if (!domainMenu.contains(e.target) && !btn.contains(e.target)) {
                            domainMenu.remove();
                            document.removeEventListener('click', closeMenu);
                        }
                    };
                    document.addEventListener('click', closeMenu);
                }, 0);
            };

            const setupTabThumbnailMenu = (tab, div, favicon, settingsDiv) => {
                const thumbMenu = document.createElement('div'); thumbMenu.className = 'tabMenu';
                thumbMenu.style.position = 'absolute'; thumbMenu.style.left = `${div.offsetLeft + div.offsetWidth}px`; thumbMenu.style.top = `${div.offsetTop}px`;
                Window.thumbnailPresets.forEach(emoji => {
                    const btn = document.createElement('button'); btn.textContent = emoji;
                    events.add(btn, 'click', () => { state.setTabThumbnail(tab, emoji); div.innerHTML = `<span>${emoji}</span>`; updateTabs(state.window); thumbMenu.remove(); });
                    thumbMenu.appendChild(btn);
                });
                const resetBtn = document.createElement('button'); resetBtn.textContent = 'å…ƒã®ãƒ•ã‚¡ãƒ“ã‚³ãƒ³';
                events.add(resetBtn, 'click', () => { state.tabThumbnails.delete(tab); GM_setValue('tabThumbnails', Object.fromEntries(state.tabThumbnails)); div.innerHTML = favicon && !state.customTabs.has(tab) ? `<img src="${favicon}" width="16" height="16">` : `<span>${tab[0]}</span>`; updateTabs(state.window); thumbMenu.remove(); });
                thumbMenu.appendChild(resetBtn);
                settingsDiv.appendChild(thumbMenu);
            };

            const cleanupTabManage = (tabManageDiv) => { tabManageDiv.querySelectorAll('button').forEach(btn => btn.replaceWith(btn.cloneNode(true))); tabManageDiv.remove(); state.activePopup = null; };

            const bringToFront = (windowObj) => { state.zIndexCounter++; if (state.activePopup && state.zIndexCounter >= parseInt(state.activePopup.style.zIndex)) state.zIndexCounter = parseInt(state.activePopup.style.zIndex) + 1; windowObj.el.style.zIndex = state.zIndexCounter; };

            const bringToFrontPopup = (popup) => { state.zIndexCounter = Math.max(state.zIndexCounter + 1, 20000); popup.style.zIndex = state.zIndexCounter; };

            const addCloseOnClickOutside = (menu, menuBar) => {
                const closeMenu = (e) => { logMessage(`å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥: target=${e.target.tagName}, menuBar=${menuBar.contains(e.target)}, menu=${menu.contains(e.target)}`); setTimeout(() => { if (!menuBar.contains(e.target) && !menu.contains(e.target)) { logMessage('ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã¾ã™'); closeActiveMenu(); state.isHoverEnabled = false; document.removeEventListener('click', closeMenu); } }, 0); };
                document.addEventListener('click', closeMenu); menu.addEventListener('remove', () => { document.removeEventListener('click', closeMenu); logMessage('ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‰Šé™¤ã«ä¼´ã„ãƒªã‚¹ãƒŠãƒ¼è§£é™¤'); }, { once: true });
            };

            const closeActiveMenu = () => { if (state.activeMenu) { state.activeMenu.remove(); state.activeMenu = null; } };

            const createElementEditWindow = (windowObj) => {
                // æ—¢å­˜ã®è¦ç´ ç·¨é›†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒã‚ã‚Œã°é–‰ã˜ã‚‹
                if (state.activePopup && state.activePopup.className === 'elementEditPopup') {
                    state.activePopup.remove();
                    state.activePopup = null;
                    return;
                }
                if (state.activePopup) { state.activePopup.remove(); state.activePopup = null; }

                const elementEditDiv = document.createElement('div'); elementEditDiv.className = 'elementEditPopup';
                const menuBar = document.createElement('div'); menuBar.className = 'menuBar';
                const title = document.createElement('h3'); title.textContent = `è¦ç´ ç·¨é›† - ${windowObj.activeTab}`;

                const closeBtn = document.createElement('button'); closeBtn.className = 'closeElementEdit'; closeBtn.textContent = 'Ã—';
                menuBar.append(title, closeBtn);

                const content = document.createElement('div'); content.className = 'elementEditContent'; content.style.padding = '15px';

                const domain = windowObj.activeTab;
                const defaultSelectors = {
                    tagSelector: 'div.q-chip',
                    tagContentSelector: '.q-chip__content',
                    dateSelector: 'div.absolute-bottom-right'
                };

                const currentSelectors = state.elementSelectors.get(domain) || defaultSelectors;

                // ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                const editSection = document.createElement('div'); editSection.style.marginBottom = '20px';
                const editTitle = document.createElement('h4'); editTitle.textContent = 'ğŸ”§ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ç·¨é›†'; editTitle.style.marginBottom = '10px';

                // ã‚¿ã‚°è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ç·¨é›†
                const tagEditSection = document.createElement('div'); tagEditSection.style.marginBottom = '15px';
                const tagEditTitle = document.createElement('h5'); tagEditTitle.textContent = 'ğŸ“Œ ã‚¿ã‚°è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼'; tagEditTitle.style.marginBottom = '8px';

                const tagSelectorDiv = document.createElement('div'); tagSelectorDiv.style.marginBottom = '10px';
                const tagSelectorLabel = document.createElement('label'); tagSelectorLabel.textContent = 'ã‚¿ã‚°è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼:'; tagSelectorLabel.style.display = 'block'; tagSelectorLabel.style.marginBottom = '5px';
                const tagSelectorInput = document.createElement('input'); tagSelectorInput.type = 'text'; tagSelectorInput.value = currentSelectors.tagSelector; tagSelectorInput.style.width = '100%'; tagSelectorInput.style.padding = '5px'; tagSelectorInput.style.fontFamily = 'monospace';

                const tagContentSelectorDiv = document.createElement('div'); tagContentSelectorDiv.style.marginBottom = '10px';
                const tagContentSelectorLabel = document.createElement('label'); tagContentSelectorLabel.textContent = 'ã‚¿ã‚°å†…å®¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:'; tagContentSelectorLabel.style.display = 'block'; tagContentSelectorLabel.style.marginBottom = '5px';
                const tagContentSelectorInput = document.createElement('input'); tagContentSelectorInput.type = 'text'; tagContentSelectorInput.value = currentSelectors.tagContentSelector || ''; tagContentSelectorInput.style.width = '100%'; tagContentSelectorInput.style.padding = '5px'; tagContentSelectorInput.style.fontFamily = 'monospace';

                tagSelectorDiv.append(tagSelectorLabel, tagSelectorInput);
                tagContentSelectorDiv.append(tagContentSelectorLabel, tagContentSelectorInput);
                tagEditSection.append(tagEditTitle, tagSelectorDiv, tagContentSelectorDiv);

                // æ—¥ä»˜è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ç·¨é›†
                const dateEditSection = document.createElement('div'); dateEditSection.style.marginBottom = '15px';
                const dateEditTitle = document.createElement('h5'); dateEditTitle.textContent = 'ğŸ“… æ—¥ä»˜è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼'; dateEditTitle.style.marginBottom = '8px';

                const dateSelectorDiv = document.createElement('div'); dateSelectorDiv.style.marginBottom = '10px';
                const dateSelectorLabel = document.createElement('label'); dateSelectorLabel.textContent = 'æ—¥ä»˜è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼:'; dateSelectorLabel.style.display = 'block'; dateSelectorLabel.style.marginBottom = '5px';
                const dateSelectorInput = document.createElement('input'); dateSelectorInput.type = 'text'; dateSelectorInput.value = currentSelectors.dateSelector; dateSelectorInput.style.width = '100%'; dateSelectorInput.style.padding = '5px'; dateSelectorInput.style.fontFamily = 'monospace';

                dateSelectorDiv.append(dateSelectorLabel, dateSelectorInput);
                dateEditSection.append(dateEditTitle, dateSelectorDiv);

                // ä¿å­˜ãƒ»ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
                const buttonSection = document.createElement('div'); buttonSection.style.display = 'flex'; buttonSection.style.gap = '10px'; buttonSection.style.marginBottom = '20px';

                const saveBtn = document.createElement('button'); saveBtn.textContent = 'ğŸ’¾ ä¿å­˜'; saveBtn.style.padding = '8px 15px'; saveBtn.style.background = '#27ae60'; saveBtn.style.color = 'white'; saveBtn.style.border = 'none'; saveBtn.style.borderRadius = '5px'; saveBtn.style.cursor = 'pointer';
                const resetBtn = document.createElement('button'); resetBtn.textContent = 'ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™'; resetBtn.style.padding = '8px 15px'; resetBtn.style.background = '#e67e22'; resetBtn.style.color = 'white'; resetBtn.style.border = 'none'; resetBtn.style.borderRadius = '5px'; resetBtn.style.cursor = 'pointer';
                const testBtn = document.createElement('button'); testBtn.textContent = 'ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'; testBtn.style.padding = '8px 15px'; testBtn.style.background = '#3498db'; testBtn.style.color = 'white'; testBtn.style.border = 'none'; testBtn.style.borderRadius = '5px'; testBtn.style.cursor = 'pointer';

                buttonSection.append(saveBtn, resetBtn, testBtn);

                // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã§ã®è¦ç´ æ¤œè¨¼
                const verificationSection = document.createElement('div'); verificationSection.style.marginBottom = '20px';
                const verificationTitle = document.createElement('h4'); verificationTitle.textContent = 'ğŸ” ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã§ã®è¦ç´ æ¤œè¨¼'; verificationTitle.style.marginBottom = '10px';

                const verificationInfo = document.createElement('div'); verificationInfo.style.cssText = 'background: #0a1f2e; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 11px; line-height: 1.4;';

                // å®Ÿéš›ã®è¦ç´ ã‚’æ¤œè¨¼
                const tagElements = document.querySelectorAll(currentSelectors.tagSelector);
                const dateElement = document.querySelector(currentSelectors.dateSelector);

                let verificationDetails = '';

                // ã‚¿ã‚°è¦ç´ ã®æ¤œè¨¼
                verificationDetails += `ã‚¿ã‚°è¦ç´  (${currentSelectors.tagSelector}):\n`;
                verificationDetails += `  è¦‹ã¤ã‹ã£ãŸè¦ç´ æ•°: ${tagElements.length}å€‹\n`;

                if (tagElements.length > 0) {
                    verificationDetails += `  æœ€åˆã®3ã¤ã®è¦ç´ :\n`;
                    Array.from(tagElements).slice(0, 3).forEach((el, index) => {
                        let content = el;
                        if (currentSelectors.tagContentSelector) {
                            content = el.querySelector(currentSelectors.tagContentSelector);
                        }
                        const text = content ? content.textContent.trim() : 'å†…å®¹ãªã—';
                        verificationDetails += `    ${index + 1}. "${text}"\n`;
                    });
                }

                verificationDetails += `\næ—¥ä»˜è¦ç´  (${currentSelectors.dateSelector}):\n`;
                if (dateElement) {
                    verificationDetails += `  è¦‹ã¤ã‹ã£ãŸ: ã¯ã„\n`;
                    verificationDetails += `  å†…å®¹: "${dateElement.textContent.trim()}"\n`;
                } else {
                    verificationDetails += `  è¦‹ã¤ã‹ã£ãŸ: ã„ã„ãˆ\n`;
                }

                verificationInfo.textContent = verificationDetails;
                verificationSection.append(verificationTitle, verificationInfo);

                // èª¬æ˜æ–‡
                const descriptionSection = document.createElement('div'); descriptionSection.style.marginBottom = '20px';
                const descriptionTitle = document.createElement('h4'); descriptionTitle.textContent = 'â„¹ï¸ èª¬æ˜'; descriptionTitle.style.marginBottom = '10px';
                const descriptionText = document.createElement('div'); descriptionText.style.cssText = 'background: #0a1f2e; padding: 10px; border-radius: 5px; font-size: 12px; line-height: 1.4; color: #95a5a6;';

                descriptionText.innerHTML = `
    ç¾åœ¨ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ç·¨é›†ã§ãã¾ã™ã€‚<br>
    â€¢ ã‚¿ã‚°è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼: ã‚¿ã‚°ã‚’å«ã‚€è¦ç´ ã‚’æŒ‡å®š<br>
    â€¢ ã‚¿ã‚°å†…å®¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼: ã‚¿ã‚°è¦ç´ å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å«ã‚€è¦ç´ ã‚’æŒ‡å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰<br>
    â€¢ æ—¥ä»˜è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼: æ—¥ä»˜ã‚’å«ã‚€è¦ç´ ã‚’æŒ‡å®š<br><br>
    ä¾‹: YouTubeã®å ´åˆ<br>
    â€¢ ã‚¿ã‚°è¦ç´ : <code>a.bold.yt-formatted-string.style-scope.yt-simple-endpoint</code><br>
    â€¢ æ—¥ä»˜è¦ç´ : <code>span.bold.yt-formatted-string.style-scope</code>
                `;

                descriptionSection.append(descriptionTitle, descriptionText);

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                events.add(saveBtn, 'click', () => {
                    const newSelectors = {
                        tagSelector: tagSelectorInput.value.trim(),
                        tagContentSelector: tagContentSelectorInput.value.trim() || null,
                        dateSelector: dateSelectorInput.value.trim()
                    };

                    if (newSelectors.tagSelector && newSelectors.dateSelector) {
                        state.setElementSelectors(domain, newSelectors);
                        logMessage(`ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${domain}`);
                        alert('ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                    } else {
                        alert('ã‚¿ã‚°è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã¨æ—¥ä»˜è¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã¯å¿…é ˆã§ã™ã€‚');
                    }
                });

                events.add(resetBtn, 'click', () => {
                    tagSelectorInput.value = defaultSelectors.tagSelector;
                    tagContentSelectorInput.value = defaultSelectors.tagContentSelector;
                    dateSelectorInput.value = defaultSelectors.dateSelector;
                    state.elementSelectors.delete(domain);
                    state.setElementSelectors(domain, null);
                    logMessage(`ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ: ${domain}`);
                    alert('ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸï¼');
                });

                events.add(testBtn, 'click', () => {
                    const testSelectors = {
                        tagSelector: tagSelectorInput.value.trim(),
                        tagContentSelector: tagContentSelectorInput.value.trim() || null,
                        dateSelector: dateSelectorInput.value.trim()
                    };

                    // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                    const testTags = new Set();
                    const testTagElements = document.querySelectorAll(testSelectors.tagSelector);
                    testTagElements.forEach(el => {
                        let content = el;
                        if (testSelectors.tagContentSelector) {
                            content = el.querySelector(testSelectors.tagContentSelector);
                        }
                        if (content && content.textContent.trim()) {
                            const tagText = content.textContent.trim();
                            if (tagText.length > 0 && tagText.length < 20) testTags.add(tagText);
                        }
                    });

                    const testDateElement = document.querySelector(testSelectors.dateSelector);
                    const testDate = testDateElement ? testDateElement.textContent.trim() : null;

                    const testResult = `ãƒ†ã‚¹ãƒˆçµæœ:\nã‚¿ã‚°è¦ç´ : ${testTagElements.length}å€‹è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ\nã‚¿ã‚°: ${Array.from(testTags).join(', ') || 'ãªã—'}\næ—¥ä»˜: ${testDate || 'ãªã—'}`;
                    alert(testResult);
                });

                content.append(editSection, tagEditSection, dateEditSection, buttonSection, verificationSection, descriptionSection);
                elementEditDiv.append(menuBar, content);
                document.body.appendChild(elementEditDiv);
                state.activePopup = elementEditDiv;
                bringToFrontPopup(elementEditDiv);

                events.add(closeBtn, 'click', () => { elementEditDiv.remove(); state.activePopup = null; });

                return elementEditDiv;
            };

            const resizeSelectedImages = (windowObj, checkboxes) => {
                const allItems = GM_getValue('savedItems', []);
                let processedCount = 0;
                let totalSaved = 0;

                checkboxes.forEach(cb => {
                    const timestamp = cb.parentElement.dataset.timestamp;
                    const item = allItems.find(i => i.timestamp === timestamp);
                    if (item && item.image) {
                        const originalSize = new Blob([item.image]).size;

                        // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚º
                        const img = new Image();
                        img.onload = () => {
                            try {
                                                        const canvas = document.createElement('canvas');
                            const maxSize = 150;

                                // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¡ãªãŒã‚‰150x150pxä»¥ä¸‹ã«ãƒªã‚µã‚¤ã‚º
                                let targetWidth = img.width;
                                let targetHeight = img.height;

                                if (targetWidth > maxSize || targetHeight > maxSize) {
                                    const ratio = Math.min(maxSize / targetWidth, maxSize / targetHeight);
                                    targetWidth = Math.floor(targetWidth * ratio);
                                    targetHeight = Math.floor(targetHeight * ratio);
                                }

                                canvas.width = targetWidth;
                                canvas.height = targetHeight;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

                                                        // JPEGå“è³ª0.3ã§ä¿å­˜ï¼ˆã‚ˆã‚Šé«˜åœ§ç¸®ï¼‰
                            const resizedImage = canvas.toDataURL('image/jpeg', 0.3);
                                item.image = resizedImage;

                                const newSize = new Blob([resizedImage]).size;
                                totalSaved += (originalSize - newSize);
                                processedCount++;

                                logMessage(`ç”»åƒãƒªã‚µã‚¤ã‚ºå®Œäº†: ${targetWidth}x${targetHeight} (${(newSize/1024).toFixed(1)}KB)`);

                                // æœ€å¾Œã®ç”»åƒãŒå‡¦ç†ã•ã‚ŒãŸã‚‰ä¿å­˜
                                if (processedCount === checkboxes.length) {
                                    GM_setValue('savedItems', allItems);
                                    displaySavedItems(windowObj);
                                    const savedKB = (totalSaved / 1024).toFixed(1);
                                    alert(`ãƒªã‚µã‚¤ã‚ºå®Œäº†ï¼\n${processedCount}ä»¶ã®ç”»åƒã‚’å‡¦ç†ã—ã¾ã—ãŸã€‚\nåˆè¨ˆ${savedKB}KBå‰Šæ¸›ã—ã¾ã—ãŸã€‚`);
                                }
                            } catch (e) {
                                logMessage(`ç”»åƒãƒªã‚µã‚¤ã‚ºå¤±æ•—: ${e.message}`);
                                processedCount++;
                            }
                        };
                        img.onerror = () => {
                            logMessage(`ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: ${timestamp}`);
                            processedCount++;
                        };
                        img.src = item.image;
                    } else {
                        processedCount++;
                    }
                });
            };

            const createTagEditWindow = (windowObj) => {
                // æ—¢å­˜ã®ã‚¿ã‚°ç·¨é›†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒã‚ã‚Œã°é–‰ã˜ã‚‹
                if (state.activePopup && state.activePopup.className === 'tagEditPopup') {
                    state.activePopup.remove();
                    state.activePopup = null;
                    return;
                }
                if (state.activePopup) { state.activePopup.remove(); state.activePopup = null; }

                const tagEditDiv = document.createElement('div');
                tagEditDiv.className = 'tagEditPopup';
                tagEditDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 600px;
                    height: 700px;
                    background: #0a1f2e;
                    border: 2px solid #104437;
                    border-radius: 10px;
                    z-index: 20000;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    font-family: sans-serif;
                    color: white;
                `;

                const menuBar = document.createElement('div');
                menuBar.className = 'menuBar';
                menuBar.style.cssText = `
                    background: #104437;
                    padding: 10px 15px;
                    border-radius: 8px 8px 0 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    cursor: move;
                    user-select: none;
                `;

                const title = document.createElement('h3');
                title.textContent = `ã‚¿ã‚°ç·¨é›† - ${windowObj.activeTab}`;
                title.style.cssText = `
                    margin: 0;
                    font-size: 16px;
                    font-weight: bold;
                    color: white;
                `;

                const closeBtn = document.createElement('button');
                closeBtn.className = 'closeTagEdit';
                closeBtn.textContent = 'Ã—';
                closeBtn.style.cssText = `
                    background: #e74c3c;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 25px;
                    height: 25px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                menuBar.append(title, closeBtn);

                const content = document.createElement('div');
                content.className = 'tagEditContent';
                content.style.cssText = `
                    padding: 15px;
                    flex: 1;
                    overflow-y: auto;
                    background: #0a1f2e;
                `;

                // ã‚¿ã‚°è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                const addSection = document.createElement('div');
                addSection.style.cssText = `
                    margin-bottom: 20px;
                    padding: 15px;
                    background: #1a2f3e;
                    border-radius: 8px;
                    border: 1px solid #104437;
                `;

                const addTitle = document.createElement('h4');
                addTitle.textContent = 'ğŸ“ ã‚¿ã‚°ã‚’è¿½åŠ ';
                addTitle.style.cssText = `
                    margin: 0 0 15px 0;
                    font-size: 14px;
                    font-weight: bold;
                    color: #16a085;
                `;

                const addForm = document.createElement('div');
                addForm.style.cssText = `
                    display: flex;
                    gap: 10px;
                    align-items: center;
                `;

                const tagInput = document.createElement('input');
                tagInput.type = 'text';
                tagInput.placeholder = 'æ–°ã—ã„ã‚¿ã‚°åã‚’å…¥åŠ›';
                tagInput.style.cssText = `
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid #104437;
                    border-radius: 5px;
                    background: #0a1f2e;
                    color: white;
                    font-size: 12px;
                `;

                const addBtn = document.createElement('button');
                addBtn.textContent = 'è¿½åŠ ';
                addBtn.style.cssText = `
                    background: #16a085;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: bold;
                    transition: background-color 0.2s;
                `;

                addForm.append(tagInput, addBtn);
                addSection.append(addTitle, addForm);

                // é™¤å¤–ã‚¿ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                const excludeSection = document.createElement('div');
                excludeSection.style.cssText = `
                    margin-bottom: 20px;
                    padding: 15px;
                    background: #1a2f3e;
                    border-radius: 8px;
                    border: 1px solid #104437;
                `;

                const excludeTitle = document.createElement('h4');
                excludeTitle.textContent = 'ğŸš« é™¤å¤–ã‚¿ã‚°è¨­å®š';
                excludeTitle.style.cssText = `
                    margin: 0 0 15px 0;
                    font-size: 14px;
                    font-weight: bold;
                    color: #16a085;
                `;

                // é™¤å¤–ã‚¿ã‚¤ãƒ—é¸æŠ
                const excludeTypeDiv = document.createElement('div');
                excludeTypeDiv.style.cssText = `
                    margin-bottom: 15px;
                    display: flex;
                    align-items: center;
                    gap: 15px;
                `;

                const exactRadio = document.createElement('input');
                exactRadio.type = 'radio';
                exactRadio.name = 'excludeType';
                exactRadio.value = 'exact';
                exactRadio.checked = true;
                exactRadio.style.cssText = `
                    margin: 0;
                    cursor: pointer;
                `;

                const exactLabel = document.createElement('label');
                exactLabel.textContent = 'å®Œå…¨ä¸€è‡´';
                exactLabel.style.cssText = `
                    color: #ccc;
                    font-size: 12px;
                    cursor: pointer;
                    margin: 0;
                `;

                const regexRadio = document.createElement('input');
                regexRadio.type = 'radio';
                regexRadio.name = 'excludeType';
                regexRadio.value = 'regex';
                regexRadio.style.cssText = `
                    margin: 0;
                    cursor: pointer;
                `;

                const regexLabel = document.createElement('label');
                regexLabel.textContent = 'æ­£è¦è¡¨ç¾';
                regexLabel.style.cssText = `
                    color: #ccc;
                    font-size: 12px;
                    cursor: pointer;
                    margin: 0;
                `;

                excludeTypeDiv.append(exactRadio, exactLabel, regexRadio, regexLabel);

                const excludeForm = document.createElement('div');
                excludeForm.style.cssText = `
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    margin-bottom: 10px;
                `;

                const excludeInput = document.createElement('input');
                excludeInput.type = 'text';
                excludeInput.placeholder = 'é™¤å¤–ã™ã‚‹ã‚¿ã‚°åï¼ˆä¾‹ï¼šABCï¼‰ã¾ãŸã¯æ­£è¦è¡¨ç¾ï¼ˆä¾‹ï¼šABC\\d+ï¼‰';
                excludeInput.style.cssText = `
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid #104437;
                    border-radius: 5px;
                    background: #0a1f2e;
                    color: white;
                    font-size: 12px;
                `;

                const addExcludeBtn = document.createElement('button');
                addExcludeBtn.textContent = 'é™¤å¤–ã«è¿½åŠ ';
                addExcludeBtn.style.cssText = `
                    background: #e67e22;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: bold;
                    transition: background-color 0.2s;
                `;

                excludeForm.append(excludeInput, addExcludeBtn);

                // é™¤å¤–ã‚¿ã‚°ç®¡ç†ãƒœã‚¿ãƒ³
                const manageExcludeBtn = document.createElement('button');
                manageExcludeBtn.textContent = 'é™¤å¤–ã‚¿ã‚°ç®¡ç†';
                manageExcludeBtn.style.cssText = `
                    background: #e74c3c;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    font-size: 12px;
                    cursor: pointer;
                    width: 100%;
                    font-weight: bold;
                    transition: background-color 0.2s;
                `;

                events.add(manageExcludeBtn, 'click', () => {
                    createExcludeManageWindow(windowObj);
                });

                excludeSection.append(excludeTitle, excludeTypeDiv, excludeForm, manageExcludeBtn);

                // é™¤å¤–ã‚¿ã‚°è¡¨ç¤ºã¯å‰Šé™¤ï¼ˆé™¤å¤–ã‚¿ã‚°ç®¡ç†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ã®ã¿ç¢ºèªå¯èƒ½ï¼‰

                // ã‚¿ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                const groupSection = document.createElement('div');
                groupSection.style.cssText = `
                    margin-bottom: 20px;
                    padding: 15px;
                    background: #1a2f3e;
                    border-radius: 8px;
                    border: 1px solid #104437;
                `;

                const groupTitle = document.createElement('h4');
                groupTitle.textContent = 'ğŸ“ ã‚¿ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†';
                groupTitle.style.cssText = `
                    margin: 0 0 15px 0;
                    font-size: 14px;
                    font-weight: bold;
                    color: #16a085;
                `;

                // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆãƒ•ã‚©ãƒ¼ãƒ 
                const groupForm = document.createElement('div');
                groupForm.style.cssText = `
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    margin-bottom: 15px;
                `;

                const groupInput = document.createElement('input');
                groupInput.type = 'text';
                groupInput.placeholder = 'æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›';
                groupInput.style.cssText = `
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid #104437;
                    border-radius: 5px;
                    background: #0a1f2e;
                    color: white;
                    font-size: 12px;
                `;

                const createGroupBtn = document.createElement('button');
                createGroupBtn.textContent = 'ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ';
                createGroupBtn.style.cssText = `
                    background: #9b59b6;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: bold;
                    transition: background-color 0.2s;
                `;

                groupForm.append(groupInput, createGroupBtn);

                // é¸æŠã•ã‚ŒãŸã‚¿ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢
                const selectedTagsArea = document.createElement('div');
                selectedTagsArea.className = 'selectedTagsArea';
                selectedTagsArea.style.cssText = `
                    background: #0a1f2e;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    min-height: 40px;
                    border: 1px solid #104437;
                `;

                const selectedTagsTitle = document.createElement('div');
                selectedTagsTitle.textContent = 'é¸æŠã•ã‚ŒãŸã‚¿ã‚°:';
                selectedTagsTitle.style.cssText = `
                    margin-bottom: 10px;
                    font-size: 12px;
                    color: #16a085;
                    font-weight: bold;
                `;

                selectedTagsArea.appendChild(selectedTagsTitle);

                // æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢
                const groupList = document.createElement('div');
                groupList.className = 'groupList';
                groupList.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                `;

                groupSection.append(groupTitle, groupForm, selectedTagsArea, groupList);

                // æ—¢å­˜ã‚¿ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                const existingSection = document.createElement('div');
                existingSection.style.cssText = `
                    margin-bottom: 20px;
                    padding: 15px;
                    background: #1a2f3e;
                    border-radius: 8px;
                    border: 1px solid #104437;
                `;

                const existingTitle = document.createElement('h4');
                existingTitle.textContent = 'ğŸ·ï¸ æ—¢å­˜ã®ã‚¿ã‚°';
                existingTitle.style.cssText = `
                    margin: 0 0 15px 0;
                    font-size: 14px;
                    font-weight: bold;
                    color: #16a085;
                `;

                const tagList = document.createElement('div');
                tagList.className = 'tagList';
                tagList.style.cssText = `
                    display: flex;
                    flex-wrap: wrap;
                    gap: 10px;
                `;

                existingSection.append(existingTitle, tagList);
                content.append(addSection, excludeSection, groupSection, existingSection);

                // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¿½åŠ 
                let isDragging = false;
                let offsetX, offsetY;

                const handleMouseMove = (e) => {
                    if (isDragging) {
                        let leftPx = e.clientX - offsetX;
                        let topPx = e.clientY - offsetY;
                        let widthPx = tagEditDiv.offsetWidth;
                        let heightPx = tagEditDiv.offsetHeight;

                        leftPx = Math.max(0, Math.min(leftPx, window.innerWidth - widthPx));
                        topPx = Math.max(0, Math.min(topPx, window.innerHeight - heightPx));

                        requestAnimationFrame(() => {
                            tagEditDiv.style.left = `${leftPx}px`;
                            tagEditDiv.style.top = `${topPx}px`;
                            tagEditDiv.style.transform = 'none';
                        });
                    }
                };

                const handleMouseUp = () => {
                    if (isDragging) {
                        isDragging = false;
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    }
                };

                events.add(menuBar, 'mousedown', (e) => {
                    if (e.target === closeBtn) return; // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã§ã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ãªã„
                    isDragging = true;
                    // ç¾åœ¨ã®ä½ç½®ã‚’å–å¾—ï¼ˆtransformã‚’è€ƒæ…®ï¼‰
                    const rect = tagEditDiv.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;
                    e.preventDefault();
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });

                // ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼åŠ¹æœã‚’è¿½åŠ 
                events.add(addBtn, 'mouseenter', () => {
                    addBtn.style.background = '#1abc9c';
                });
                events.add(addBtn, 'mouseleave', () => {
                    addBtn.style.background = '#16a085';
                });

                events.add(addExcludeBtn, 'mouseenter', () => {
                    addExcludeBtn.style.background = '#d35400';
                });
                events.add(addExcludeBtn, 'mouseleave', () => {
                    addExcludeBtn.style.background = '#e67e22';
                });

                events.add(manageExcludeBtn, 'mouseenter', () => {
                    manageExcludeBtn.style.background = '#c0392b';
                });
                events.add(manageExcludeBtn, 'mouseleave', () => {
                    manageExcludeBtn.style.background = '#e74c3c';
                });

                events.add(createGroupBtn, 'mouseenter', () => {
                    createGroupBtn.style.background = '#8e44ad';
                });
                events.add(createGroupBtn, 'mouseleave', () => {
                    createGroupBtn.style.background = '#9b59b6';
                });

                tagEditDiv.append(menuBar, content);
                document.body.appendChild(tagEditDiv);
                state.activePopup = tagEditDiv;
                bringToFrontPopup(tagEditDiv);

                // æ—¢å­˜ã‚¿ã‚°ã‚’è¡¨ç¤º
                const updateTagList = () => {
                    tagList.innerHTML = '';
                    const allItems = GM_getValue('savedItems', []);
                    const currentTabItems = allItems.filter(item => item.tab === windowObj.activeTab);
                    const allTags = new Set();

                    currentTabItems.forEach(item => {
                        if (item.tags && Array.isArray(item.tags)) {
                            item.tags.forEach(tag => allTags.add(tag));
                        }
                    });

                    allTags.forEach(tag => {
                        const tagDiv = document.createElement('div');
                        tagDiv.className = 'tagItem';
                        const isSelected = selectedTags.has(tag);
                        tagDiv.style.cssText = `background: ${isSelected ? '#16a085' : '#104437'}; padding: 5px 10px; border-radius: 15px; display: flex; align-items: center; gap: 8px; color: white; font-size: 12px; cursor: pointer; transition: all 0.2s ease;`;

                        const tagText = document.createElement('span'); tagText.textContent = tag;
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Ã—'; deleteBtn.style.cssText = 'background: #e74c3c; border: none; color: white; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 10px;';

                        tagDiv.append(tagText, deleteBtn);
                        tagList.appendChild(tagDiv);

                        // ã‚¿ã‚°é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
                        events.add(tagDiv, 'click', (e) => {
                            if (e.target === deleteBtn) return; // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å ´åˆã¯é¸æŠã—ãªã„

                            if (selectedTags.has(tag)) {
                                selectedTags.delete(tag);
                                tagDiv.style.background = '#104437';
                            } else {
                                selectedTags.add(tag);
                                tagDiv.style.background = '#16a085';
                            }
                            updateSelectedTagsDisplay();

                            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                            tagDiv.animate([
                                { transform: 'scale(1)' },
                                { transform: 'scale(1.05)' },
                                { transform: 'scale(1)' }
                            ], {
                                duration: 200,
                                easing: 'ease-in-out'
                            });
                        });

                        // ã‚¿ã‚°å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
                        events.add(deleteBtn, 'click', (e) => {
                            e.stopPropagation(); // é¸æŠã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²ã
                            if (confirm(`ã‚¿ã‚°ã€Œ${tag}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®ã‚¿ã‚°ã‚’æŒã¤ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                                // ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰ã“ã®ã‚¿ã‚°ã‚’å‰Šé™¤
                                allItems.forEach(item => {
                                    if (item.tags && Array.isArray(item.tags)) {
                                        item.tags = item.tags.filter(t => t !== tag);
                                    }
                                });
                                GM_setValue('savedItems', allItems);
                                displaySavedItems(windowObj);
                                updateTagList();
                                updateSelectedTagsDisplay();

                                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                                tagDiv.animate([
                                    { transform: 'scale(1)', opacity: 1 },
                                    { transform: 'scale(0.8)', opacity: 0 }
                                ], {
                                    duration: 300,
                                    easing: 'ease-in-out'
                                }).onfinish = () => tagDiv.remove();
                            }
                        });
                    });
                };

                // é™¤å¤–ã‚¿ã‚°ãƒªã‚¹ãƒˆæ›´æ–°é–¢æ•°ã¯å‰Šé™¤ï¼ˆé™¤å¤–ã‚¿ã‚°ç®¡ç†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ã®ã¿ç®¡ç†ï¼‰

                // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ã‚’ç®¡ç†
                let selectedTags = new Set();

                // é¸æŠã•ã‚ŒãŸã‚¿ã‚°è¡¨ç¤ºã‚’æ›´æ–°
                const updateSelectedTagsDisplay = () => {
                    const selectedTagsContainer = selectedTagsArea.querySelector('.selectedTagsContainer');
                    if (selectedTagsContainer) {
                        selectedTagsContainer.remove();
                    }

                    const container = document.createElement('div');
                    container.className = 'selectedTagsContainer';
                    container.style.display = 'flex';
                    container.style.flexWrap = 'wrap';
                    container.style.gap = '5px';

                    selectedTags.forEach(tag => {
                        const tagDiv = document.createElement('div');
                        tagDiv.style.cssText = 'background: #16a085; padding: 3px 8px; border-radius: 10px; font-size: 11px; color: white; display: flex; align-items: center; gap: 5px;';

                        const tagText = document.createElement('span');
                        tagText.textContent = tag;

                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'Ã—';
                        removeBtn.style.cssText = 'background: none; border: none; color: white; cursor: pointer; font-size: 10px; padding: 0; width: 15px; height: 15px;';

                        tagDiv.append(tagText, removeBtn);
                        container.appendChild(tagDiv);

                        events.add(removeBtn, 'click', () => {
                            selectedTags.delete(tag);
                            updateSelectedTagsDisplay();
                            updateTagList();
                        });
                    });

                    selectedTagsArea.appendChild(container);
                };

                updateTagList();
                updateSelectedTagsDisplay();

                // é™¤å¤–ã‚¿ã‚°è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆ
                const handleAddExcludeTag = () => {
                    // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚‰ã‚’é™¤å¤–
                    if (selectedTags.size > 0) {
                        const currentExcludeTags = GM_getValue(`excludeTags-${windowObj.activeTab}`, []);
                        let addedCount = 0;

                        selectedTags.forEach(tag => {
                            const excludeRule = { pattern: tag, type: 'exact' };
                            if (!currentExcludeTags.some(t => t.pattern === tag)) {
                                currentExcludeTags.push(excludeRule);
                                addedCount++;
                            }
                        });

                        if (addedCount > 0) {
                            GM_setValue(`excludeTags-${windowObj.activeTab}`, currentExcludeTags);

                            // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰ã“ã‚Œã‚‰ã®ã‚¿ã‚°ã‚’å‰Šé™¤
                            const allItems = GM_getValue('savedItems', []);
                            let removedCount = 0;
                            allItems.forEach(item => {
                                if (item.tab === windowObj.activeTab && item.tags && Array.isArray(item.tags)) {
                                    const originalTags = [...item.tags];
                                    item.tags = item.tags.filter(tag => !selectedTags.has(tag));
                                    if (item.tags.length !== originalTags.length) {
                                        removedCount++;
                                    }
                                }
                            });

                            GM_setValue('savedItems', allItems);
                            displaySavedItems(windowObj);
                            updateTagList();
                            selectedTags.clear();
                            updateSelectedTagsDisplay();

                            // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å³åº§ã«æ›´æ–°
                            updateTagFilterButtons(windowObj);

                            logMessage(`${addedCount}å€‹ã®ã‚¿ã‚°ã‚’é™¤å¤–ã—ã€${removedCount}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ`);
                        }
                    } else {
                        // æ‰‹å‹•å…¥åŠ›ã®å ´åˆ
                        const excludeTagName = excludeInput.value.trim();
                        if (!excludeTagName) return;

                        if (excludeTagName.length > 50) {
                            alert('é™¤å¤–ã‚¿ã‚°åã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                            return;
                        }

                        const excludeType = document.querySelector('input[name="excludeType"]:checked').value;

                        // æ­£è¦è¡¨ç¾ã®å ´åˆã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                        if (excludeType === 'regex') {
                            try {
                                new RegExp(excludeTagName);
                            } catch (e) {
                                alert('æ­£è¦è¡¨ç¾ãŒç„¡åŠ¹ã§ã™ã€‚');
                                return;
                            }
                        }

                        const currentExcludeTags = GM_getValue(`excludeTags-${windowObj.activeTab}`, []);
                        const excludeRule = { pattern: excludeTagName, type: excludeType };

                        if (currentExcludeTags.some(t => t.pattern === excludeTagName)) {
                            alert('ã“ã®é™¤å¤–ã‚¿ã‚°ã¯æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚');
                            return;
                        }

                        // é™¤å¤–ã‚¿ã‚°ã‚’è¿½åŠ 
                        currentExcludeTags.push(excludeRule);
                        GM_setValue(`excludeTags-${windowObj.activeTab}`, currentExcludeTags);

                        // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰ã“ã®ã‚¿ã‚°ã‚’å‰Šé™¤
                        const allItems = GM_getValue('savedItems', []);
                        let removedCount = 0;
                        allItems.forEach(item => {
                            if (item.tab === windowObj.activeTab && item.tags && Array.isArray(item.tags)) {
                                const originalTags = [...item.tags];
                                item.tags = item.tags.filter(tag => {
                                    if (excludeType === 'regex') {
                                        try {
                                            return !new RegExp(excludeTagName).test(tag);
                                        } catch (e) {
                                            return true;
                                        }
                                    } else {
                                        return tag !== excludeTagName;
                                    }
                                });
                                if (item.tags.length !== originalTags.length) {
                                    removedCount++;
                                }
                            }
                        });

                        GM_setValue('savedItems', allItems);
                        displaySavedItems(windowObj);
                        updateTagList();
                        excludeInput.value = '';

                        // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å³åº§ã«æ›´æ–°
                        updateTagFilterButtons(windowObj);

                        logMessage(`é™¤å¤–ã‚¿ã‚°ã€Œ${excludeTagName}ã€(${excludeType === 'regex' ? 'æ­£è¦è¡¨ç¾' : 'å®Œå…¨ä¸€è‡´'})ã‚’è¿½åŠ ã—ã€${removedCount}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ`);
                    }

                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    addExcludeBtn.animate([
                        { transform: 'scale(1)' },
                        { transform: 'scale(1.1)' },
                        { transform: 'scale(1)' }
                    ], {
                        duration: 200,
                        easing: 'ease-in-out'
                    });
                };

                events.add(addExcludeBtn, 'click', handleAddExcludeTag);
                events.add(excludeInput, 'keypress', (e) => {
                    if (e.key === 'Enter') handleAddExcludeTag();
                });

                // ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†æ©Ÿèƒ½
                const updateGroupList = () => {
                    groupList.innerHTML = '';
                    const tagGroups = GM_getValue(`tagGroups-${windowObj.activeTab}`, {});

                    Object.entries(tagGroups).forEach(([groupName, groupTags]) => {
                        const groupDiv = document.createElement('div');
                        groupDiv.style.cssText = 'background: #0a1f2e; padding: 10px; border-radius: 5px; border: 1px solid #104437;';

                        const groupHeader = document.createElement('div');
                        groupHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';

                        const groupTitle = document.createElement('h5');
                        groupTitle.textContent = groupName;
                        groupTitle.style.cssText = 'margin: 0; color: #16a085; font-size: 14px;';

                        const deleteGroupBtn = document.createElement('button');
                        deleteGroupBtn.textContent = 'å‰Šé™¤';
                        deleteGroupBtn.style.cssText = 'background: #e74c3c; border: none; color: white; padding: 3px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;';

                        groupHeader.append(groupTitle, deleteGroupBtn);

                        const groupTagsDiv = document.createElement('div');
                        groupTagsDiv.style.cssText = 'display: flex; flex-wrap: wrap; gap: 5px;';

                        groupTags.forEach(tag => {
                            const tagSpan = document.createElement('span');
                            tagSpan.textContent = tag;
                            tagSpan.style.cssText = 'background: #104437; padding: 2px 6px; border-radius: 8px; font-size: 10px; color: white;';
                            groupTagsDiv.appendChild(tagSpan);
                        });

                        groupDiv.append(groupHeader, groupTagsDiv);
                        groupList.appendChild(groupDiv);

                        // ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
                        events.add(deleteGroupBtn, 'click', () => {
                            if (confirm(`ã‚°ãƒ«ãƒ¼ãƒ—ã€Œ${groupName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                                delete tagGroups[groupName];
                                GM_setValue(`tagGroups-${windowObj.activeTab}`, tagGroups);
                                updateGroupList();

                                // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å³åº§ã«æ›´æ–°
                                updateTagFilterButtons(windowObj);

                                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                                groupDiv.animate([
                                    { transform: 'scale(1)', opacity: 1 },
                                    { transform: 'scale(0.8)', opacity: 0 }
                                ], {
                                    duration: 300,
                                    easing: 'ease-in-out'
                                }).onfinish = () => groupDiv.remove();
                            }
                        });
                    });
                };

                updateGroupList();

                // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆã‚¤ãƒ™ãƒ³ãƒˆ
                const handleCreateGroup = () => {
                    const groupName = groupInput.value.trim();
                    if (!groupName) {
                        alert('ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    if (selectedTags.size === 0) {
                        alert('ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã‚ã‚‹ã‚¿ã‚°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    const tagGroups = GM_getValue(`tagGroups-${windowObj.activeTab}`, {});
                    if (tagGroups[groupName]) {
                        alert('ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—åã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚');
                        return;
                    }

                    // ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
                    tagGroups[groupName] = Array.from(selectedTags);
                    GM_setValue(`tagGroups-${windowObj.activeTab}`, tagGroups);

                    // é¸æŠã‚’ã‚¯ãƒªã‚¢
                    selectedTags.clear();
                    groupInput.value = '';

                    updateGroupList();
                    updateTagList();
                    updateSelectedTagsDisplay();

                    // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å³åº§ã«æ›´æ–°
                    updateTagFilterButtons(windowObj);

                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    createGroupBtn.animate([
                        { transform: 'scale(1)' },
                        { transform: 'scale(1.1)' },
                        { transform: 'scale(1)' }
                    ], {
                        duration: 200,
                        easing: 'ease-in-out'
                    });

                    logMessage(`ã‚°ãƒ«ãƒ¼ãƒ—ã€Œ${groupName}ã€ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆ${Array.from(selectedTags).length}å€‹ã®ã‚¿ã‚°ï¼‰`);
                };

                events.add(createGroupBtn, 'click', handleCreateGroup);
                events.add(groupInput, 'keypress', (e) => {
                    if (e.key === 'Enter') handleCreateGroup();
                });

                // ã‚¿ã‚°è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆ
                const handleAddTag = () => {
                    const tagName = tagInput.value.trim();
                    if (!tagName) return;

                    if (tagName.length > 20) {
                        alert('ã‚¿ã‚°åã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    // æ—¢å­˜ã®ã‚¿ã‚°ã‹ãƒã‚§ãƒƒã‚¯
                    const allItems = GM_getValue('savedItems', []);
                    const currentTabItems = allItems.filter(item => item.tab === windowObj.activeTab);
                    const existingTags = new Set();
                    currentTabItems.forEach(item => {
                        if (item.tags && Array.isArray(item.tags)) {
                            item.tags.forEach(tag => existingTags.add(tag));
                        }
                    });

                    if (existingTags.has(tagName)) {
                        alert('ã“ã®ã‚¿ã‚°ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚');
                        return;
                    }

                    // é™¤å¤–ã‚¿ã‚°ã‹ãƒã‚§ãƒƒã‚¯
                    const excludeTags = GM_getValue(`excludeTags-${windowObj.activeTab}`, []);
                    const isExcluded = excludeTags.some(excludeRule => {
                        if (excludeRule.type === 'regex') {
                            try {
                                return new RegExp(excludeRule.pattern).test(tagName);
                            } catch (e) {
                                return false;
                            }
                        } else {
                            return excludeRule.pattern === tagName;
                        }
                    });

                    if (isExcluded) {
                        alert(`ã€Œ${tagName}ã€ã¯é™¤å¤–ã‚¿ã‚°ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€è¿½åŠ ã§ãã¾ã›ã‚“ã€‚`);
                        return;
                    }

                    // é¸æŠã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã«ã‚¿ã‚°ã‚’è¿½åŠ 
                    const selectedItems = windowObj.el.querySelectorAll('.savedItem.selected');
                    if (selectedItems.length === 0) {
                        alert('ã‚¿ã‚°ã‚’è¿½åŠ ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\nç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ã‹ã‚‰ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    selectedItems.forEach(item => {
                        const timestamp = item.dataset.timestamp;
                        const itemData = allItems.find(i => i.timestamp === timestamp);
                        if (itemData) {
                            if (!itemData.tags) itemData.tags = [];
                            if (!itemData.tags.includes(tagName)) {
                                itemData.tags.push(tagName);
                            }
                        }
                    });

                    GM_setValue('savedItems', allItems);
                    displaySavedItems(windowObj);
                    updateTagList();
                    tagInput.value = '';

                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    addBtn.animate([
                        { transform: 'scale(1)' },
                        { transform: 'scale(1.1)' },
                        { transform: 'scale(1)' }
                    ], {
                        duration: 200,
                        easing: 'ease-in-out'
                    });

                    logMessage(`ã‚¿ã‚°ã€Œ${tagName}ã€ã‚’${selectedItems.length}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã«è¿½åŠ `);
                };

                events.add(addBtn, 'click', handleAddTag);
                events.add(tagInput, 'keypress', (e) => {
                    if (e.key === 'Enter') handleAddTag();
                });
                events.add(closeBtn, 'click', () => { tagEditDiv.remove(); state.activePopup = null; });

                return tagEditDiv;
            };

            const updateTagFilterButtons = (windowObj) => {
                const tagFilterArea = windowObj.el.querySelector('.tagFilterArea');
                if (!tagFilterArea) return;

                // æ—¢å­˜ã®ã‚¿ã‚°ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢
                tagFilterArea.innerHTML = '';

                // éåŒæœŸã§ã‚¿ã‚°å‡¦ç†ã‚’å®Ÿè¡Œ
                requestAnimationFrame(() => {
                    // ç¾åœ¨ã®ã‚¿ãƒ–ã®ã™ã¹ã¦ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆé™¤å¤–ã‚¿ã‚°ã‚’é™¤ãï¼‰
                    const allItems = GM_getValue('savedItems', []);
                    const currentTabItems = allItems.filter(item => item.tab === windowObj.activeTab);
                    const excludeTags = GM_getValue(`excludeTags-${windowObj.activeTab}`, []);
                    const allTags = new Set();

                    // ã‚¿ã‚°åé›†ã‚’æœ€é©åŒ–
                    const tagCount = new Map();
                    currentTabItems.forEach(item => {
                        if (item.tags && Array.isArray(item.tags)) {
                            item.tags.forEach(tag => {
                                // é™¤å¤–ã‚¿ã‚°ã«ãƒãƒƒãƒã—ãªã„ã‚‚ã®ã®ã¿è¿½åŠ 
                                const isExcluded = excludeTags.some(rule => {
                                    if (rule.type === 'regex') {
                                        try {
                                            return new RegExp(rule.pattern).test(tag);
                                        } catch (e) {
                                            return false;
                                        }
                                    } else {
                                        return tag === rule.pattern;
                                    }
                                });

                                if (!isExcluded) {
                                    allTags.add(tag);
                                    tagCount.set(tag, (tagCount.get(tag) || 0) + 1);
                                }
                            });
                        }
                    });

                    // é™¤å¤–ã‚¿ã‚°ã¯æ—¢ã«å–å¾—æ¸ˆã¿

                    // ã‚¿ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
                    const tagGroups = GM_getValue(`tagGroups-${windowObj.activeTab}`, {});

                    // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ã‚’åˆæœŸåŒ–
                    if (!windowObj.selectedTags) windowObj.selectedTags = new Set();

                    // ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‚¿ã‚°ã‚’å–å¾—
                    const groupedTags = new Set();
                    Object.values(tagGroups).forEach(groupTags => {
                        groupTags.forEach(tag => groupedTags.add(tag));
                    });

                    // ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã¦ã„ãªã„ã‚¿ã‚°ã‚’å–å¾—
                    const ungroupedTags = Array.from(allTags).filter(tag => !groupedTags.has(tag));

                    // ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
                    Object.entries(tagGroups).forEach(([groupName, groupTags]) => {
                        // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ã‚¿ã‚°ãƒœã‚¿ãƒ³ã‚’ä½œæˆï¼ˆ1åˆ—ã§ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰
                        const groupTagsContainer = document.createElement('div');
                        groupTagsContainer.style.cssText = `
                            display: flex;
                            flex-wrap: wrap;
                            gap: 3px;
                            margin-bottom: 8px;
                        `;

                        groupTags.forEach(tag => {
                            const tagBtn = document.createElement('button');
                            tagBtn.className = 'tagFilterBtn';
                            tagBtn.textContent = tag;
                            tagBtn.style.cssText = `
                                background: ${windowObj.selectedTags.has(tag) ? '#e67e22' : '#104437'};
                                color: white;
                                border: none;
                                padding: 3px 6px;
                                border-radius: 10px;
                                font-size: 10px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                                box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                            `;

                            // ã‚¿ã‚°ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                            events.add(tagBtn, 'click', () => {
                                if (windowObj.multiSelectMode) {
                                    // è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ï¼šã‚¿ã‚°ã‚’è¿½åŠ /å‰Šé™¤
                                    if (windowObj.selectedTags.has(tag)) {
                                        // ã‚¿ã‚°ã‚’è§£é™¤
                                        windowObj.selectedTags.delete(tag);
                                        tagBtn.style.background = '#104437';

                                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                                        tagBtn.animate([
                                            { transform: 'scale(1)' },
                                            { transform: 'scale(0.9)' },
                                            { transform: 'scale(1)' }
                                        ], {
                                            duration: 200,
                                            easing: 'ease-in-out'
                                        });
                                    } else {
                                        // ã‚¿ã‚°ã‚’é¸æŠ
                                        windowObj.selectedTags.add(tag);
                                        tagBtn.style.background = '#e67e22';

                                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                                        tagBtn.animate([
                                            { transform: 'scale(1)' },
                                            { transform: 'scale(1.1)' },
                                            { transform: 'scale(1)' }
                                        ], {
                                            duration: 200,
                                            easing: 'ease-in-out'
                                        });
                                    }
                                } else {
                                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šå‰ã®é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„ã‚¿ã‚°ã®ã¿é¸æŠ
                                    windowObj.selectedTags.clear();
                                    windowObj.selectedTags.add(tag);

                                    // ã™ã¹ã¦ã®ã‚¿ã‚°ãƒœã‚¿ãƒ³ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
                                    tagFilterArea.querySelectorAll('.tagFilterBtn').forEach(btn => {
                                        btn.style.background = '#104437';
                                    });

                                    // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰æ›´
                                    tagBtn.style.background = '#e67e22';

                                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                                    tagBtn.animate([
                                        { transform: 'scale(1)' },
                                        { transform: 'scale(1.1)' },
                                        { transform: 'scale(1)' }
                                    ], {
                                        duration: 200,
                                        easing: 'ease-in-out'
                                    });
                                }

                                // ã‚¢ã‚¤ãƒ†ãƒ ã‚’å†è¡¨ç¤º
                                displaySavedItems(windowObj);

                                // é¸æŠçŠ¶æ…‹ã‚’ä¿å­˜
                                GM_setValue(`selectedTags-${windowObj.activeTab}`, Array.from(windowObj.selectedTags));

                                // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆé‡è¤‡ã‚’é˜²ããŸã‚ï¼‰
                                if (windowObj.selectedTags.size === 1) {
                                    // åˆå›é¸æŠæ™‚ã®ã¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                                    updateClearButton(windowObj);
                                } else if (windowObj.selectedTags.size === 0) {
                                    // é¸æŠè§£é™¤æ™‚ã¯ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
                                    updateClearButton(windowObj);
                                }

                                logMessage(`ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ${Array.from(windowObj.selectedTags).join(', ')}`);
                            });

                            groupTagsContainer.appendChild(tagBtn);
                        });

                        tagFilterArea.appendChild(groupTagsContainer);
                    });

                    // ãã®ä»–ã®ã‚¿ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã«å±ã•ãªã„ã‚¿ã‚°ã¯è¡¨ç¤ºã—ãªã„ï¼‰

                    // é™¤å¤–ã‚¿ã‚°æƒ…å ±è¡¨ç¤ºï¼ˆéè¡¨ç¤ºï¼‰
                    // é™¤å¤–ã‚¿ã‚°ã¯åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ç®¡ç†ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯è¡¨ç¤ºã—ãªã„

                    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
                    updateClearButton(windowObj);
                });

                // é™¤å¤–ã‚¿ã‚°ã¯æ—¢ã«å–å¾—æ¸ˆã¿

                // ã‚¿ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
                const tagGroups = GM_getValue(`tagGroups-${windowObj.activeTab}`, {});

                // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ã‚’åˆæœŸåŒ–
                if (!windowObj.selectedTags) windowObj.selectedTags = new Set();

                // ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‚¿ã‚°ã‚’å–å¾—
                const groupedTags = new Set();
                Object.values(tagGroups).forEach(groupTags => {
                    groupTags.forEach(tag => groupedTags.add(tag));
                });

                // ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã¦ã„ãªã„ã‚¿ã‚°ã‚’å–å¾—
                const ungroupedTags = Array.from(allTags).filter(tag => !groupedTags.has(tag));

                // ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
                Object.entries(tagGroups).forEach(([groupName, groupTags]) => {
                    // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ã‚¿ã‚°ãƒœã‚¿ãƒ³ã‚’ä½œæˆï¼ˆ1åˆ—ã§ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰
                    const groupTagsContainer = document.createElement('div');
                    groupTagsContainer.style.cssText = `
                        display: flex;
                        flex-wrap: wrap;
                        gap: 3px;
                        margin-bottom: 8px;
                    `;

                    groupTags.forEach(tag => {
                        const tagBtn = document.createElement('button');
                        tagBtn.className = 'tagFilterBtn';
                        tagBtn.textContent = tag;
                        tagBtn.style.cssText = `
                            background: ${windowObj.selectedTags.has(tag) ? '#e67e22' : '#104437'};
                            color: white;
                            border: none;
                            padding: 3px 6px;
                            border-radius: 10px;
                            font-size: 10px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                        `;

                        // ã‚¿ã‚°ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                        events.add(tagBtn, 'click', () => {
                            if (windowObj.multiSelectMode) {
                                // è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ï¼šã‚¿ã‚°ã‚’è¿½åŠ /å‰Šé™¤
                                if (windowObj.selectedTags.has(tag)) {
                                    // ã‚¿ã‚°ã‚’è§£é™¤
                                    windowObj.selectedTags.delete(tag);
                                    tagBtn.style.background = '#104437';

                                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                                    tagBtn.animate([
                                        { transform: 'scale(1)' },
                                        { transform: 'scale(0.9)' },
                                        { transform: 'scale(1)' }
                                    ], {
                                        duration: 200,
                                        easing: 'ease-in-out'
                                    });
                                } else {
                                    // ã‚¿ã‚°ã‚’é¸æŠ
                                    windowObj.selectedTags.add(tag);
                                    tagBtn.style.background = '#e67e22';

                                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                                    tagBtn.animate([
                                        { transform: 'scale(1)' },
                                        { transform: 'scale(1.1)' },
                                        { transform: 'scale(1)' }
                                    ], {
                                        duration: 200,
                                        easing: 'ease-in-out'
                                    });
                                }
                            } else {
                                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šå‰ã®é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„ã‚¿ã‚°ã®ã¿é¸æŠ
                                windowObj.selectedTags.clear();
                                windowObj.selectedTags.add(tag);

                                // ã™ã¹ã¦ã®ã‚¿ã‚°ãƒœã‚¿ãƒ³ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
                                tagFilterArea.querySelectorAll('.tagFilterBtn').forEach(btn => {
                                    btn.style.background = '#104437';
                                });

                                // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰æ›´
                                tagBtn.style.background = '#e67e22';

                                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                                tagBtn.animate([
                                    { transform: 'scale(1)' },
                                    { transform: 'scale(1.1)' },
                                    { transform: 'scale(1)' }
                                ], {
                                    duration: 200,
                                    easing: 'ease-in-out'
                                });
                            }

                            // ã‚¢ã‚¤ãƒ†ãƒ ã‚’å†è¡¨ç¤º
                            displaySavedItems(windowObj);

                            // é¸æŠçŠ¶æ…‹ã‚’ä¿å­˜
                            GM_setValue(`selectedTags-${windowObj.activeTab}`, Array.from(windowObj.selectedTags));

                            // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆé‡è¤‡ã‚’é˜²ããŸã‚ï¼‰
                            if (windowObj.selectedTags.size === 1) {
                                // åˆå›é¸æŠæ™‚ã®ã¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                                updateClearButton(windowObj);
                            } else if (windowObj.selectedTags.size === 0) {
                                // é¸æŠè§£é™¤æ™‚ã¯ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
                                updateClearButton(windowObj);
                            }

                            logMessage(`ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ${Array.from(windowObj.selectedTags).join(', ')}`);
                        });

                        groupTagsContainer.appendChild(tagBtn);
                    });

                    tagFilterArea.appendChild(groupTagsContainer);
                });

                // ãã®ä»–ã®ã‚¿ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã«å±ã•ãªã„ã‚¿ã‚°ã¯è¡¨ç¤ºã—ãªã„ï¼‰

                // é™¤å¤–ã‚¿ã‚°æƒ…å ±è¡¨ç¤ºï¼ˆéè¡¨ç¤ºï¼‰
                // é™¤å¤–ã‚¿ã‚°ã¯åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ç®¡ç†ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯è¡¨ç¤ºã—ãªã„

                // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
                updateClearButton(windowObj);
            };

            const updateClearButton = (windowObj) => {
                // æ—¢å­˜ã®ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’ã™ã¹ã¦å‰Šé™¤ï¼ˆã‚ˆã‚Šç¢ºå®Ÿã«ï¼‰
                const existingClearBtns = windowObj.el.querySelectorAll('.clearFilterButton');
                existingClearBtns.forEach(btn => {
                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚‚å‰Šé™¤
                    events.removeAll(btn);
                    btn.remove();
                });

                // ã‚¿ã‚°ç·¨é›†ãƒœã‚¿ãƒ³ã®æ¨ªã«ã‚ã‚‹ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚‚å‰Šé™¤ï¼ˆå¿µã®ãŸã‚ï¼‰
                const tagEditButton = windowObj.el.querySelector('.tagEditButton');
                if (tagEditButton) {
                    // ã‚¿ã‚°ç·¨é›†ãƒœã‚¿ãƒ³ã®å¾Œã«ã‚ã‚‹ã™ã¹ã¦ã®å…„å¼Ÿè¦ç´ ã‚’ãƒã‚§ãƒƒã‚¯
                    let nextSibling = tagEditButton.nextSibling;
                    while (nextSibling) {
                        if (nextSibling.textContent === 'ã‚¯ãƒªã‚¢' || nextSibling.className === 'clearFilterButton') {
                            events.removeAll(nextSibling);
                            const tempSibling = nextSibling.nextSibling;
                            nextSibling.remove();
                            nextSibling = tempSibling;
                        } else {
                            nextSibling = nextSibling.nextSibling;
                        }
                    }
                }

                // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã®ã¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                if (windowObj.selectedTags && windowObj.selectedTags.size > 0) {
                    const clearBtn = document.createElement('button');
                    clearBtn.className = 'clearFilterButton';
                    clearBtn.textContent = 'ã‚¯ãƒªã‚¢';
                    clearBtn.style.cssText = `
                        background: #e74c3c;
                        color: white;
                        border: none;
                        padding: 3px 8px;
                        border-radius: 12px;
                        font-size: 10px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        margin-left: 5px;
                    `;

                    events.add(clearBtn, 'click', () => {
                        windowObj.selectedTags.clear();
                        GM_setValue(`selectedTags-${windowObj.activeTab}`, []);
                        displaySavedItems(windowObj);
                        updateClearButton(windowObj); // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹

                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                        clearBtn.animate([
                            { transform: 'scale(1)' },
                            { transform: 'scale(1.1)' },
                            { transform: 'scale(1)' }
                        ], {
                            duration: 200,
                            easing: 'ease-in-out'
                        });

                        logMessage('ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                    });

                    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’ã‚¿ã‚°ç·¨é›†ãƒœã‚¿ãƒ³ã®æ¨ªã«è¿½åŠ 
                    const tagEditButton = windowObj.el.querySelector('.tagEditButton');
                    if (tagEditButton) {
                        // æ—¢ã«ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰è¿½åŠ 
                        const existingClearBtn = tagEditButton.parentNode.querySelector('.clearFilterButton');
                        if (!existingClearBtn) {
                            tagEditButton.parentNode.insertBefore(clearBtn, tagEditButton.nextSibling);
                        } else {
                            // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
                            events.removeAll(clearBtn);
                            clearBtn.remove();
                        }
                    }
                }
            };

            // æ±ç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½œæˆé–¢æ•°
            const createPopupWindow = (options) => {
                const {
                    title,
                    width = 350,
                    height = 300,
                    className = 'popupWindow',
                    content
                } = options;

                if (state.activePopup) {
                    state.activePopup.remove();
                }

                const popupDiv = document.createElement('div');
                popupDiv.className = className;
                popupDiv.style.cssText = `
                    position: fixed;
                    background-color: #082849;
                    border: 2px solid #104437;
                    padding: 5px;
                    z-index: 10001;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                    font-family: sans-serif;
                    color: #fff;
                    width: ${width}px;
                    height: ${height}px;
                    left: 50%;
                    top: 50%;
                    transform: translate(-50%, -50%);
                    overflow-y: auto;
                `;

                const menuBar = document.createElement('div');
                menuBar.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    padding: 2px;
                    background-color: #104437;
                    height: 20px;
                    align-items: center;
                `;

                const titleElement = document.createElement('h3');
                titleElement.textContent = title;
                titleElement.style.cssText = 'margin: 0; flex-grow: 1; text-align: center; font-size: 14px;';

                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Ã—';
                closeBtn.style.cssText = 'padding: 1px 3px; background-color: #082849; color: #fff; border: none; cursor: pointer; border-radius: 3px; font-size: 12px;';

                menuBar.append(titleElement, closeBtn);
                popupDiv.appendChild(menuBar);

                const contentDiv = document.createElement('div');
                contentDiv.style.cssText = 'overflow-y: auto; padding: 15px;';

                if (typeof content === 'function') {
                    content(contentDiv);
                } else {
                    contentDiv.appendChild(content);
                }

                popupDiv.appendChild(contentDiv);
                document.body.appendChild(popupDiv);
                state.activePopup = popupDiv;
                bringToFrontPopup(popupDiv);

                events.add(closeBtn, 'click', () => {
                    popupDiv.remove();
                    state.activePopup = null;
                });

                return popupDiv;
            };

            const createDomainDisplayWindow = (windowObj) => {
                return createPopupWindow({
                    title: 'ãƒ‰ãƒ¡ã‚¤ãƒ³åè¡¨ç¤ºè¨­å®š',
                    className: 'domainDisplayPopup',
                    content: (contentDiv) => {
                        // èª¬æ˜æ–‡
                        const description = document.createElement('div');
                        description.textContent = 'ã‚¿ãƒ–ã§ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’æ¨ªæ–‡å­—ã§è¡¨ç¤ºã™ã‚‹ã‹ã€ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã§è¡¨ç¤ºã™ã‚‹ã‹ã‚’è¨­å®šã§ãã¾ã™ã€‚';
                        description.style.cssText = 'margin-bottom: 15px; font-size: 12px; color: #95a5a6; line-height: 1.4;';

                        // è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³
                        const settingsDiv = document.createElement('div');
                        settingsDiv.style.cssText = 'display: flex; flex-direction: column; gap: 10px;';

                        // ãƒ‰ãƒ¡ã‚¤ãƒ³åè¡¨ç¤ºè¨­å®š
                        const domainDisplaySetting = document.createElement('div');
                        domainDisplaySetting.style.cssText = 'display: flex; align-items: center; gap: 10px;';

                        const domainDisplayLabel = document.createElement('label');
                        domainDisplayLabel.textContent = 'ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’æ¨ªæ–‡å­—ã§è¡¨ç¤º:';
                        domainDisplayLabel.style.cssText = 'font-size: 12px; flex-grow: 1;';

                        const domainDisplayCheckbox = document.createElement('input');
                        domainDisplayCheckbox.type = 'checkbox';
                        domainDisplayCheckbox.id = 'domainDisplayCheckbox';

                        // ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
                        const currentDomainDisplay = GM_getValue('domainDisplayMode', false);
                        domainDisplayCheckbox.checked = currentDomainDisplay;

                        domainDisplaySetting.append(domainDisplayLabel, domainDisplayCheckbox);
                        settingsDiv.appendChild(domainDisplaySetting);

                        // ä¿å­˜ãƒœã‚¿ãƒ³
                        const saveBtn = document.createElement('button');
                        saveBtn.textContent = 'è¨­å®šã‚’ä¿å­˜';
                        saveBtn.style.cssText = `
                            background: #27ae60;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            font-size: 12px;
                            cursor: pointer;
                            margin-top: 15px;
                            width: 100%;
                        `;

                        events.add(saveBtn, 'click', () => {
                            const newDomainDisplay = domainDisplayCheckbox.checked;
                            GM_setValue('domainDisplayMode', newDomainDisplay);

                            // ã‚¿ãƒ–è¡¨ç¤ºã‚’æ›´æ–°
                            if (state.window) {
                                updateTabs(state.window);
                            }

                            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                            saveBtn.animate([
                                { transform: 'scale(1)' },
                                { transform: 'scale(1.05)' },
                                { transform: 'scale(1)' }
                            ], {
                                duration: 200,
                                easing: 'ease-in-out'
                            });

                            logMessage(`ãƒ‰ãƒ¡ã‚¤ãƒ³åè¡¨ç¤ºè¨­å®šã‚’ä¿å­˜: ${newDomainDisplay ? 'æ¨ªæ–‡å­—' : 'ãƒ•ã‚¡ãƒ“ã‚³ãƒ³'}`);
                            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                        });

                        contentDiv.append(description, settingsDiv, saveBtn);
                    }
                });
            };

            const createExcludeManageWindow = (windowObj) => {
                return createPopupWindow({
                    title: 'é™¤å¤–ã‚¿ã‚°ç®¡ç†',
                    width: 400,
                    height: 500,
                    className: 'excludeManagePopup',
                    content: (contentDiv) => {

                // é™¤å¤–ã‚¿ã‚°ä¸€è¦§
                const excludeList = document.createElement('div');
                excludeList.id = 'excludeManageList';
                excludeList.style.cssText = 'margin-bottom: 15px;';

                const updateExcludeManageList = () => {
                    excludeList.innerHTML = '';
                    const excludeTags = GM_getValue(`excludeTags-${windowObj.activeTab}`, []);

                    if (excludeTags.length === 0) {
                        const noExcludeMsg = document.createElement('div');
                        noExcludeMsg.textContent = 'é™¤å¤–ã•ã‚ŒãŸã‚¿ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“';
                        noExcludeMsg.style.cssText = 'text-align: center; color: #95a5a6; padding: 20px;';
                        excludeList.appendChild(noExcludeMsg);
                        return;
                    }

                    excludeTags.forEach((rule, index) => {
                        const excludeDiv = document.createElement('div');
                        excludeDiv.style.cssText = `
                            background: #0a1f2e;
                            padding: 10px;
                            border-radius: 5px;
                            border: 1px solid #104437;
                            margin-bottom: 8px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        `;

                        const excludeInfo = document.createElement('div');
                        excludeInfo.style.cssText = 'flex-grow: 1;';

                        const excludePattern = document.createElement('div');
                        excludePattern.textContent = rule.pattern;
                        excludePattern.style.cssText = 'font-weight: bold; color: #e74c3c; margin-bottom: 2px;';

                        const excludeType = document.createElement('div');
                        excludeType.textContent = rule.type === 'regex' ? 'æ­£è¦è¡¨ç¾' : 'å®Œå…¨ä¸€è‡´';
                        excludeType.style.cssText = 'font-size: 10px; color: #95a5a6;';

                        excludeInfo.appendChild(excludePattern);
                        excludeInfo.appendChild(excludeType);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'å‰Šé™¤';
                        deleteBtn.style.cssText = 'background: #e74c3c; border: none; color: white; padding: 3px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;';

                        excludeDiv.appendChild(excludeInfo);
                        excludeDiv.appendChild(deleteBtn);
                        excludeList.appendChild(excludeDiv);

                        // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
                        events.add(deleteBtn, 'click', () => {
                            if (confirm(`é™¤å¤–ã‚¿ã‚°ã€Œ${rule.pattern}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                                excludeTags.splice(index, 1);
                                GM_setValue(`excludeTags-${windowObj.activeTab}`, excludeTags);
                                updateExcludeManageList();

                                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                                excludeDiv.animate([
                                    { transform: 'scale(1)', opacity: 1 },
                                    { transform: 'scale(0.8)', opacity: 0 }
                                ], {
                                    duration: 300,
                                    easing: 'ease-in-out'
                                }).onfinish = () => excludeDiv.remove();

                                logMessage(`é™¤å¤–ã‚¿ã‚°ã€Œ${rule.pattern}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                            }
                        });
                    });
                };

                updateExcludeManageList();
                content.appendChild(excludeList);

                // å¾©å…ƒæ©Ÿèƒ½
                const restoreSection = document.createElement('div');
                restoreSection.style.cssText = 'border-top: 1px solid #104437; padding-top: 15px;';

                const restoreTitle = document.createElement('h4');
                restoreTitle.textContent = 'é™¤å¤–ã‚¿ã‚°ã‚’å¾©å…ƒ';
                restoreTitle.style.cssText = 'margin: 0 0 10px 0; color: #16a085; font-size: 12px;';

                const restoreBtn = document.createElement('button');
                restoreBtn.textContent = 'ã™ã¹ã¦ã®é™¤å¤–ã‚¿ã‚°ã‚’å¾©å…ƒ';
                restoreBtn.style.cssText = `
                    background: #16a085;
                    color: white;
                    border: none;
                    padding: 8px 12px;
                    border-radius: 5px;
                    font-size: 11px;
                    cursor: pointer;
                    width: 100%;
                `;

                events.add(restoreBtn, 'click', () => {
                    if (confirm('ã™ã¹ã¦ã®é™¤å¤–ã‚¿ã‚°ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\né™¤å¤–ã•ã‚ŒãŸã‚¿ã‚°ãŒã‚¢ã‚¤ãƒ†ãƒ ã«å†ã³è¿½åŠ ã•ã‚Œã¾ã™ã€‚')) {
                        const excludeTags = GM_getValue(`excludeTags-${windowObj.activeTab}`, []);
                        const allItems = GM_getValue('savedItems', []);
                        let restoredCount = 0;

                        allItems.forEach(item => {
                            if (item.tab === windowObj.activeTab) {
                                excludeTags.forEach(rule => {
                                    if (rule.type === 'regex') {
                                        try {
                                            const regex = new RegExp(rule.pattern);
                                            if (regex.test(item.title) && !item.tags.includes(rule.pattern)) {
                                                if (!item.tags) item.tags = [];
                                                item.tags.push(rule.pattern);
                                                restoredCount++;
                                            }
                                        } catch (e) {
                                            // æ­£è¦è¡¨ç¾ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                                        }
                                    } else {
                                        if (item.title.includes(rule.pattern) && !item.tags.includes(rule.pattern)) {
                                            if (!item.tags) item.tags = [];
                                            item.tags.push(rule.pattern);
                                            restoredCount++;
                                        }
                                    }
                                });
                            }
                        });

                        GM_setValue('savedItems', allItems);
                        displaySavedItems(windowObj);
                        updateExcludeManageList();

                        logMessage(`${restoredCount}å€‹ã®ã‚¿ã‚°ã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
                    }
                });

                        restoreSection.appendChild(restoreTitle);
                        restoreSection.appendChild(restoreBtn);
                        contentDiv.appendChild(restoreSection);

                        logMessage('é™¤å¤–ã‚¿ã‚°ç®¡ç†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãã¾ã—ãŸ');
                    }
                });
            };

            const showDataSizeInfo = (windowObj) => {
                const allItems = GM_getValue('savedItems', []);
                const currentTabItems = allItems.filter(item => item.tab === windowObj.activeTab);

                let totalSize = 0;
                const itemSizes = currentTabItems.map(item => {
                    const itemData = JSON.stringify(item);
                    const size = new Blob([itemData]).size;
                    totalSize += size;
                    return {
                        title: item.title,
                        size: size,
                        imageSize: item.image ? new Blob([item.image]).size : 0
                    };
                });

                const totalSizeKB = (totalSize / 1024).toFixed(2);
                const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);

                let message = `ğŸ“Š ãƒ‡ãƒ¼ã‚¿é‡æƒ…å ± (${windowObj.activeTab})\n\n`;
                message += `ç·ã‚¢ã‚¤ãƒ†ãƒ æ•°: ${currentTabItems.length}ä»¶\n`;
                message += `ç·ãƒ‡ãƒ¼ã‚¿é‡: ${totalSizeKB} KB (${totalSizeMB} MB)\n\n`;

                if (itemSizes.length > 0) {
                    message += `ğŸ“‹ å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ è©³ç´°:\n`;
                    itemSizes.forEach((item, index) => {
                        const itemSizeKB = (item.size / 1024).toFixed(2);
                        const imageSizeKB = (item.imageSize / 1024).toFixed(2);
                        message += `${index + 1}. ${item.title.substring(0, 30)}...\n`;
                        message += `   ç·ã‚µã‚¤ã‚º: ${itemSizeKB} KB (ç”»åƒ: ${imageSizeKB} KB)\n`;
                    });
                }

                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã®æ¨å®š
                const estimatedLimit = 5 * 1024 * 1024; // 5MBæ¨å®š
                const remainingSpace = estimatedLimit - totalSize;
                const remainingMB = (remainingSpace / (1024 * 1024)).toFixed(2);

                message += `\nğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ³:\n`;
                message += `ä½¿ç”¨é‡: ${totalSizeMB} MB\n`;
                message += `æ¨å®šæ®‹ã‚Šå®¹é‡: ${remainingMB} MB\n`;
                message += `ä½¿ç”¨ç‡: ${((totalSize / estimatedLimit) * 100).toFixed(1)}%`;

                alert(message);
                logMessage(`ãƒ‡ãƒ¼ã‚¿é‡æƒ…å ±è¡¨ç¤º: ${currentTabItems.length}ä»¶, ${totalSizeKB}KB`);
            };

            const init = () => {
                // å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã§ã®å®Ÿè¡Œã‚’ãƒã‚§ãƒƒã‚¯
                const isInVideoFrame = () => {
                    try {
                        // iframeå†…ã‹ãƒã‚§ãƒƒã‚¯
                        if (window !== window.top) {
                            return true;
                        }

                        // å‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼å†…ã‹ãƒã‚§ãƒƒã‚¯
                        const videoSelectors = [
                            'video',
                            'iframe[src*="player"]',
                            'iframe[src*="video"]',
                            'iframe[src*="embed"]',
                            '.video-player',
                            '.player-container',
                            '[class*="player"]',
                            '[id*="player"]'
                        ];

                        const videoElements = document.querySelectorAll(videoSelectors.join(','));
                        for (const element of videoElements) {
                            if (element.contains(document.body) || element === document.body) {
                                return true;
                            }
                        }

                        // å‹•ç”»ã‚µã‚¤ãƒˆç‰¹æœ‰ã®URLãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
                        const videoSitePatterns = [
                            /youtube\.com\/embed\//,
                            /vimeo\.com\/embed\//,
                            /dailymotion\.com\/embed\//,
                            /player\./,
                            /embed\./
                        ];

                        return videoSitePatterns.some(pattern => pattern.test(window.location.href));
                    } catch (e) {
                        return false;
                    }
                };

                // å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã®å ´åˆã¯åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (isInVideoFrame()) {
                    logMessage("å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã‚’æ¤œå‡ºã€ãƒ„ãƒ¼ãƒ«ãƒãƒ¼åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—");
                    return;
                }

                // åˆæœŸåŒ–å‰ã®çŠ¶æ…‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                state.validateState();

                // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®åˆæœŸåŒ–
                const toolbarElements = safeExecute(() => Toolbar.init(), null, () => {
                    logMessage("ãƒ„ãƒ¼ãƒ«ãƒãƒ¼åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ", 'error');
                    return null;
                });

                if (!toolbarElements) {
                    logMessage("ãƒ„ãƒ¼ãƒ«ãƒãƒ¼åˆæœŸåŒ–å¤±æ•—ã€ä¸­æ­¢", 'error');
                    return;
                }

                // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ä½ç½®ã®è¨­å®š
                let toolbarLeft, toolbarTop;
                safeExecute(() => {
                    toolbarLeft = Math.max(0, Math.min(window.innerWidth - 80, parseFloat(GM_getValue('toolbarPosition', { left: window.innerWidth - 80 }).left) || 0));
                    toolbarTop = Math.max(0, Math.min(window.innerHeight - 100, parseFloat(GM_getValue('toolbarPosition', { top: 50 }).top) || 50));
                    toolbarElements.toolbar.style.left = `${toolbarLeft}px`;
                    toolbarElements.toolbar.style.top = `${toolbarTop}px`;
                    toolbarElements.toolbar.style.right = 'auto';
                    logMessage("ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ä½ç½®è¨­å®šå®Œäº†");
                });

                // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ¤œçŸ¥
                events.add(document, 'fullscreenchange', () => {
                    safeExecute(() => {
                        if (document.fullscreenElement) {
                            toolbarElements.toolbar.style.display = 'none';
                            logMessage("ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ¤œçŸ¥: ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º");
                        } else {
                            toolbarElements.toolbar.style.display = 'block';
                            logMessage("ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è§£é™¤: ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’è¡¨ç¤º");
                        }
                    });
                });

                // ä¿å­˜ã•ã‚ŒãŸã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å¾©å…ƒ
                safeExecute(() => {
                    const savedWindowId = GM_getValue('savedWindow', null);
                    if (savedWindowId) {
                        const savedState = GM_getValue(`windowState-${savedWindowId}`, { position: { left: '21px', top: '23px' }, size: { width: '950px', height: '550px' } });
                        const windowObj = Window.create(savedWindowId, savedState);
                        if (windowObj) state.setWindow(windowObj);
                    }
                });

                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå‡¦ç†ã®æœ€é©åŒ–
                let resizeTimeout;
                window.onresize = () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        safeExecute(() => {
                            // ç¾åœ¨ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ä½ç½®ã‚’å–å¾—
                            const currentLeft = toolbarElements.toolbar.style.left;
                            const currentTop = toolbarElements.toolbar.style.top;
                            const toolbarPos = GM_getValue('toolbarPosition', { left: currentLeft, top: currentTop });

                            toolbarElements.toolbar.style.left = `${Math.max(0, Math.min(parseFloat(toolbarPos.left), window.innerWidth - 80))}px`;
                            toolbarElements.toolbar.style.top = `${Math.max(0, Math.min(parseFloat(toolbarPos.top), window.innerHeight - 100))}px`;

                            if (state.window && state.window.isMaximized) {
                                const maximizeBtn = state.window.el.querySelector('.maximizeButton');
                                if (maximizeBtn) maximizeBtn.click();
                            }
                        });
                    }, 100); // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
                };

                // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                window.addEventListener('beforeunload', () => {
                    safeExecute(() => {
                        state.resetTemporaryState();
                        Memoization.clearCache();
                        logMessage("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†");
                    });
                });

                logMessage("åˆæœŸåŒ–å®Œäº†");

                // é€šçŸ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®CSSè¿½åŠ 
                const notificationCSS = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; transform: scale(0.9); }
                        to { opacity: 1; transform: scale(1); }
                    }
                    @keyframes pulse {
                        0% { transform: scale(1); }
                        50% { transform: scale(1.05); }
                        100% { transform: scale(1); }
                    }
                    .ash8-notification {
                        animation: slideIn 0.3s ease-out;
                    }
                    .savedItem {
                        transition: all 0.2s ease;
                    }
                    .savedItem:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    }
                    .tab-vertical {
                        transition: all 0.2s ease;
                    }
                    .tab-vertical:hover {
                        transform: scale(1.05);
                    }
                    .controlBar button {
                        transition: all 0.2s ease;
                    }
                    .controlBar button:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                `;

                GM_addStyle(notificationCSS + `#toolbar{position:fixed;top:5vh;right:2vw;width:35px!important;min-width:35px!important;max-width:35px!important;background-color:#082849;border:2px solid #104437;padding:5px;z-index:9999;box-shadow:0 4px 8px rgba(0,0,0,0.2);font-family:sans-serif;color:#fff;user-select:none;overflow:hidden;}#toolbarHandle{height:20px;background-color:#104437;cursor:move;margin-bottom:5px;border-radius:3px;}#toolbarBottomHandle{height:20px;background-color:#104437;cursor:move;margin-top:5px;border-radius:3px;}#toolbar button,#toolbar select,#toolbar input[type="checkbox"]{display:block;width:100%!important;min-width:25px!important;margin:5px 0;padding:5px;font-size:12px;background-color:#104437;color:#fff;border:none;cursor:pointer;border-radius:5px;}#toolbar textarea{display:block;width:100%!important;min-width:25px!important;margin:5px 0;padding:5px;font-size:12px;background-color:#104437;color:#fff;border:none;border-radius:5px;height:25px!important;min-height:25px!important;max-height:25px!important;resize:none!important;overflow:hidden!important;line-height:15px!important;box-sizing:border-box!important;}#selectImageButton.active,#selectVideoThumbnailButton.active,#extractTagsButton.active{background-color:#3c9d6f;}#toolbar button:hover{background-color:#16a085;}#compressionButtons button.selected{background-color:#e67e22;}#pasteImageArea{height:25px!important;min-height:25px!important;max-height:25px!important;border:1px solid #16a085;resize:none!important;overflow:hidden!important;line-height:15px!important;box-sizing:border-box!important;}#compressedImage{max-width:100%;margin:5px 0;}#compressionRate{font-size:12px;margin:5px 0;}#debugOutput{display:none;}.window{position:fixed;width:950px;height:550px;background-color:#082849;border:2px solid #104437;padding:5px;z-index:10000;box-shadow:0 4px 8px rgba(0,0,0,0.2);font-family:sans-serif;color:#fff;user-select:none;overflow:hidden;}.toolbarHandle{height:20px;background-color:#104437;cursor:move;margin-bottom:5px;}.menuBar{display:flex;justify-content:space-between;padding:2px;background-color:#104437;height:20px;align-items:center;}.window .menuBar h3{margin:0;flex-grow:1;text-align:center;font-size:14px;}.left-buttons,.right-buttons{display:flex;gap:2px;}.window .menuBar button{padding:1px 3px;background-color:#082849;color:#fff;border:none;cursor:pointer;border-radius:3px;font-size:12px;}.minimizeButton,.maximizeButton{background-color:#104437!important;width:32px;height:32px;font-size:32px;padding:0;line-height:32px;}.window .menuBar button:hover{background-color:#16a085;}.debug-info{font-size:12px;white-space:nowrap;margin-left:5px;}.tabSidebar{position:absolute;left:0;top:110px;bottom:5px;width:110px!important;display:flex;flex-direction:column;gap:5px;padding:5px;overflow-y:auto;}.tab-vertical{width:100%;padding:5px;border:none;color:#fff;cursor:pointer;text-align:center;background-color:#104437;border-radius:5px;}.tab-vertical.active{background:#16a085;box-shadow:0 0 5px 4px rgba(255,255,255,0.7);transform:scale(1.2);z-index:1;}.tab-vertical img{width:24px;height:24px;}.tab-vertical span{font-family:sans-serif;font-size:16px;font-weight:bold;}.domain-text{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:bold;}.tab-favicon{width:16px;height:16px;margin-left:4px;vertical-align:middle;}.controlBar{padding:5px;display:flex;gap:5px;flex-wrap:wrap;justify-content:flex-start;margin-left:110px;margin-top:25px;}.controlBar button,.controlBar select{padding:5px;background:#104437;color:#fff;border:none;font-size:12px;}.controlBar button:hover{background-color:#16a085;}.savedItems{margin-left:110px;margin-top:0;max-height:calc(100% - 80px);overflow-y:auto;padding:5px;display:flex;flex-wrap:wrap;gap:10px;}.savedItems.column{flex-direction:column;flex-wrap:nowrap;}.savedItem{padding:5px;background:#104437;border-radius:5px;position:relative;cursor:pointer;text-decoration:none;color:#fff;}.savedItem.column{flex:1 0 100%;}.savedItem.size-large{flex:0 0 400px;}.savedItem.size-standard{flex:0 0 300px;}.savedItem.size-medium{flex:0 0 280px;}.savedItem.size-small{flex:0 0 260px;}.savedItem.size-half{flex:0 0 250px;}.savedItem.size-third{flex:0 0 220px;}.savedItem.size-quarter{flex:0 0 200px;}.savedItem.size-mini{flex:0 0 180px;}.savedItem.selected{border:2px solid #16a085;}.savedItem img{width:100%;height:auto;object-fit:contain;}.savedItem p{margin:2px 0;font-size:12px;}.savedItem.image-only p{display:none;}.savedItem.image-title p:not(:nth-child(2)){display:none;}.savedItem.image-title p:nth-child(2){display:block;font-size:14px!important;font-weight:bold!important;}.savedItem a{color:#fff;}.selectItem{position:absolute;top:5px;left:5px;width:20px;height:20px;z-index:1;display:none;}.editing .selectItem{display:block;}.subMenu{position:absolute;background-color:#082849;border:1px solid #104437;box-shadow:0 2px 5px rgba(0,0,0,0.2);min-width:100px;z-index:10001;margin-top:30px;}.subMenuItem{padding:2px 5px;cursor:pointer;background-color:#082849!important;white-space:nowrap;font-size:14px;color:#fff;}.subMenuItem:hover{background-color:#16a085!important;color:#fff!important;}#logWindow{position:fixed;width:200px;height:150px;background:#082849;border:2px solid #104437;padding:5px;z-index:10002;box-shadow:0 4px 8px rgba(0,0,0,0.2);font-family:sans-serif;color:#fff;user-select:none;overflow:hidden;}#logWindow .menuBar{display:flex;justify-content:space-between;padding:2px;background-color:#104437;cursor:move;height:20px;align-items:center;}#logWindow .menuBar h3{margin:0;flex-grow:1;text-align:center;font-size:12px;}#logWindow .menuBar button{padding:1px 3px;background-color:#082849;color:#fff;border:none;cursor:pointer;border-radius:3px;font-size:12px;}#logWindow .menuBar button:hover{background-color:#16a085;}#logContent{max-height:calc(100% - 25px);overflow-y:auto;background:#333;padding:5px;font-size:10px;color:#fff;}.tabMenuPopup,.moveTabPopup,.tagEditPopup{position:fixed;background-color:#082849;border:2px solid #104437;padding:5px;z-index:10001;box-shadow:0 4px 8px rgba(0,0,0,0.2);font-family:sans-serif;color:#fff;width:300px;height:400px;left:50%;top:50%;transform:translate(-50%,-50%);overflow-y:auto;}.tabMenuPopup .menuBar,.moveTabPopup .menuBar,.tagEditPopup .menuBar{display:flex;justify-content:space-between;padding:2px;background-color:#104437;height:20px;align-items:center;}.tabMenuPopup .menuBar h3,.moveTabPopup .menuBar h3,.tagEditPopup .menuBar h3{margin:0;flex-grow:1;text-align:center;font-size:14px;}.tabMenuPopup .menuBar button,.moveTabPopup .menuBar button,.tagEditPopup .menuBar button{padding:1px 3px;background-color:#082849;color:#fff;border:none;cursor:pointer;border-radius:3px;font-size:12px;}.tabMenuPopup .menuBar button:hover,.moveTabPopup .menuBar button:hover,.tagEditPopup .menuBar button:hover{background-color:#16a085;}.moveTabContent,.tagEditContent{overflow-y:auto;padding:5px;}.tagFilterArea{transition:all 0.3s ease;}.tagFilterBtn:hover{transform:scale(1.05)!important;box-shadow:0 4px 8px rgba(0,0,0,0.3)!important;}.resize-handle{position:absolute;background:transparent;}.resize-top{top:-5px;left:0;width:100%;height:10px;cursor:ns-resize;}.resize-bottom{bottom:-5px;left:0;width:100%;height:10px;cursor:ns-resize;}.resize-left{left:-5px;top:0;width:10px;height:100%;cursor:ew-resize;}.resize-right{right:-5px;top:0;width:10px;height:100%;cursor:ew-resize;}`);
            };

            init();
        })();
